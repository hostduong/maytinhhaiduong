{{ define "quan_tri_thanh_vien" }}
    {{ template "header_admin" . }}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .input-premium { width: 100%; box-sizing: border-box; background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 0.9rem; padding: 0.5rem 0.75rem; transition: 0.2s; outline: none; }
        .input-premium:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); background-color: #fff; }
        .input-premium:disabled, .input-premium[readonly] { cursor: not-allowed; opacity: 0.7; }
        label.form-lbl { font-size: 0.75rem; font-weight: bold; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem; display: block; }
    </style>

    <div class="container mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-2xl font-bold text-slate-800">üë• Qu·∫£n L√Ω Th√†nh Vi√™n</h1>
            <div class="flex gap-2">
                <button onclick="openMessageModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow-md flex items-center gap-2 transition text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    G·ª≠i Th√¥ng B√°o (<span id="countSelected">0</span>)
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3 text-center w-10">
                                <input type="checkbox" id="checkAll" onchange="toggleAllCheckboxes()" class="w-4 h-4 text-blue-600 rounded border-gray-300">
                            </th>
                            <th class="px-6 py-3 font-bold">Th√†nh Vi√™n</th>
                            <th class="px-6 py-3 font-bold">Li√™n h·ªá</th>
                            <th class="px-6 py-3 font-bold">Vai Tr√≤</th>
                            <th class="px-6 py-3 font-bold text-center">Tr·∫°ng Th√°i</th>
                            <th class="px-6 py-3 font-bold text-center">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .DanhSach }}
                        <tr class="bg-white border-b border-slate-100 hover:bg-slate-50 transition">
                            <td class="px-4 py-4 text-center">
                                <input type="checkbox" value="{{ .MaKhachHang }}" class="chk-member w-4 h-4 text-blue-600 rounded border-gray-300" onchange="updateCount()">
                            </td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-slate-800 text-base">{{ .TenKhachHang }}</div>
                                <div class="text-xs text-slate-400 font-mono mt-1">ID: {{ .MaKhachHang }}</div>
                                <div class="text-xs text-blue-500 font-medium">User: {{ .TenDangNhap }}</div>
                            </td>
                            <td class="px-6 py-4 text-xs">
                                <div>üìû {{ if .DienThoai }}{{ .DienThoai }}{{ else }}---{{ end }}</div>
                                <div>üìß {{ if .Email }}{{ .Email }}{{ else }}---{{ end }}</div>
                            </td>
                            <td class="px-6 py-4">
                                {{ if eq .VaiTroQuyenHan "admin_root" }}<span class="bg-red-100 text-red-700 text-xs font-bold px-2.5 py-1 rounded-md border border-red-200">SUPER ADMIN</span>
                                {{ else if eq .VaiTroQuyenHan "admin" }}<span class="bg-blue-100 text-blue-700 text-xs font-bold px-2.5 py-1 rounded-md border border-blue-200">ADMIN</span>
                                {{ else if eq .VaiTroQuyenHan "sale" }}<span class="bg-amber-100 text-amber-700 text-xs font-bold px-2.5 py-1 rounded-md border border-amber-200">SALE</span>
                                {{ else if eq .VaiTroQuyenHan "kho" }}<span class="bg-purple-100 text-purple-700 text-xs font-bold px-2.5 py-1 rounded-md border border-purple-200">KHO</span>
                                {{ else }}<span class="bg-slate-100 text-slate-600 text-xs font-bold px-2.5 py-1 rounded-md border border-slate-200">CUSTOMER</span>{{ end }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                {{ if eq .TrangThai 1 }}<span class="w-3 h-3 bg-emerald-500 rounded-full inline-block shadow-sm" title="Ho·∫°t ƒë·ªông"></span>
                                {{ else }}<span class="w-3 h-3 bg-red-500 rounded-full inline-block shadow-sm" title="B·ªã kh√≥a"></span>{{ end }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="editMember('{{ .MaKhachHang }}')" class="bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition border border-blue-200 hover:border-transparent">Qu·∫£n l√Ω</button>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="data_members" class="hidden">
        {{ range .DanhSach }}
        <div class="m-data" 
            data-id="{{ .MaKhachHang }}" data-name="{{ .TenKhachHang }}" data-role="{{ .VaiTroQuyenHan }}" 
            data-phone="{{ .DienThoai }}" data-dob="{{ .NgaySinh }}" data-gender="{{ .GioiTinh }}" 
            data-address="{{ .DiaChi }}" data-tax="{{ .MaSoThue }}" data-status="{{ .TrangThai }}"
            data-zalo="{{ .MangXaHoi.Zalo }}" data-fb="{{ .MangXaHoi.Facebook }}" data-tiktok="{{ .MangXaHoi.Tiktok }}"
            data-note="{{ .GhiChu }}">
        </div>
        {{ end }}
    </div>

    <div id="modalEdit" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl transform transition-all flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl shrink-0">
                <h3 class="text-xl font-bold text-slate-800" id="modalTitle">S·ª≠a Th√¥ng Tin & Ph√¢n Quy·ªÅn</h3>
                <button onclick="closeModal('modalEdit')" class="text-slate-400 hover:text-red-500 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto bg-white">
                <form id="formEdit" class="space-y-6">
                    <input type="hidden" name="ma_khach_hang" id="f_ma">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h4 class="font-bold text-blue-600 border-b pb-2">H·ªì s∆° c√° nh√¢n</h4>
                            <div><label class="form-lbl">H·ªç v√† t√™n <span class="text-red-500">*</span></label><input type="text" name="ten_khach_hang" id="f_ten" class="input-premium font-bold" required></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="form-lbl">ƒêi·ªán tho·∫°i</label><input type="text" name="dien_thoai" id="f_sdt" class="input-premium"></div>
                                <div><label class="form-lbl">Ng√†y sinh</label><input type="date" name="ngay_sinh" id="f_dob" class="input-premium"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-lbl">Gi·ªõi t√≠nh</label>
                                    <select name="gioi_tinh" id="f_gender" class="input-premium bg-white">
                                        <option value="-1">Kh√°c</option><option value="1">Nam</option><option value="0">N·ªØ</option>
                                    </select>
                                </div>
                                <div><label class="form-lbl">M√£ s·ªë thu·∫ø</label><input type="text" name="ma_so_thue" id="f_tax" class="input-premium"></div>
                            </div>
                            <div><label class="form-lbl">ƒê·ªãa ch·ªâ</label><input type="text" name="dia_chi" id="f_address" class="input-premium"></div>
                            
                            <h4 class="font-bold text-blue-600 border-b pb-2 pt-2">M·∫°ng x√£ h·ªôi</h4>
                            <div class="grid grid-cols-3 gap-2">
                                <div><label class="form-lbl">Zalo</label><input type="text" name="zalo" id="f_zalo" class="input-premium text-xs" placeholder="SƒêT..."></div>
                                <div><label class="form-lbl">Facebook</label><input type="text" name="facebook" id="f_fb" class="input-premium text-xs" placeholder="Link..."></div>
                                <div><label class="form-lbl">Tiktok</label><input type="text" name="tiktok" id="f_tiktok" class="input-premium text-xs" placeholder="Link..."></div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h4 class="font-bold text-purple-600 border-b pb-2">H·ªá th·ªëng & Quy·ªÅn h·∫°n</h4>
                            
                            <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                <label class="form-lbl text-purple-800">Vai tr√≤ (Role) <span class="text-red-500">*</span></label>
                                <select name="vai_tro" id="f_role" class="input-premium bg-white border-purple-200 text-purple-900 font-bold" required>
                                    <option value="customer">Kh√°ch h√†ng (Customer)</option>
                                    <option value="sale">Nh√¢n vi√™n kinh doanh (Sale)</option>
                                    <option value="kho">Th·ªß kho (Stock)</option>
                                    <option value="admin">Qu·∫£n tr·ªã vi√™n (Admin)</option>
                                    <option value="admin_root" disabled>SUPER ADMIN (H·ªá th·ªëng)</option>
                                </select>
                                <p class="text-[10px] text-purple-600 mt-1">L∆∞u √Ω: Kh√¥ng th·ªÉ t∆∞·ªõc quy·ªÅn c·ªßa Super Admin.</p>
                            </div>

                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <label class="form-lbl">Tr·∫°ng th√°i t√†i kho·∫£n</label>
                                <select name="trang_thai" id="f_status" class="input-premium bg-white font-bold">
                                    <option value="1" class="text-emerald-600">‚úÖ Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng</option>
                                    <option value="0" class="text-red-600">üö´ KH√ìA T√ÄI KHO·∫¢N</option>
                                </select>
                            </div>

                            <div>
                                <label class="form-lbl">Reset M·∫≠t kh·∫©u (B·ªè tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</label>
                                <input type="text" name="mat_khau_moi" class="input-premium font-mono" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi...">
                            </div>

                            <div>
                                <label class="form-lbl">Ghi ch√∫ n·ªôi b·ªô</label>
                                <textarea name="ghi_chu" id="f_note" rows="3" class="input-premium" placeholder="Ghi ch√∫ v·ªÅ kh√°ch/nh√¢n vi√™n n√†y..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="px-6 py-4 border-t bg-slate-50 rounded-b-2xl flex justify-end gap-3 shrink-0">
                <button onclick="closeModal('modalEdit')" class="px-5 py-2 text-slate-600 hover:bg-slate-200 rounded-lg font-bold transition">H·ªßy</button>
                <button onclick="saveMember()" id="btnSaveMem" class="px-8 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md transition transform active:scale-95">L∆∞u Thay ƒê·ªïi</button>
            </div>
        </div>
    </div>

    <div id="modalMsg" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-blue-600 rounded-t-2xl">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">üì¢ G·ª≠i Th√¥ng B√°o H·ªá Th·ªëng</h3>
                <button onclick="closeModal('modalMsg')" class="text-white hover:text-red-200 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 text-blue-700 p-3 rounded-lg text-sm font-medium border border-blue-100">
                    ƒêang chu·∫©n b·ªã g·ª≠i tin nh·∫Øn ƒë·∫øn <span id="lblMsgCount" class="font-bold text-red-600 text-lg">0</span> ng∆∞·ªùi.
                </div>
                <div>
                    <label class="form-lbl">Ti√™u ƒë·ªÅ tin nh·∫Øn <span class="text-red-500">*</span></label>
                    <input type="text" id="msgTitle" class="input-premium font-bold text-slate-800" placeholder="VD: Th√¥ng b√°o c·∫≠p nh·∫≠t h·ªá th·ªëng..." required>
                </div>
                <div>
                    <label class="form-lbl">N·ªôi dung chi ti·∫øt <span class="text-red-500">*</span></label>
                    <textarea id="msgContent" rows="6" class="input-premium" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o (h·ªó tr·ª£ vƒÉn b·∫£n thu·∫ßn)..." required></textarea>
                </div>
            </div>

            <div class="px-6 py-4 border-t bg-slate-50 rounded-b-2xl flex justify-end gap-3">
                <button onclick="closeModal('modalMsg')" class="px-5 py-2 text-slate-600 hover:bg-slate-200 rounded-lg font-bold transition">H·ªßy</button>
                <button onclick="sendMessages()" id="btnSendMsg" class="px-8 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md transition transform active:scale-95 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    Ph√°t s√≥ng
                </button>
            </div>
        </div>
    </div>

    <script>
        // Data Parser
        const mapData = {};
        document.querySelectorAll('.m-data').forEach(el => {
            let id = el.getAttribute('data-id');
            mapData[id] = {
                ten: el.getAttribute('data-name'), role: el.getAttribute('data-role'),
                sdt: el.getAttribute('data-phone'), dob: el.getAttribute('data-dob'), gender: el.getAttribute('data-gender'),
                address: el.getAttribute('data-address'), tax: el.getAttribute('data-tax'), status: el.getAttribute('data-status'),
                zalo: el.getAttribute('data-zalo'), fb: el.getAttribute('data-fb'), tiktok: el.getAttribute('data-tiktok'), note: el.getAttribute('data-note')
            };
        });

        // UI Toggles
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        // EDIT LOGIC
        function editMember(ma) {
            let data = mapData[ma]; if(!data) return;
            document.getElementById('formEdit').reset();
            
            document.getElementById('f_ma').value = ma;
            document.getElementById('f_ten').value = data.ten;
            document.getElementById('f_sdt').value = data.sdt;
            document.getElementById('f_dob').value = data.dob;
            document.getElementById('f_gender').value = data.gender;
            document.getElementById('f_tax').value = data.tax;
            document.getElementById('f_address').value = data.address;
            document.getElementById('f_zalo').value = data.zalo;
            document.getElementById('f_fb').value = data.fb;
            document.getElementById('f_tiktok').value = data.tiktok;
            document.getElementById('f_note').value = data.note;
            document.getElementById('f_status').value = data.status;

            let roleSelect = document.getElementById('f_role');
            roleSelect.value = data.role;
            if(data.role === "admin_root") {
                roleSelect.disabled = true; // Kh√≥a dropdown n·∫øu l√† Super Admin
            } else {
                roleSelect.disabled = false;
            }

            document.getElementById('modalEdit').classList.remove('hidden');
        }

        async function saveMember() {
            const btn = document.getElementById('btnSaveMem'); const old = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = 'ƒêang l∆∞u...';
            
            const fd = new FormData(document.getElementById('formEdit'));
            // B·ªï sung role b·ªã kh√≥a
            if(document.getElementById('f_role').disabled) fd.append('vai_tro', 'admin_root');

            try {
                const res = await fetch('/admin/api/member/save', { method: 'POST', body: fd });
                const data = await res.json();
                if(data.status === 'ok') Swal.fire({icon: 'success', title: 'Th√†nh c√¥ng', text: data.msg, timer: 1500, showConfirmButton: false}).then(() => location.reload());
                else Swal.fire('L·ªói', data.msg, 'error');
            } catch(e) { Swal.fire('L·ªói m·∫°ng', 'K·∫øt n·ªëi th·∫•t b·∫°i', 'error'); } 
            finally { btn.disabled = false; btn.innerHTML = old; }
        }

        // MESSAGING LOGIC
        function getSelectedIDs() {
            let ids = [];
            document.querySelectorAll('.chk-member:checked').forEach(cb => ids.push(cb.value));
            return ids;
        }

        function toggleAllCheckboxes() {
            let isChecked = document.getElementById('checkAll').checked;
            document.querySelectorAll('.chk-member').forEach(cb => cb.checked = isChecked);
            updateCount();
        }

        function updateCount() {
            let count = document.querySelectorAll('.chk-member:checked').length;
            document.getElementById('countSelected').innerText = count;
            document.getElementById('lblMsgCount').innerText = count;
        }

        function openMessageModal() {
            let count = getSelectedIDs().length;
            if (count === 0) { Swal.fire('Oops!', 'Vui l√≤ng t√≠ch ch·ªçn √≠t nh·∫•t 1 ng∆∞·ªùi nh·∫≠n ·ªü b·∫£ng danh s√°ch.', 'warning'); return; }
            document.getElementById('msgTitle').value = ""; document.getElementById('msgContent').value = "";
            updateCount();
            document.getElementById('modalMsg').classList.remove('hidden');
        }

        async function sendMessages() {
            let title = document.getElementById('msgTitle').value.trim();
            let content = document.getElementById('msgContent').value.trim();
            let ids = getSelectedIDs();

            if (!title || !content) { Swal.fire('L·ªói', 'Ti√™u ƒë·ªÅ v√† n·ªôi dung kh√¥ng ƒë∆∞·ª£c tr·ªëng!', 'error'); return; }

            const btn = document.getElementById('btnSendMsg'); const old = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = 'ƒêang g·ª≠i...';

            const fd = new FormData();
            fd.append('tieu_de', title);
            fd.append('noi_dung', content);
            fd.append('danh_sach_id', JSON.stringify(ids));

            try {
                const res = await fetch('/admin/api/member/send-msg', { method: 'POST', body: fd });
                const data = await res.json();
                if(data.status === 'ok') {
                    Swal.fire({icon: 'success', title: 'Ho√†n t·∫•t', text: data.msg, timer: 2000, showConfirmButton: false});
                    closeModal('modalMsg');
                    document.querySelectorAll('.chk-member').forEach(cb => cb.checked = false);
                    document.getElementById('checkAll').checked = false;
                    updateCount();
                } else Swal.fire('L·ªói', data.msg, 'error');
            } catch(e) { Swal.fire('L·ªói m·∫°ng', 'K·∫øt n·ªëi th·∫•t b·∫°i', 'error'); } 
            finally { btn.disabled = false; btn.innerHTML = old; }
        }
    </script>
    {{ template "footer_admin" . }}
{{ end }}
