{{ define "master_cai_dat_cau_hinh" }}
    {{ template "header_master" . }}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        label { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #475569; margin-bottom: 0.5rem; display: block; }
        
        input.input-premium, textarea.input-premium, select.input-premium { 
            width: 100%; box-sizing: border-box; background-color: #f8fafc; border: 1px solid #cbd5e1; 
            border-radius: 0.75rem; font-size: 0.95rem; color: #1e293b; transition: all 0.2s; font-weight: 600; 
        }
        input.input-premium, select.input-premium { height: 44px; padding: 0 1rem; }
        textarea.input-premium { padding: 0.75rem 1rem; }
        
        input.input-premium:focus, textarea.input-premium:focus, select.input-premium:focus { 
            background-color: #ffffff; border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15); outline: none; 
        }
        
        input.input-premium:disabled, input.input-premium[readonly], select.input-premium:disabled {
            background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; border-style: dashed; border-color: #cbd5e1;
            opacity: 0.8;
        }

        .tab-btn { transition: all 0.3s ease; border-bottom-width: 3px; border-color: transparent; }
        .tab-btn.active-blue { border-color: #4f46e5; color: #4f46e5; background-color: #e0e7ff; }
        .tab-btn.active-purple { border-color: #9333ea; color: #9333ea; background-color: #faf5ff; }
        .tab-btn.active-emerald { border-color: #059669; color: #059669; background-color: #ecfdf5; }
        .tab-btn.active-orange { border-color: #ea580c; color: #ea580c; background-color: #fff7ed; }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* T√πy ch·ªânh Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
    </style>

    <div id="data_island" style="display:none;">
        <div id="data_dm">
            {{ range .ListDanhMuc }}
                {{ if ne .MaDanhMuc "" }}
                <div class="dm-item" data-ma="{{ .MaDanhMuc }}" data-ten="{{ urlquery .TenDanhMuc }}" data-me="{{ urlquery .DanhMucMe }}" data-vat="{{ .ThueVAT }}" data-loi="{{ .LoiNhuan }}" data-tt="{{ .TrangThai }}"></div>
                {{ end }}
            {{ end }}
        </div>
        <div id="data_th">
            {{ range .ListThuongHieu }}
                {{ if ne .MaThuongHieu "" }}
                <div class="th-item" data-ma="{{ .MaThuongHieu }}" data-ten="{{ urlquery .TenThuongHieu }}" data-logo="{{ urlquery .LogoUrl }}" data-mota="{{ urlquery .MoTa }}" data-tt="{{ .TrangThai }}"></div>
                {{ end }}
            {{ end }}
        </div>
        <div id="data_bln">
            {{ range .ListBLN }}
                <div class="bln-item" data-dong="{{ .DongTrongSheet }}" data-khung="{{ .KhungGiaNhap }}" data-loi="{{ .BienLoiNhuan }}" data-tt="{{ .TrangThai }}"></div>
            {{ end }}
        </div>
        <div id="data_ncc">
            {{ range .ListNCC }}
                {{ if ne .MaNhaCungCap "" }}
                <div class="ncc-item" data-ma="{{ .MaNhaCungCap }}" data-ten="{{ urlquery .TenNhaCungCap }}" data-sdt="{{ urlquery .DienThoai }}" data-email="{{ urlquery .Email }}" data-dc="{{ urlquery .DiaChi }}" data-mst="{{ urlquery .MaSoThue }}" data-lh="{{ urlquery .NguoiLienHe }}" data-nh="{{ urlquery .NganHang }}" data-tt="{{ .TrangThai }}" data-gc="{{ urlquery .GhiChu }}"></div>
                {{ end }}
            {{ end }}
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto p-4">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-black text-indigo-900 tracking-tight">‚öôÔ∏è C·∫•u H√¨nh H·ªá Th·ªëng</h1>
                <p class="text-slate-500 font-medium mt-1">Qu·∫£n l√Ω Master Data: Danh m·ª•c, Th∆∞∆°ng hi·ªáu, Nh√† cung c·∫•p & Khung gi√°</p>
            </div>
        </div>

        <div class="bg-white rounded-t-2xl border border-b-0 border-slate-200 flex overflow-hidden shadow-sm font-bold">
            <button onclick="switchTab('tabDM', 'active-blue')" id="btn-tabDM" class="tab-btn active-blue flex-1 py-4 text-[13px] text-slate-500 hover:bg-slate-50 uppercase tracking-wide">üìÅ Danh M·ª•c</button>
            <button onclick="switchTab('tabTH', 'active-purple')" id="btn-tabTH" class="tab-btn flex-1 py-4 text-[13px] text-slate-500 hover:bg-slate-50 uppercase tracking-wide border-l border-slate-200">‚≠ê Th∆∞∆°ng Hi·ªáu</button>
            <button onclick="switchTab('tabNCC', 'active-orange')" id="btn-tabNCC" class="tab-btn flex-1 py-4 text-[13px] text-slate-500 hover:bg-slate-50 uppercase tracking-wide border-l border-slate-200">üë§ Nh√† Cung C·∫•p</button>
            <button onclick="switchTab('tabBLN', 'active-emerald')" id="btn-tabBLN" class="tab-btn flex-1 py-4 text-[13px] text-slate-500 hover:bg-slate-50 uppercase tracking-wide border-l border-slate-200">üí∞ Khung ƒê·ªãnh Gi√°</button>
        </div>

        <div id="tabDM" class="tab-content active bg-white rounded-b-2xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex flex-wrap justify-between items-center bg-indigo-50/50 gap-3">
                <div class="flex items-center gap-3 w-full md:w-auto flex-1">
                    <div class="relative flex-1 md:w-80 max-w-md">
                        <input type="text" id="searchDM" onkeyup="filterTable('searchDM', 'tbodyDM')" placeholder="üîç T√¨m m√£ ho·∫∑c t√™n danh m·ª•c..." class="input-premium pl-10 h-[40px] border-indigo-200">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="syncSlot()" id="btnSync" class="bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-xl font-bold shadow-sm flex items-center gap-2 text-sm transition" title="ƒê·ªìng b·ªô t·ª± ƒë·ªông s·ªë ƒë·∫øm Slot">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> ƒê·ªìng b·ªô Slot
                    </button>  
                    <button type="button" onclick="openModalDM()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-xl font-bold shadow-md shadow-indigo-200 flex items-center gap-2 text-sm transition active:scale-95">
                        ‚úö Th√™m M·ªõi
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto max-h-[65vh] custom-scroll">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 sticky top-0 z-10 border-b border-slate-200 text-xs uppercase text-slate-500 font-black">
                        <tr>
                            <th class="px-6 py-4">M√£</th>
                            <th class="px-6 py-4">T√™n Danh M·ª•c</th>
                            <th class="px-6 py-4 text-center text-purple-600">Slot Sinh M√£</th>
                            <th class="px-6 py-4 text-center text-red-600">VAT (%)</th>
                            <th class="px-6 py-4 text-center text-emerald-600">L·ª£i Nhu·∫≠n (%)</th>
                            <th class="px-6 py-4 text-center text-blue-600">Tr·∫°ng th√°i</th>
                            <th class="px-6 py-4 text-center">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyDM" class="divide-y divide-slate-100">
                        {{ range .ListDanhMuc }}
                        {{ if ne .MaDanhMuc "" }}
                        <tr class="hover:bg-indigo-50/30 transition">
                            <td class="px-6 py-3 font-bold text-indigo-900 font-mono">{{ .MaDanhMuc }}</td>
                            <td class="px-6 py-3 font-bold text-[15px]">{{ .TenDanhMuc }} <span class="text-xs text-slate-400 font-normal block mt-0.5">{{ if .DanhMucMe }}Thu·ªôc: {{ .DanhMucMe }}{{ else }}C·∫•p Root{{ end }}</span></td>
                            <td class="px-6 py-3 text-center font-mono font-bold text-orange-600 bg-orange-50/50">{{ .Slot }}</td> 
                            <td class="px-6 py-3 text-center font-bold text-red-600">{{ .ThueVAT }}</td>
                            <td class="px-6 py-3 text-center font-bold text-emerald-600">{{ if gt .LoiNhuan 0.0 }}{{ .LoiNhuan }}{{ else }}<span class="text-[11px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-medium">Theo C·∫•u H√¨nh Gi√°</span>{{ end }}</td>
                            <td class="px-6 py-3 text-center">
                                {{ if eq .TrangThai 1 }}<span class="text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md text-xs border border-blue-100">Ho·∫°t ƒë·ªông</span>{{ else }}<span class="text-slate-500 font-bold bg-slate-100 px-2 py-1 rounded-md text-xs border border-slate-200">ƒê√£ T·∫Øt</span>{{ end }}
                            </td>
                            <td class="px-6 py-3 text-center">
                               <button type="button" onclick="editDM('{{ .MaDanhMuc }}')" class="text-indigo-600 hover:text-white border border-indigo-200 hover:bg-indigo-600 px-4 py-1.5 rounded-lg font-bold transition text-xs shadow-sm">S·ª≠a</button>
                            </td>
                        </tr>
                        {{ end }}
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tabTH" class="tab-content bg-white rounded-b-2xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex flex-wrap justify-between items-center bg-purple-50/50 gap-3">
                <div class="relative flex-1 md:w-80 max-w-md">
                    <input type="text" id="searchTH" onkeyup="filterTable('searchTH', 'tbodyTH')" placeholder="üîç T√¨m m√£ ho·∫∑c t√™n h√£ng..." class="input-premium pl-10 h-[40px] border-purple-200">
                </div>
                <button type="button" onclick="openModalTH()" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2 rounded-xl font-bold shadow-md shadow-purple-200 flex items-center gap-2 text-sm transition active:scale-95">
                    ‚úö Th√™m H√£ng
                </button>
            </div>
            <div class="overflow-x-auto max-h-[65vh] custom-scroll">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 sticky top-0 z-10 border-b border-slate-200 text-xs uppercase text-slate-500 font-black">
                        <tr>
                            <th class="px-6 py-4 text-center">Logo</th>
                            <th class="px-6 py-4">M√£ H√£ng</th>
                            <th class="px-6 py-4">T√™n H√£ng</th>
                            <th class="px-6 py-4 text-center text-blue-600">Tr·∫°ng th√°i</th>
                            <th class="px-6 py-4 text-center">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyTH" class="divide-y divide-slate-100">
                        {{ range .ListThuongHieu }}
                        {{ if ne .MaThuongHieu "" }}
                        <tr class="hover:bg-purple-50/30 transition">
                            <td class="px-6 py-3 text-center">
                                <div class="w-12 h-12 mx-auto rounded-lg border border-slate-200 bg-white p-1 flex items-center justify-center shadow-sm">
                                    <img src="{{ if .LogoUrl }}{{ .LogoUrl }}{{ else }}data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%3E%3Crect%20width%3D%2240%22%20height%3D%2240%22%20fill%3D%22%23f1f5f9%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-family%3D%22sans-serif%22%20font-weight%3D%22bold%22%20font-size%3D%2210%22%20fill%3D%22%2394a3b8%22%20text-anchor%3D%22middle%22%20dominant-baseline%3D%22middle%22%3ENo%20Img%3C%2Ftext%3E%3C%2Fsvg%3E{{ end }}" 
                                         onerror="this.onerror=null; this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%3E%3Crect%20width%3D%2240%22%20height%3D%2240%22%20fill%3D%22%23fee2e2%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-family%3D%22sans-serif%22%20font-weight%3D%22bold%22%20font-size%3D%2210%22%20fill%3D%22%23ef4444%22%20text-anchor%3D%22middle%22%20dominant-baseline%3D%22middle%22%3EL%E1%BB%97i%3C%2Ftext%3E%3C%2Fsvg%3E';" 
                                         class="max-w-full max-h-full object-contain rounded-md">
                                </div>
                            </td>
                            <td class="px-6 py-3 font-bold text-purple-900 font-mono">{{ .MaThuongHieu }}</td>
                            <td class="px-6 py-3 font-bold text-[15px]">{{ .TenThuongHieu }}</td>
                            <td class="px-6 py-3 text-center">
                                {{ if eq .TrangThai 1 }}<span class="text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md text-xs border border-blue-100">Ho·∫°t ƒë·ªông</span>{{ else }}<span class="text-slate-500 font-bold bg-slate-100 px-2 py-1 rounded-md text-xs border border-slate-200">ƒê√£ T·∫Øt</span>{{ end }}
                            </td>
                            <td class="px-6 py-3 text-center">
                                <button type="button" onclick="editTH('{{ .MaThuongHieu }}')" class="text-purple-600 hover:text-white border border-purple-200 hover:bg-purple-600 px-4 py-1.5 rounded-lg font-bold transition text-xs shadow-sm">S·ª≠a</button>
                            </td>
                        </tr>
                        {{ end }}
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tabNCC" class="tab-content bg-white rounded-b-2xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex flex-wrap justify-between items-center bg-orange-50/50 gap-3">
                <div class="relative flex-1 md:w-80 max-w-md">
                    <input type="text" id="searchNCC" onkeyup="filterTable('searchNCC', 'tbodyNCC')" placeholder="üîç T√¨m SƒêT, T√™n Nh√† Cung C·∫•p..." class="input-premium pl-10 h-[40px] border-orange-200">
                </div>
                <button type="button" onclick="openModalNCC()" class="bg-orange-600 hover:bg-orange-700 text-white px-5 py-2 rounded-xl font-bold shadow-md shadow-orange-200 flex items-center gap-2 text-sm transition active:scale-95">
                    ‚úö Th√™m ƒê·ªëi T√°c
                </button>
            </div>
            <div class="overflow-x-auto max-h-[65vh] custom-scroll">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 sticky top-0 z-10 border-b border-slate-200 text-xs uppercase text-slate-500 font-black">
                        <tr>
                            <th class="px-6 py-4">M√£ NCC</th>
                            <th class="px-6 py-4">T√™n Nh√† Cung C·∫•p</th>
                            <th class="px-6 py-4 text-center">Li√™n H·ªá</th>
                            <th class="px-6 py-4 text-right text-red-600">C√¥ng N·ª£</th>
                            <th class="px-6 py-4 text-center text-blue-600">Tr·∫°ng th√°i</th>
                            <th class="px-6 py-4 text-center">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyNCC" class="divide-y divide-slate-100">
                        {{ range .ListNCC }}
                        {{ if ne .MaNhaCungCap "" }}
                        <tr class="hover:bg-orange-50/30 transition">
                            <td class="px-6 py-4 font-bold text-orange-900 font-mono">{{ .MaNhaCungCap }}</td>
                            <td class="px-6 py-4 font-bold text-[14.5px] text-slate-800">{{ .TenNhaCungCap }}</td>
                            <td class="px-6 py-4 text-center font-medium">{{ .DienThoai }}<br><span class="text-xs text-slate-400">{{ .NguoiLienHe }}</span></td>
                            <td class="px-6 py-4 text-right font-bold text-red-600">{{ format_money .NoCanTra }} ‚Ç´</td>
                            <td class="px-6 py-4 text-center">
                                {{ if eq .TrangThai 1 }}<span class="text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md text-[11px] border border-blue-100">Giao d·ªãch</span>{{ else }}<span class="text-red-500 font-bold bg-red-50 px-2 py-1 rounded-md text-[11px] border border-red-200">Ng·ª´ng</span>{{ end }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <button type="button" onclick="editNCC('{{ .MaNhaCungCap }}')" class="text-orange-600 hover:text-white border border-orange-200 hover:bg-orange-600 px-4 py-1.5 rounded-lg font-bold transition text-xs shadow-sm">S·ª≠a</button>
                            </td>
                        </tr>
                        {{ end }}
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tabBLN" class="tab-content bg-white rounded-b-2xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex flex-wrap justify-between items-center bg-emerald-50/50 gap-3">
                <div class="relative flex-1 md:w-80 max-w-md">
                    <input type="text" id="searchBLN" onkeyup="filterTable('searchBLN', 'tbodyBLN')" placeholder="üîç T√¨m khung gi√°..." class="input-premium pl-10 h-[40px] border-emerald-200">
                </div>
                <button type="button" onclick="openModalBLN()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-xl font-bold shadow-md shadow-emerald-200 flex items-center gap-2 text-sm transition active:scale-95">
                    ‚úö Th√™m Khung Gi√°
                </button>
            </div>
            <div class="overflow-x-auto max-h-[65vh] custom-scroll">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 sticky top-0 z-10 border-b border-slate-200 text-xs uppercase text-slate-500 font-black">
                        <tr>
                            <th class="px-6 py-4 text-center">Khung Gi√° Nh·∫≠p (VNƒê)</th>
                            <th class="px-6 py-4 text-center text-emerald-600">Bi√™n L·ª£i Nhu·∫≠n √Åp D·ª•ng (%)</th>
                            <th class="px-6 py-4 text-center text-blue-600">Tr·∫°ng th√°i</th>
                            <th class="px-6 py-4 text-center">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyBLN" class="divide-y divide-slate-100">
                        {{ range .ListBLN }}
                        <tr class="hover:bg-emerald-50/30 transition">
                            <td class="px-6 py-4 font-bold text-slate-800 text-center">T·ª´ <span class="text-slate-400 font-medium font-mono bg-slate-100 px-1 rounded">{{ format_money .GiaTu }} ‚Ç´</span> ƒë·∫øn <span class="text-red-600 font-mono">{{ format_money .KhungGiaNhap }} ‚Ç´</span></td>
                            <td class="px-6 py-4 font-black text-emerald-600 text-lg text-center">{{ .BienLoiNhuan }} %</td>
                            <td class="px-6 py-4 text-center">
                                {{ if eq .TrangThai 1 }}<span class="text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-md text-xs border border-blue-100">ƒêang √°p d·ª•ng</span>{{ else }}<span class="text-slate-500 font-bold bg-slate-100 px-2 py-1 rounded-md text-xs border border-slate-200">ƒê√£ T·∫Øt</span>{{ end }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <button type="button" onclick="editBLN('{{ .DongTrongSheet }}')" class="text-emerald-600 hover:text-white border border-emerald-200 hover:bg-emerald-600 px-4 py-1.5 rounded-lg font-bold transition text-xs shadow-sm">S·ª≠a</button>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalDM" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all overflow-hidden border border-indigo-100">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-indigo-50">
                <h3 class="text-lg font-black text-indigo-900" id="titleDM">Th√™m Danh M·ª•c</h3>
                <button type="button" onclick="closeModal('modalDM')" class="text-slate-400 hover:text-red-500 font-bold text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="formDM" class="space-y-4" autocomplete="off">
                    <input type="hidden" name="is_new" id="is_new_dm" value="true">
                    <div>
                        <label>Danh m·ª•c M·∫π (G·ªëc)</label>
                        <select name="danh_muc_me" id="dm_me" class="input-premium cursor-pointer bg-white">
                            <option value="">--- ƒê√¢y l√† Danh m·ª•c G·ªëc ---</option>
                            {{ range .ListDanhMuc }}{{ if ne .MaDanhMuc "" }}<option value="{{ .MaDanhMuc }}">{{ .MaDanhMuc }} - {{ .TenDanhMuc }}</option>{{ end }}{{ end }}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label>M√£ (Vi·∫øt t·∫Øt) <span class="text-red-500">*</span></label>
                            <input type="text" name="ma_danh_muc" id="dm_ma" class="input-premium uppercase font-bold text-indigo-700" required placeholder="VD: MAIN">
                        </div>
                        <div>
                            <label>T√™n Danh M·ª•c <span class="text-red-500">*</span></label>
                            <input type="text" name="ten_danh_muc" id="dm_ten" class="input-premium" required placeholder="Mainboard">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-red-600">Thu·∫ø VAT (%)</label><input type="number" name="thue_vat" id="dm_thue" class="input-premium text-center font-bold text-red-600" value="0"></div>
                        <div><label class="text-emerald-600">L·ª£i Nhu·∫≠n Ri√™ng</label><input type="number" name="loi_nhuan" id="dm_loi" class="input-premium text-center font-bold text-emerald-600" placeholder="ƒê·ªÉ 0 = Auto"></div>
                    </div>
                    <div class="mt-2 pt-4 border-t border-slate-100"><label class="flex items-center cursor-pointer mb-0"><input type="checkbox" name="trang_thai" id="dm_trangthai" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 mr-2" checked> <span class="font-bold text-slate-700">ƒêang ho·∫°t ƒë·ªông</span></label></div>
                </form>
            </div>
            <div class="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                <button type="button" onclick="closeModal('modalDM')" class="px-5 py-2 font-bold text-slate-500 hover:bg-slate-200 rounded-xl">H·ªßy</button>
                <button type="button" id="btnSaveDM" onclick="saveDM()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-md transition">L∆∞u Danh M·ª•c</button>
            </div>
        </div>
    </div>

    <div id="modalTH" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all overflow-hidden border border-purple-100">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-purple-50">
                <h3 class="text-lg font-black text-purple-900" id="titleTH">Th√™m Th∆∞∆°ng Hi·ªáu</h3>
                <button type="button" onclick="closeModal('modalTH')" class="text-slate-400 hover:text-red-500 font-bold text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="formTH" class="space-y-4" autocomplete="off">
                    <input type="hidden" name="is_new" id="is_new_th" value="true">
                    <div class="grid grid-cols-[1fr_2fr] gap-4">
                        <div>
                            <label>M√£ H√£ng <span class="text-red-500">*</span></label>
                            <input type="text" name="ma_thuong_hieu" id="th_ma" class="input-premium uppercase font-bold text-purple-700" required placeholder="ASUS">
                        </div>
                        <div><label>T√™n Th∆∞∆°ng Hi·ªáu <span class="text-red-500">*</span></label><input type="text" name="ten_thuong_hieu" id="th_ten" class="input-premium font-bold" required></div>
                    </div>
                    <div><label>Link ·∫¢nh Logo (URL)</label><input type="text" name="logo_url" id="th_logo" class="input-premium font-mono text-[13px]" placeholder="https://..."></div>
                    <div><label>M√¥ t·∫£ ng·∫Øn</label><textarea name="mo_ta" id="th_mota" rows="2" class="input-premium"></textarea></div>
                    <div class="mt-2 pt-4 border-t border-slate-100"><label class="flex items-center cursor-pointer mb-0"><input type="checkbox" name="trang_thai" id="th_trangthai" class="w-5 h-5 text-purple-600 rounded mr-2" checked> <span class="font-bold text-slate-700">ƒêang ho·∫°t ƒë·ªông</span></label></div>
                </form>
            </div>
            <div class="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                <button type="button" onclick="closeModal('modalTH')" class="px-5 py-2 font-bold text-slate-500 hover:bg-slate-200 rounded-xl">H·ªßy</button>
                <button type="button" id="btnSaveTH" onclick="saveTH()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-md transition">L∆∞u H√£ng</button>
            </div>
        </div>
    </div>

    <div id="modalNCC" class="hidden fixed inset-0 bg-slate-900/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all overflow-hidden border border-orange-100">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-orange-50">
                <h3 class="text-lg font-black text-orange-900" id="titleNCC">Th√™m ƒê·ªëi T√°c / Nh√† Cung C·∫•p</h3>
                <button type="button" onclick="closeModal('modalNCC')" class="text-slate-400 hover:text-red-500 font-bold text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="formNCC" class="space-y-4" autocomplete="off">
                    <input type="hidden" name="is_new" id="is_new_ncc" value="true">
                    <div class="grid grid-cols-[1fr_2fr] gap-4">
                        <div>
                            <label>M√£ NCC</label>
                            <input type="text" name="ma_nha_cung_cap" id="ncc_ma" class="input-premium font-mono font-bold text-slate-400 border-dashed" placeholder="T·ª± sinh" readonly>
                        </div>
                        <div>
                            <label>T√™n Nh√† Cung C·∫•p <span class="text-red-500">*</span></label>
                            <input type="text" name="ten_nha_cung_cap" id="ncc_ten" class="input-premium font-bold text-[15px]" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label>ƒêi·ªán tho·∫°i</label><input type="text" name="dien_thoai" id="ncc_sdt" class="input-premium font-mono"></div>
                        <div><label>M√£ s·ªë thu·∫ø</label><input type="text" name="ma_so_thue" id="ncc_mst" class="input-premium font-mono"></div>
                    </div>
                    <div><label>ƒê·ªãa ch·ªâ</label><input type="text" name="dia_chi" id="ncc_dc" class="input-premium"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label>Ng∆∞·ªùi li√™n h·ªá</label><input type="text" name="nguoi_lien_he" id="ncc_lh" class="input-premium"></div>
                        <div><label>T√†i kho·∫£n Ng√¢n h√†ng</label><input type="text" name="ngan_hang" id="ncc_nh" class="input-premium" placeholder="STK - T√™n Ng√¢n H√†ng"></div>
                    </div>
                    <div class="mt-2 pt-4 border-t border-slate-100"><label class="flex items-center cursor-pointer mb-0"><input type="checkbox" name="trang_thai" id="ncc_trangthai" class="w-5 h-5 text-orange-600 rounded mr-2" checked> <span class="font-bold text-slate-700">ƒê∆∞·ª£c ph√©p giao d·ªãch</span></label></div>
                </form>
            </div>
            <div class="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                <button type="button" onclick="closeModal('modalNCC')" class="px-5 py-2 font-bold text-slate-500 hover:bg-slate-200 rounded-xl">H·ªßy</button>
                <button type="button" id="btnSaveNCC" onclick="saveNCC()" class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-xl shadow-md transition">L∆∞u ƒê·ªëi T√°c</button>
            </div>
        </div>
    </div>

    <div id="modalBLN" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all overflow-hidden border border-emerald-100">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-emerald-50">
                <h3 class="text-lg font-black text-emerald-900" id="titleBLN">Th√™m Khung Gi√°</h3>
                <button type="button" onclick="closeModal('modalBLN')" class="text-slate-400 hover:text-red-500 font-bold text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="formBLN" class="space-y-4" autocomplete="off">
                    <input type="hidden" name="is_new" id="is_new_bln" value="true">
                    <input type="hidden" name="dong_cu" id="bln_dong">
                    
                    <div>
                        <label>Khung Gi√° Nh·∫≠p (T·ªëi ƒêa VNƒê) <span class="text-red-500">*</span></label>
                        <input type="text" name="khung_gia_nhap" id="bln_khung" class="input-premium text-red-600 font-bold text-right text-lg font-mono" onkeyup="this.value = this.value.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, '.')" required placeholder="V√≠ d·ª•: 1.000.000">
                    </div>
                    <div>
                        <label>Bi√™n L·ª£i Nhu·∫≠n T∆∞∆°ng ·ª®ng (%) <span class="text-red-500">*</span></label>
                        <input type="number" name="bien_loi_nhuan" id="bln_loi" class="input-premium text-emerald-600 font-bold text-center text-xl font-mono" required placeholder="30">
                    </div>
                    <div class="mt-2 pt-4 border-t border-slate-100"><label class="flex items-center cursor-pointer mb-0"><input type="checkbox" name="trang_thai" id="bln_trangthai" class="w-5 h-5 text-emerald-600 rounded mr-2" checked> <span class="font-bold text-slate-700">ƒêang ho·∫°t ƒë·ªông</span></label></div>
                </form>
            </div>
            <div class="px-6 py-4 border-t bg-slate-50 flex justify-end gap-3">
                <button type="button" onclick="closeModal('modalBLN')" class="px-5 py-2 font-bold text-slate-500 hover:bg-slate-200 rounded-xl">H·ªßy</button>
                <button type="button" id="btnSaveBLN" onclick="saveBLN()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-md transition">L∆∞u Khung Gi√°</button>
            </div>
        </div>
    </div>

    <script>
        function decodeGo(str) { if (!str) return ""; return decodeURIComponent(str.replace(/\+/g, '%20')); }

        // B·ªëc t√°ch RAM cho JS
        const mapDM = {}; document.querySelectorAll('#data_dm .dm-item').forEach(el => { let ma = el.getAttribute('data-ma'); if(ma) mapDM[ma] = { ma: ma, ten: decodeGo(el.getAttribute('data-ten')), me: decodeGo(el.getAttribute('data-me')), thue: parseFloat(el.getAttribute('data-vat'))||0, loi: parseFloat(el.getAttribute('data-loi'))||0, tt: parseInt(el.getAttribute('data-tt'))||0 }; });
        const mapTH = {}; document.querySelectorAll('#data_th .th-item').forEach(el => { let ma = el.getAttribute('data-ma'); if(ma) mapTH[ma] = { ma: ma, ten: decodeGo(el.getAttribute('data-ten')), logo: decodeGo(el.getAttribute('data-logo')), mota: decodeGo(el.getAttribute('data-mota')), tt: parseInt(el.getAttribute('data-tt'))||0 }; });
        const mapBLN = {}; document.querySelectorAll('#data_bln .bln-item').forEach(el => { let dong = el.getAttribute('data-dong'); if(dong) mapBLN[dong] = { dong: dong, khung: parseFloat(el.getAttribute('data-khung'))||0, loi: parseFloat(el.getAttribute('data-loi'))||0, tt: parseInt(el.getAttribute('data-tt'))||0 }; });
        const mapNCC = {}; document.querySelectorAll('#data_ncc .ncc-item').forEach(el => { let ma = el.getAttribute('data-ma'); if(ma) mapNCC[ma] = { ma: ma, ten: decodeGo(el.getAttribute('data-ten')), sdt: decodeGo(el.getAttribute('data-sdt')), dc: decodeGo(el.getAttribute('data-dc')), mst: decodeGo(el.getAttribute('data-mst')), lh: decodeGo(el.getAttribute('data-lh')), nh: decodeGo(el.getAttribute('data-nh')), tt: parseInt(el.getAttribute('data-tt'))||0 }; });
        document.getElementById('data_island').remove();

        // Logic Tab
        function switchTab(tabId, activeClass) {
            document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.remove('active-blue', 'active-purple', 'active-emerald', 'active-orange'); });
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const btn = document.getElementById('btn-' + tabId); const tab = document.getElementById(tabId);
            if (btn && tab) { btn.classList.add(activeClass); tab.classList.add('active'); localStorage.setItem('activeTab_MasterCaiDat', tabId); }
        }
        (function restoreTab() { const savedTab = localStorage.getItem('activeTab_MasterCaiDat'); 
            if (savedTab === 'tabDM') switchTab('tabDM', 'active-blue');
            else if (savedTab === 'tabTH') switchTab('tabTH', 'active-purple');
            else if (savedTab === 'tabNCC') switchTab('tabNCC', 'active-orange');
            else if (savedTab === 'tabBLN') switchTab('tabBLN', 'active-emerald');
            else switchTab('tabDM', 'active-blue');
        })();

        function filterTable(inputId, tbodyId) { const query = document.getElementById(inputId).value.toLowerCase(); document.querySelectorAll(`#${tbodyId} tr`).forEach(row => { row.style.display = row.innerText.toLowerCase().includes(query) ? '' : 'none'; }); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // Fetch Functions (T√°i s·ª≠ d·ª•ng API t·ª´ b·∫£ng Admin v√¨ chung b·∫£n ch·∫•t)
        async function runSubmit(url, formId, btnId, originText) {
            const btn = document.getElementById(btnId); btn.disabled = true; btn.innerHTML = 'ƒêang l∆∞u...';
            try {
                const res = await fetch(url, { method: 'POST', body: new FormData(document.getElementById(formId)) });
                const data = await res.json();
                if(data.status === 'ok') location.reload(); else { Swal.fire('L·ªói', data.msg, 'error'); btn.disabled = false; btn.innerHTML = originText; }
            } catch(e) { Swal.fire('L·ªói', 'M·∫•t k·∫øt n·ªëi', 'error'); btn.disabled = false; btn.innerHTML = originText; }
        }

        // Action DM
        function openModalDM() { document.getElementById('formDM').reset(); document.getElementById('is_new_dm').value = "true"; document.getElementById('dm_ma').readOnly = false; document.getElementById('titleDM').innerText = "Th√™m Danh M·ª•c M·ªõi"; document.getElementById('modalDM').classList.remove('hidden'); }
        function editDM(ma) { const item = mapDM[ma]; if(!item) return; document.getElementById('is_new_dm').value = "false"; document.getElementById('dm_ma').value = item.ma; document.getElementById('dm_ma').readOnly = true; document.getElementById('dm_ten').value = item.ten; document.getElementById('dm_me').value = item.me; document.getElementById('dm_thue').value = item.thue; document.getElementById('dm_loi').value = item.loi; document.getElementById('dm_trangthai').checked = (item.tt === 1); document.getElementById('titleDM').innerText = "S·ª≠a Danh M·ª•c: " + item.ma; document.getElementById('modalDM').classList.remove('hidden'); }
        function saveDM() { runSubmit('/admin/api/category/save', 'formDM', 'btnSaveDM', 'L∆∞u Danh M·ª•c'); }

        // Action TH
        function openModalTH() { document.getElementById('formTH').reset(); document.getElementById('is_new_th').value = "true"; document.getElementById('th_ma').readOnly = false; document.getElementById('titleTH').innerText = "Th√™m Th∆∞∆°ng Hi·ªáu"; document.getElementById('modalTH').classList.remove('hidden'); }
        function editTH(ma) { const item = mapTH[ma]; if(!item) return; document.getElementById('is_new_th').value = "false"; document.getElementById('th_ma').value = item.ma; document.getElementById('th_ma').readOnly = true; document.getElementById('th_ten').value = item.ten; document.getElementById('th_logo').value = item.logo; document.getElementById('th_mota').value = item.mota; document.getElementById('th_trangthai').checked = (item.tt === 1); document.getElementById('titleTH').innerText = "S·ª≠a Th∆∞∆°ng Hi·ªáu: " + item.ma; document.getElementById('modalTH').classList.remove('hidden'); }
        function saveTH() { runSubmit('/admin/api/brand/save', 'formTH', 'btnSaveTH', 'L∆∞u H√£ng'); }

        // Action NCC (Route n√†y n√©m v·ªÅ Master theo Step 3 b√™n d∆∞·ªõi)
        function openModalNCC() { document.getElementById('formNCC').reset(); document.getElementById('is_new_ncc').value = "true"; document.getElementById('titleNCC').innerText = "Th√™m Nh√† Cung C·∫•p M·ªõi"; document.getElementById('modalNCC').classList.remove('hidden'); }
        function editNCC(ma) { const item = mapNCC[ma]; if(!item) return; document.getElementById('is_new_ncc').value = "false"; document.getElementById('ncc_ma').value = item.ma; document.getElementById('ncc_ten').value = item.ten; document.getElementById('ncc_sdt').value = item.sdt; document.getElementById('ncc_mst').value = item.mst; document.getElementById('ncc_dc').value = item.dc; document.getElementById('ncc_lh').value = item.lh; document.getElementById('ncc_nh').value = item.nh; document.getElementById('ncc_trangthai').checked = (item.tt === 1); document.getElementById('titleNCC').innerText = "S·ª≠a ƒê·ªëi T√°c: " + item.ma; document.getElementById('modalNCC').classList.remove('hidden'); }
        // Action DM
        function saveDM() { runSubmit('/master/api/cai-dat-cau-hinh/danh-muc/save', 'formDM', 'btnSaveDM', 'L∆∞u Danh M·ª•c'); }

        // Action TH
        function saveTH() { runSubmit('/master/api/cai-dat-cau-hinh/thuong-hieu/save', 'formTH', 'btnSaveTH', 'L∆∞u H√£ng'); }

        // Action NCC 
        function saveNCC() { runSubmit('/master/api/cai-dat-cau-hinh/nha-cung-cap/save', 'formNCC', 'btnSaveNCC', 'L∆∞u ƒê·ªëi T√°c'); }

        // Action BLN
        function saveBLN() { runSubmit('/master/api/cai-dat-cau-hinh/bien-loi-nhuan/save', 'formBLN', 'btnSaveBLN', 'L∆∞u Khung Gi√°'); }
        
        async function syncSlot() {
            const btn = document.getElementById('btnSync'); const originText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = `ƒêang qu√©t...`;
            try {
                const res = await fetch('/master/api/cai-dat-cau-hinh/danh-muc/sync-slots', { method: 'POST' }); 
                const data = await res.json();
                if(data.status === 'ok') Swal.fire({icon: 'success', title: 'Ho√†n t·∫•t', text: data.msg, timer: 1500, showConfirmButton: false}).then(() => location.reload()); else Swal.fire('L·ªói', data.msg, 'error');
            } catch(e) { } finally { btn.disabled = false; btn.innerHTML = originText; }
        }
    </script>
    {{ template "footer_master" . }}
{{ end }}
