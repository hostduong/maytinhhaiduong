{{ define "master_thanh_vien" }}
    {{ template "header_master" . }}
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>

    <style>
        .input-premium { width: 100%; box-sizing: border-box; background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 0.9rem; padding: 0.6rem 1rem; transition: 0.2s; outline: none; }
        .input-premium:focus { border-color: #9333ea; box-shadow: 0 0 0 3px rgba(147,51,234,0.1); background-color: #fff; }
        .input-premium:disabled, .input-premium[readonly] { cursor: not-allowed; opacity: 0.7; background-color: #f1f5f9; }
        label.form-lbl { font-size: 0.75rem; font-weight: bold; color: #64748b; text-transform: uppercase; margin-bottom: 0.35rem; display: block; letter-spacing: 0.05em; }
        .iti { width: 100%; } 
    </style>

    <div class="max-w-7xl mx-auto mb-10">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-2xl font-black text-slate-800 tracking-tight">üõ°Ô∏è Qu·∫£n L√Ω Core Team</h1>
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="relative flex-1 md:w-72">
                    <input type="text" id="searchMember" onkeyup="filterTable('searchMember', 'tbodyMembers')" placeholder="T√¨m t√™n, SƒêT, Email..." class="w-full pl-10 pr-4 py-2.5 text-sm font-medium border border-slate-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none transition bg-white shadow-sm">
                    <svg class="w-4 h-4 text-slate-400 absolute left-3.5 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <button onclick="openMessageModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-md shadow-purple-200 flex items-center gap-2 transition transform hover:-translate-y-0.5 text-sm whitespace-nowrap">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    G·ª≠i Th√¥ng B√°o (<span id="countSelected">0</span>)
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600 min-w-[800px]">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-5 py-4 text-center w-12"><input type="checkbox" id="checkAll" onchange="toggleAllCheckboxes()" class="w-4 h-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500"></th>
                            <th class="px-6 py-4 font-bold tracking-wider">Th√†nh Vi√™n Master</th>
                            <th class="px-6 py-4 font-bold tracking-wider">Li√™n h·ªá</th>
                            <th class="px-6 py-4 font-bold tracking-wider">Ch·ª©c V·ª•</th>
                            <th class="px-6 py-4 font-bold text-center tracking-wider">Tr·∫°ng Th√°i</th>
                            <th class="px-6 py-4 font-bold text-center tracking-wider w-28">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyMembers" class="divide-y divide-slate-100">
                        {{ range .DanhSach }}
                        <tr class="bg-white hover:bg-slate-50 transition group">
                            <td class="px-5 py-4 text-center"><input type="checkbox" value="{{ .MaKhachHang }}" class="chk-member w-4 h-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500" onchange="updateCount()"></td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-slate-800 text-base group-hover:text-purple-600 transition search-target">{{ .TenKhachHang }}</div>
                                <div class="text-[11px] text-slate-400 font-mono mt-0.5">ID: {{ .MaKhachHang }}</div>
                                <div class="text-[11px] text-purple-500 font-medium search-target">User: {{ .TenDangNhap }}</div>
                            </td>
                            <td class="px-6 py-4 text-xs space-y-1">
                                <div class="flex items-center gap-1.5"><span class="text-slate-400">üìû</span> {{ if .DienThoai }}<span class="font-medium text-slate-700 search-target">{{ .DienThoai }}</span>{{ else }}---{{ end }}</div>
                                <div class="flex items-center gap-1.5"><span class="text-slate-400">üìß</span> {{ if .Email }}<span class="font-medium text-slate-700 search-target">{{ .Email }}</span>{{ else }}---{{ end }}</div>
                            </td>
                            <td class="px-6 py-4">
                                {{ if eq .VaiTroQuyenHan "quan_tri_he_thong" }}
                                    <span class="bg-slate-900 text-yellow-400 text-[10px] font-black tracking-widest px-3 py-1.5 rounded-lg shadow-sm uppercase">{{ .ChucVu }}</span>
                                {{ else if eq .VaiTroQuyenHan "quan_tri_vien_he_thong" }}
                                    <span class="bg-red-600 text-white text-[10px] font-black tracking-widest px-3 py-1.5 rounded-lg shadow-sm uppercase">{{ .ChucVu }}</span>
                                {{ else }}
                                    <span class="bg-slate-100 text-slate-700 text-xs font-bold px-3 py-1.5 rounded-lg border border-slate-200 uppercase">{{ .ChucVu }}</span>
                                {{ end }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                {{ if eq .TrangThai 1 }}
                                    <span class="inline-flex items-center gap-1.5 bg-emerald-50 text-emerald-700 px-2.5 py-1 rounded-full text-xs font-bold border border-emerald-200"><span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> M·ªü</span>
                                {{ else }}
                                    <span class="inline-flex items-center gap-1.5 bg-red-50 text-red-700 px-2.5 py-1 rounded-full text-xs font-bold border border-red-200"><span class="w-2 h-2 bg-red-500 rounded-full"></span> Kh√≥a</span>
                                {{ end }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="editMember('{{ .MaKhachHang }}')" class="bg-white text-purple-600 hover:bg-purple-600 hover:text-white px-4 py-2 rounded-xl text-xs font-bold transition shadow-sm border border-slate-200 hover:border-purple-600 active:scale-95">Qu·∫£n l√Ω</button>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="data_members" class="hidden">
        {{ range .DanhSach }}
        <div class="m-data" 
            data-id="{{ .MaKhachHang }}" data-name="{{ .TenKhachHang }}" 
            data-role="{{ .VaiTroQuyenHan }}" data-title="{{ .ChucVu }}" 
            data-phone="{{ .DienThoai }}" data-dob="{{ .NgaySinh }}" data-gender="{{ .GioiTinh }}" 
            data-address="{{ .DiaChi }}" data-tax="{{ .MaSoThue }}" data-status="{{ .TrangThai }}"
            data-zalo="{{ .MangXaHoi.Zalo }}" data-fb="{{ .MangXaHoi.Facebook }}" data-tiktok="{{ .MangXaHoi.Tiktok }}"
            data-note="{{ .GhiChu }}" data-avatar="{{ .AnhDaiDien }}" data-source="{{ .NguonKhachHang }}"
            data-created="{{ .NgayTao }}" data-updater="{{ .NguoiCapNhat }}" data-updated="{{ .NgayCapNhat }}">
        </div>
        {{ end }}
    </div>

    <div id="modalEdit" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 backdrop-blur-sm p-4 sm:p-6">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-6xl transform transition-all flex flex-col max-h-[95vh]">
            
            <div class="px-6 sm:px-8 py-5 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-3xl shrink-0">
                <div class="flex items-center gap-3">
                    <span class="bg-purple-100 p-2.5 rounded-xl text-purple-600 shadow-inner">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </span>
                    <h3 class="text-xl sm:text-2xl font-black text-slate-800 tracking-tight" id="modalTitle">H·ªì S∆° & Ph√¢n Quy·ªÅn</h3>
                </div>
                <button onclick="closeModal('modalEdit')" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-500 transition text-xl font-bold">&times;</button>
            </div>
            
            <div class="p-6 sm:p-8 overflow-y-auto bg-slate-50/80 custom-scroll">
                <form id="formEdit" class="space-y-6" autocomplete="off" spellcheck="false">
                    <input type="hidden" name="ma_khach_hang" id="f_ma">
                    
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        <div class="lg:col-span-7 space-y-6">
                            
                            <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-sm border border-slate-200">
                                <h4 class="font-black text-purple-600 border-b border-slate-100 pb-3 mb-5 uppercase tracking-widest text-xs flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg> Th√¥ng tin c∆° b·∫£n
                                </h4>
                                
                                <div class="space-y-5">
                                    <div>
                                        <label class="form-lbl">H·ªç v√† t√™n <span class="text-red-500">*</span></label>
                                        <input type="text" name="ten_khach_hang" id="f_ten" class="input-premium font-bold text-slate-900" required>
                                    </div>
                                    
                                    <div>
                                        <label class="form-lbl">Link ·∫¢nh ƒë·∫°i di·ªán</label>
                                        <input type="url" name="anh_dai_dien" id="f_avatar" class="input-premium font-mono text-sm" placeholder="https://...">
                                    </div>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                        <div><label class="form-lbl">ƒêi·ªán tho·∫°i</label><input type="tel" id="f_sdt_fake" class="input-premium"></div>
                                        <div><label class="form-lbl">Ng√†y sinh</label><input type="date" name="ngay_sinh" id="f_dob" class="input-premium bg-white"></div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-5">
                                        <div>
                                            <label class="form-lbl">Gi·ªõi t√≠nh</label>
                                            <select name="gioi_tinh" id="f_gender" class="input-premium bg-white cursor-pointer"><option value="-1">Kh√°c</option><option value="1">Nam</option><option value="0">N·ªØ</option></select>
                                        </div>
                                        <div><label class="form-lbl">M√£ s·ªë thu·∫ø</label><input type="text" name="ma_so_thue" id="f_tax" class="input-premium"></div>
                                    </div>
                                    
                                    <div><label class="form-lbl">ƒê·ªãa ch·ªâ</label><input type="text" name="dia_chi" id="f_address" class="input-premium" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng x√£..."></div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-sm border border-slate-200">
                                <h4 class="font-black text-blue-600 border-b border-slate-100 pb-3 mb-5 uppercase tracking-widest text-xs flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg> Li√™n l·∫°c s·ªë & Kh√°c
                                </h4>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div><label class="form-lbl text-blue-800">Zalo (SƒêT)</label><input type="tel" id="f_zalo_fake" class="input-premium"></div>
                                    <div><label class="form-lbl text-blue-800">Link Facebook</label><input type="text" name="facebook" id="f_fb" class="input-premium" placeholder="https://facebook.com/..."></div>
                                    <div><label class="form-lbl text-blue-800">Link Tiktok</label><input type="text" name="tiktok" id="f_tiktok" class="input-premium" placeholder="https://tiktok.com/@..."></div>
                                    <div><label class="form-lbl text-emerald-800">Ngu·ªìn kh√°ch h√†ng</label><input type="text" name="nguon_khach_hang" id="f_source" class="input-premium bg-emerald-50/50" placeholder="VD: ƒêƒÉng k√Ω Web..."></div>
                                </div>
                                
                                <div class="mt-5 pt-5 border-t border-slate-100">
                                    <label class="form-lbl">Ghi ch√∫ n·ªôi b·ªô</label>
                                    <textarea name="ghi_chu" id="f_note" rows="2" class="input-premium bg-amber-50/50 border-amber-200" placeholder="Ghi ch√∫ v·ªÅ kh√°ch/nh√¢n vi√™n n√†y..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-5 space-y-6">
                            
                            <div class="bg-gradient-to-b from-white to-purple-50 p-6 sm:p-8 rounded-3xl shadow-sm border border-purple-200 relative overflow-hidden">
                                <h4 class="font-black text-purple-800 border-b border-purple-200 pb-3 uppercase tracking-widest text-xs flex items-center gap-2 mb-5 relative z-10">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg> H·ªá th·ªëng & Quy·ªÅn h·∫°n
                                </h4>
                                
                                <div class="space-y-5 relative z-10">
                                    <div>
                                        <label class="form-lbl text-purple-900">Vai tr√≤ / Ph√¢n quy·ªÅn <span class="text-red-500">*</span></label>
                                        <select name="vai_tro" id="f_role" class="input-premium bg-white border-purple-300 text-purple-900 font-bold focus:ring-purple-600 cursor-pointer shadow-sm" required>
                                            {{ range .DanhSachVaiTro }}
                                                <option value="{{ .MaVaiTro }}">{{ .TenVaiTro }}</option>
                                            {{ end }}
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="form-lbl text-purple-900">Ch·ª©c v·ª• hi·ªÉn th·ªã (T√πy ch·ªânh)</label>
                                        <input type="text" name="chuc_vu" id="f_title" class="input-premium bg-white border-purple-200" placeholder="ƒê·ªÉ tr·ªëng s·∫Ω l·∫•y theo Vai tr√≤...">
                                    </div>
                                    
                                    <div class="pt-2">
                                        <label class="form-lbl">Tr·∫°ng th√°i t√†i kho·∫£n</label>
                                        <select name="trang_thai" id="f_status" class="input-premium bg-white font-bold cursor-pointer shadow-sm">
                                            <option value="1" class="text-emerald-600">‚úÖ Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng</option>
                                            <option value="0" class="text-red-600">üö´ KH√ìA T√ÄI KHO·∫¢N</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-sm border border-orange-200">
                                <h4 class="font-black text-orange-600 border-b border-orange-100 pb-3 uppercase tracking-widest text-xs flex items-center gap-2 mb-5">
                                    <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> C·∫•p l·∫°i B·∫£o m·∫≠t
                                </h4>
                                
                                <div class="space-y-5">
                                    <div>
                                        <label class="form-lbl">M·∫≠t kh·∫©u m·ªõi</label>
                                        <div class="relative">
                                            <input type="password" name="mat_khau_moi" id="f_pass" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" class="input-premium font-mono pr-10" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi...">
                                            <button type="button" onclick="togglePass('f_pass')" class="absolute inset-y-0 right-0 pr-3.5 flex items-center text-slate-400 hover:text-orange-500"><svg id="eye_slash_f_pass" class="w-5 h-5 block" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg><svg id="eye_open_f_pass" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-lbl">M√£ PIN m·ªõi (8 s·ªë)</label>
                                        <div class="relative">
                                            <input type="password" name="pin_moi" id="f_pin" maxlength="8" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" class="input-premium font-mono tracking-widest pr-10" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi...">
                                            <button type="button" onclick="togglePass('f_pin')" class="absolute inset-y-0 right-0 pr-3.5 flex items-center text-slate-400 hover:text-orange-500"><svg id="eye_slash_f_pin" class="w-5 h-5 block" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg><svg id="eye_open_f_pin" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-slate-800 p-6 rounded-3xl shadow-inner border border-slate-700 text-slate-300">
                                <h4 class="font-black text-slate-400 border-b border-slate-700 pb-3 mb-4 uppercase tracking-widest text-[10px] flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Log D·ªØ Li·ªáu
                                </h4>
                                <div class="space-y-3 text-xs font-mono">
                                    <div class="flex justify-between items-center"><span class="text-slate-500">Ng√†y gia nh·∫≠p:</span> <span id="f_log_created" class="font-bold text-white">--</span></div>
                                    <div class="flex justify-between items-center"><span class="text-slate-500">C·∫≠p nh·∫≠t l√∫c:</span> <span id="f_log_updated" class="font-bold text-white">--</span></div>
                                    <div class="flex justify-between items-center"><span class="text-slate-500">B·ªüi nh√¢n vi√™n:</span> <span id="f_log_updater" class="font-bold text-purple-400">--</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="px-6 sm:px-8 py-5 border-t border-slate-200 bg-white rounded-b-3xl flex justify-end gap-4 shrink-0 z-10 shadow-[0_-10px_15px_-3px_rgba(0,0,0,0.05)]">
                <button onclick="closeModal('modalEdit')" class="px-6 py-3 text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-xl font-bold transition">ƒê√≥ng Modal</button>
                <button onclick="saveMember()" id="btnSaveMem" class="px-10 py-3 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 shadow-xl shadow-purple-600/30 transition transform hover:-translate-y-1 active:scale-95 flex items-center gap-2 text-base">
                    L∆∞u Thay ƒê·ªïi
                </button>
            </div>
        </div>
    </div>

    <div id="modalMsg" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg transform transition-all">
            <div class="px-6 py-5 border-b flex justify-between items-center bg-purple-600 rounded-t-3xl">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">üì¢ G·ª≠i Th√¥ng B√°o H·ªá Th·ªëng</h3>
                <button onclick="closeModal('modalMsg')" class="w-8 h-8 flex items-center justify-center rounded-full bg-purple-500/50 text-white hover:bg-red-500 transition text-xl font-bold">&times;</button>
            </div>
            <div class="p-6 sm:p-8 space-y-5">
                <div class="bg-purple-50 text-purple-700 p-4 rounded-xl text-sm font-medium border border-purple-100 flex items-center justify-between"><span>Chu·∫©n b·ªã g·ª≠i ƒë·∫øn:</span><span id="lblMsgCount" class="font-black text-purple-700 text-xl bg-purple-200 px-3 py-1 rounded-lg">0</span></div>
                <div><label class="form-lbl">Ti√™u ƒë·ªÅ tin nh·∫Øn <span class="text-red-500">*</span></label><input type="text" id="msgTitle" class="input-premium font-bold text-slate-800" placeholder="VD: Th√¥ng b√°o..." required></div>
                <div><label class="form-lbl">N·ªôi dung chi ti·∫øt <span class="text-red-500">*</span></label><textarea id="msgContent" rows="6" class="input-premium" placeholder="Nh·∫≠p n·ªôi dung..." required></textarea></div>
            </div>
            <div class="px-6 py-5 border-t bg-slate-50 rounded-b-3xl flex justify-end gap-3">
                <button onclick="closeModal('modalMsg')" class="px-6 py-2.5 text-slate-600 bg-white border border-slate-300 hover:bg-slate-50 rounded-xl font-bold transition">H·ªßy</button>
                <button onclick="sendMessages()" id="btnSendMsg" class="px-8 py-2.5 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 shadow-md transition transform active:scale-95 flex items-center gap-2">Ph√°t s√≥ng</button>
            </div>
        </div>
    </div>

    <script>
        const currentUserID = "{{ .NhanVien.MaKhachHang }}"; 
        const isMeRoot = (currentUserID === "0000000000000000001");
        let itiPhone, itiZalo;

        function togglePass(id) {
            const input = document.getElementById(id);
            const eyeSlash = document.getElementById('eye_slash_' + id);
            const eyeOpen = document.getElementById('eye_open_' + id);
            if (input.type === "password") { input.type = "text"; eyeSlash.classList.add('hidden'); eyeOpen.classList.remove('hidden'); } 
            else { input.type = "password"; eyeOpen.classList.add('hidden'); eyeSlash.classList.remove('hidden'); }
        }

        window.toggleSwalPin = function() {
            const input = document.getElementById('swal-pin-input');
            const eyeSlash = document.getElementById('eye_slash_swal');
            const eyeOpen = document.getElementById('eye_open_swal');
            if (input.type === "password") { input.type = "text"; eyeSlash.classList.add('hidden'); eyeOpen.classList.remove('hidden'); } 
            else { input.type = "password"; eyeOpen.classList.add('hidden'); eyeSlash.classList.remove('hidden'); }
        };

        const mapData = {};
        document.querySelectorAll('.m-data').forEach(el => {
            let id = el.getAttribute('data-id');
            mapData[id] = {
                ten: el.getAttribute('data-name'), role: el.getAttribute('data-role'), title: el.getAttribute('data-title'),
                sdt: el.getAttribute('data-phone'), dob: el.getAttribute('data-dob'), gender: el.getAttribute('data-gender'),
                address: el.getAttribute('data-address'), tax: el.getAttribute('data-tax'), status: el.getAttribute('data-status'),
                zalo: el.getAttribute('data-zalo'), fb: el.getAttribute('data-fb'), tiktok: el.getAttribute('data-tiktok'), note: el.getAttribute('data-note'),
                avatar: el.getAttribute('data-avatar'), source: el.getAttribute('data-source'),
                created: el.getAttribute('data-created'), updater: el.getAttribute('data-updater'), updated: el.getAttribute('data-updated')
            };
        });

        function filterTable(inputId, tbodyId) { 
            const query = document.getElementById(inputId).value.toLowerCase(); 
            document.querySelectorAll(`#${tbodyId} tr`).forEach(row => { 
                const targets = row.querySelectorAll('.search-target');
                let found = false;
                targets.forEach(t => { if(t.innerText.toLowerCase().includes(query)) found = true; });
                row.style.display = found ? '' : 'none'; 
            }); 
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function editMember(ma) {
            let data = mapData[ma]; if(!data) return;
            document.getElementById('formEdit').reset();
            
            document.getElementById('f_pass').setAttribute('readonly', 'true');
            document.getElementById('f_pin').setAttribute('readonly', 'true');
            
            const inputPhone = document.querySelector("#f_sdt_fake"); 
            const inputZalo = document.querySelector("#f_zalo_fake"); 
            
            if (!itiPhone) itiPhone = window.intlTelInput(inputPhone, { initialCountry: "vn", separateDialCode: true, utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js" });
            if (!itiZalo) itiZalo = window.intlTelInput(inputZalo, { initialCountry: "vn", separateDialCode: true, utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js" });
            
            document.getElementById('f_ma').value = ma; document.getElementById('f_ten').value = data.ten;
            itiPhone.setNumber(data.sdt || ""); 
            itiZalo.setNumber(data.zalo || ""); 
            document.getElementById('f_dob').value = data.dob; document.getElementById('f_gender').value = data.gender;
            document.getElementById('f_tax').value = data.tax; document.getElementById('f_address').value = data.address;
            document.getElementById('f_title').value = data.title;
            document.getElementById('f_avatar').value = data.avatar; 
            document.getElementById('f_source').value = data.source; 
            document.getElementById('f_fb').value = data.fb; 
            document.getElementById('f_tiktok').value = data.tiktok; 
            document.getElementById('f_note').value = data.note; 

            // N·∫°p Log D·ªØ li·ªáu
            document.getElementById('f_log_created').innerText = data.created || "--";
            document.getElementById('f_log_updated').innerText = data.updated || "--";
            document.getElementById('f_log_updater').innerText = data.updater || "H·ªá Th·ªëng";

            const isTargetRoot = (ma === "0000000000000000001");
            let roleSelect = document.getElementById('f_role');
            let statusSelect = document.getElementById('f_status');

            Array.from(roleSelect.options).forEach(opt => {
                if (opt.value === "quan_tri_he_thong" || opt.value === "quan_tri_vien_he_thong") { opt.disabled = !isMeRoot; } else { opt.disabled = false; }
            });

            roleSelect.value = data.role;
            statusSelect.value = data.status;
            roleSelect.disabled = false;
            statusSelect.disabled = false;

            if (isTargetRoot) { roleSelect.disabled = true; if (!isMeRoot) statusSelect.disabled = true; } 
            else if (data.role === "quan_tri_vien_he_thong" && !isMeRoot) { roleSelect.disabled = true; }
            if (ma === currentUserID) { statusSelect.disabled = true; }

            document.getElementById('modalEdit').classList.remove('hidden');
        }

        async function saveMember() {
            const { value: pinXacNhan } = await Swal.fire({
                title: 'B·∫£o m·∫≠t 2 l·ªõp',
                html: `
                    <div class="text-sm text-slate-600 mb-5">Vui l√≤ng nh·∫≠p <b>M√£ PIN</b> c·ªßa b·∫°n ƒë·ªÉ x√°c nh·∫≠n.</div>
                    <div class="relative w-4/5 mx-auto">
                        <input type="password" id="swal-pin-input" class="swal2-pin-input w-full box-border bg-slate-50 border border-slate-300 rounded-xl py-3 px-4 text-center tracking-[0.5em] font-bold text-xl outline-none transition" maxlength="8" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                        <button type="button" onclick="toggleSwalPin()" class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-purple-600">
                            <svg id="eye_slash_swal" class="w-6 h-6 block" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                            <svg id="eye_open_swal" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#9333ea',
                cancelButtonColor: '#cbd5e1',
                confirmButtonText: 'X√°c nh·∫≠n',
                cancelButtonText: 'H·ªßy',
                didOpen: () => { setTimeout(() => { const input = document.getElementById('swal-pin-input'); input.removeAttribute('readonly'); input.focus(); }, 100); },
                preConfirm: () => { const val = document.getElementById('swal-pin-input').value; if (!val) { Swal.showValidationMessage('B·∫°n c·∫ßn nh·∫≠p m√£ PIN!'); return false; } return val; }
            });

            if (!pinXacNhan) { return; }

            const btn = document.getElementById('btnSaveMem'); const old = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = 'ƒêang l∆∞u...';
            
            const fd = new FormData(document.getElementById('formEdit'));
            fd.append('pin_xac_nhan', pinXacNhan);
            if (itiPhone) fd.set('dien_thoai', itiPhone.getNumber());
            if (itiZalo) fd.set('zalo', itiZalo.getNumber());
            
            if(document.getElementById('f_role').disabled) { fd.append('vai_tro', mapData[document.getElementById('f_ma').value].role); }
            if(document.getElementById('f_status').disabled) { fd.append('trang_thai', mapData[document.getElementById('f_ma').value].status); }

            try {
                const res = await fetch('/master/api/thanh-vien/save', { method: 'POST', body: fd });
                const data = await res.json();
                if(data.status === 'ok') Swal.fire({icon: 'success', title: 'Th√†nh c√¥ng', text: data.msg, timer: 1500, showConfirmButton: false}).then(() => location.reload());
                else Swal.fire('L·ªói b·∫£o m·∫≠t', data.msg, 'error'); 
            } catch(e) { Swal.fire('L·ªói m·∫°ng', 'K·∫øt n·ªëi th·∫•t b·∫°i', 'error'); } 
            finally { btn.disabled = false; btn.innerHTML = old; }
        }

        function getSelectedIDs() { let ids = []; document.querySelectorAll('.chk-member:checked').forEach(cb => ids.push(cb.value)); return ids; }
        function toggleAllCheckboxes() { let isChecked = document.getElementById('checkAll').checked; document.querySelectorAll('.chk-member').forEach(cb => cb.checked = isChecked); updateCount(); }
        function updateCount() { let count = document.querySelectorAll('.chk-member:checked').length; document.getElementById('countSelected').innerText = count; document.getElementById('lblMsgCount').innerText = count; }
        function openMessageModal() { let count = getSelectedIDs().length; if (count === 0) { Swal.fire('Oops!', 'Vui l√≤ng t√≠ch ch·ªçn √≠t nh·∫•t 1 ng∆∞·ªùi.', 'warning'); return; } document.getElementById('msgTitle').value = ""; document.getElementById('msgContent').value = ""; updateCount(); document.getElementById('modalMsg').classList.remove('hidden'); }

        async function sendMessages() {
            let title = document.getElementById('msgTitle').value.trim();
            let content = document.getElementById('msgContent').value.trim();
            let ids = getSelectedIDs();
            if (!title || !content) { Swal.fire('L·ªói', 'Ti√™u ƒë·ªÅ v√† n·ªôi dung kh√¥ng ƒë∆∞·ª£c tr·ªëng!', 'error'); return; }
            
            const btn = document.getElementById('btnSendMsg'); const old = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = 'ƒêang g·ª≠i...';
            const fd = new FormData(); fd.append('tieu_de', title); fd.append('noi_dung', content); fd.append('danh_sach_id', JSON.stringify(ids));
            
            try {
                const res = await fetch('/master/api/thanh-vien/send-msg', { method: 'POST', body: fd });
                const data = await res.json();
                if(data.status === 'ok') { Swal.fire({icon: 'success', title: 'Ho√†n t·∫•t', text: data.msg, timer: 2000, showConfirmButton: false}).then(() => location.reload()); } 
                else Swal.fire('L·ªói', data.msg, 'error');
            } catch(e) { Swal.fire('L·ªói m·∫°ng', 'K·∫øt n·ªëi th·∫•t b·∫°i', 'error'); } 
            finally { btn.disabled = false; btn.innerHTML = old; }
        }
    </script>
    {{ template "footer_master" . }}
{{ end }}
