{{ define "master_thanh_vien" }}
    {{ template "header_master" . }}
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>

    <div class="max-w-7xl mx-auto mb-24 sm:mb-10">
        
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-5">
            <div class="flex items-center gap-3">
                <div class="p-2.5 bg-purple-100 text-purple-600 rounded-xl shadow-inner shrink-0">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                </div>
                <h1 class="text-2xl sm:text-3xl font-black tracking-tight text-gradient-animated uppercase">QU·∫¢N L√ù TH√ÄNH VI√äN</h1>
            </div>
            
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full lg:w-auto">
                <div class="relative w-full sm:w-72">
                    <input type="text" id="searchMember" onkeyup="filterTable('searchMember', 'tbodyMembers')" placeholder="T√¨m ID, T√™n, SƒêT, Zalo, Ngu·ªìn..." class="w-full pl-11 pr-4 py-3 text-sm font-medium border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none transition bg-white shadow-sm">
                    <svg class="w-5 h-5 text-slate-400 absolute left-4 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <button onclick="openMessageModal()" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-purple-200 flex items-center justify-center gap-2 transition transform hover:-translate-y-0.5 whitespace-nowrap">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 00-2-2H5a2 2 0 00-2-2v10a2 2 0 002 2z"></path></svg>
                    G·ª≠i Th√¥ng B√°o (<span id="countSelected">0</span>)
                </button>
            </div>
        </div>

        <div class="animated-border-wrapper shadow-xl shadow-purple-200/50">
            <div class="animated-border-inner flex flex-col w-full relative">
                <div class="absolute top-0 right-0 w-[400px] h-[400px] bg-purple-600/15 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none z-0"></div>
                
                <div class="overflow-x-auto w-full relative z-10 table-scroll">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-[10px] sm:text-[11px] text-slate-500 uppercase bg-slate-50/50 border-b border-slate-100">
                            <tr>
                                <th class="px-2 sm:px-5 py-3 sm:py-4 text-center w-8 sm:w-12"><input type="checkbox" id="checkAll" onchange="toggleAllCheckboxes()" class="w-4 h-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500"></th>
                                <th class="px-2 sm:px-4 py-3 sm:py-4 font-black tracking-wider sm:tracking-widest text-slate-700 uppercase">Th√†nh Vi√™n</th>
                                <th class="px-4 py-4 font-black tracking-widest text-slate-700 whitespace-nowrap hidden sm:table-cell uppercase">TH√îNG TIN</th>
                                <th class="px-4 py-4 font-black text-center tracking-widest text-slate-700 w-36 whitespace-nowrap hidden sm:table-cell uppercase">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyMembers" class="divide-y divide-slate-100/80 bg-white/50 backdrop-blur-sm">
                            {{ range .DanhSach }}
                            
                            <tr class="hover-soft-row cursor-pointer transition-colors relative {{ if eq .TrangThai 0 }}row-locked{{ else if eq .TrangThai -1 }}row-deleted{{ end }}" onclick="editMember('{{ .MaKhachHang }}')">
                                
                                <td class="px-2 sm:px-5 py-3 sm:py-4 text-center align-middle" onclick="event.stopPropagation()"><input type="checkbox" value="{{ .MaKhachHang }}" class="chk-member w-4 h-4 text-purple-600 rounded border-purple-200 focus:ring-purple-500 shadow-sm" onchange="updateCount()"></td>
                                
                                <td class="px-2 sm:px-4 py-3 sm:py-4 w-full sm:w-auto align-middle relative">

                                    <div class="grid grid-cols-[auto_1fr] items-center sm:flex sm:items-center gap-x-3 gap-y-2 sm:gap-4 relative z-10 w-full">
                                        
                                        <div class="flex flex-col items-center justify-center gap-2.5 shrink-0">
                                            
                                            <div class="avatar-led-wrap w-11 h-11 sm:w-12 sm:h-12 md:w-14 md:h-14 transition-all duration-300 {{ if eq .TrangThai 1 }}led-active{{ else if eq .TrangThai 0 }}led-locked{{ else }}led-deleted{{ end }}">
                                                {{ $avatar := .AnhDaiDien }}
                                                {{ if not $avatar }} {{ $avatar = print "https://ui-avatars.com/api/?name=" .TenKhachHang "&background=ffffff&color=7e22ce&bold=true" }} {{ end }}
                                                <img src="{{ $avatar }}" onerror="this.src='https://ui-avatars.com/api/?name=99K&background=ffffff&color=7e22ce'" class="w-full h-full object-cover {{ if ne .TrangThai 1 }}grayscale opacity-50{{ end }}">
                                                
                                                {{ if eq .TrangThai 0 }}
                                                <div class="absolute inset-[2.5px] rounded-full bg-slate-900/50 backdrop-blur-[1px] flex items-center justify-center z-20">
                                                    <div class="w-full h-full flex items-center justify-center -rotate-[15deg]">
                                                        <span class="text-[6px] sm:text-[7px] md:text-[8px] font-black text-amber-400 uppercase text-center leading-[1.1] tracking-tighter drop-shadow-md">T·∫°m<br>Kh√≥a</span>
                                                    </div>
                                                </div>
                                                {{ end }}
                                                
                                                {{ if eq .TrangThai -1 }}
                                                <div class="absolute inset-[2.5px] rounded-full bg-slate-900/50 backdrop-blur-[1px] flex items-center justify-center z-20">
                                                    <div class="w-full h-full flex items-center justify-center -rotate-[15deg]">
                                                        <span class="text-[6px] sm:text-[7px] md:text-[8px] font-black text-red-400 uppercase text-center leading-[1.1] tracking-tighter drop-shadow-md">ƒê·ª£i<br>X√≥a</span>
                                                    </div>
                                                </div>
                                                {{ end }}
                                            </div>

                                            <button onclick="event.stopPropagation(); editMember('{{ .MaKhachHang }}')" class="sm:hidden w-full flex items-center justify-center gap-1 bg-white text-purple-600 border border-purple-200 px-2 py-1.5 rounded-lg text-[9px] font-bold shadow-sm active:scale-95">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                                S·ª≠a
                                            </button>
                                        </div>
                                        
                                        <div class="flex flex-col min-w-0 w-full justify-center">
                                            
                                            <div class="relative inline-flex items-center mr-auto max-w-full">
                                                <div class="badge-animated-wrap theme-{{ .StyleTheme }} {{ if lt .StyleLevel 4 }}tier-s{{ else if lt .StyleLevel 7 }}tier-a{{ else if eq .StyleLevel 7 }}tier-b{{ else }}tier-c{{ end }} !mt-0 !mr-0 max-w-full">
                                                    <div class="badge-inner shadow-sm truncate max-w-[150px] sm:max-w-none">{{ .TenKhachHang }}</div>
                                                </div>
                                                <div class="floating-icon {{ if eq .StyleLevel 0 }}icon-lvl-0{{ else if gt .StyleLevel 7 }}icon-lvl-9{{ end }}">
                                                    {{ if eq .StyleLevel 0 }} üëë {{ else if eq .StyleLevel 1 }} ‚ö° {{ else if eq .StyleLevel 2 }} üõ°Ô∏è {{ else if eq .StyleLevel 3 }} ‚≠ê {{ else if eq .StyleLevel 4 }} üéØ {{ else if eq .StyleLevel 5 }} üíº {{ else if eq .StyleLevel 6 }} ‚öñÔ∏è {{ else if eq .StyleLevel 7 }} üöÄ {{ else if eq .StyleLevel 8 }} ü§ù {{ else }} üë§ {{ end }}
                                                </div>
                                            </div>
                                            
                                            <div class="flex flex-wrap items-center gap-1.5 sm:gap-2 mt-1.5 w-full">
                                                
                                                <div class="inline-flex items-center gap-1 bg-purple-50/80 border border-purple-200/50 text-purple-700 px-2 py-0.5 rounded text-[10px] sm:text-[11px] font-bold shadow-sm max-w-full search-target shrink-0">
                                                    <svg class="w-3 h-3 shrink-0 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" /></svg>
                                                    <span class="truncate max-w-[100px] sm:max-w-none">{{ .TenDangNhap }}</span>
                                                </div>
                                                
                                                <div class="flex items-center gap-1.5 shrink-0">
                                                    <span class="hidden sm:inline-block w-1 h-1 sm:w-1.5 sm:h-1.5 rounded-full bg-slate-300 shadow-sm shrink-0"></span>
                                                    <span class="text-[9.5px] sm:text-[10.5px] font-black uppercase tracking-widest text-theme-gradient text-theme-{{ .StyleTheme }} drop-shadow-sm">{{ .ChucVu }}</span>
                                                </div>

                                            </div>

                                            <div class="sm:hidden flex flex-col gap-1.5 mt-2.5 pt-2.5 border-t border-slate-200/60 w-full text-[11px]">
                                                {{ if .DienThoai }}<div class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-emerald-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg> <span class="font-bold text-slate-700 search-target">{{ .DienThoai }}</span></div>{{ end }}
                                                {{ if .Email }}<div class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-rose-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 00-2-2H5a2 2 0 00-2-2v10a2 2 0 002 2z" /></svg> <span class="font-bold text-slate-700 search-target truncate max-w-[180px]">{{ .Email }}</span></div>{{ end }}
                                                {{ if .MangXaHoi.Zalo }}<div class="flex items-center gap-1.5">
                                                    <div class="w-3.5 h-3.5 bg-[#0068ff] rounded-full flex items-center justify-center text-white font-bold text-[8px] shadow-sm shrink-0">Z</div>
                                                    <span class="font-bold text-[#0068ff] search-target">{{ .MangXaHoi.Zalo }}</span>
                                                </div>{{ end }}
                                            </div>
                                        </div>

                                    </div>
                                </td>

                                <td class="hidden sm:table-cell px-4 py-4 text-[12.5px] space-y-2 whitespace-nowrap align-middle relative z-10">
                                    {{ if .DienThoai }}<div class="flex items-center gap-2"><svg class="w-4 h-4 text-emerald-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg> <span class="font-bold text-slate-700 search-target">{{ .DienThoai }}</span></div>{{ end }}
                                    {{ if .Email }}<div class="flex items-center gap-2"><svg class="w-4 h-4 text-rose-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 00-2-2H5a2 2 0 00-2-2v10a2 2 0 002 2z" /></svg> <span class="font-bold text-slate-700 search-target">{{ .Email }}</span></div>{{ end }}
                                    {{ if .MangXaHoi.Zalo }}<div class="flex items-center gap-2">
                                        <div class="w-4 h-4 bg-[#0068ff] rounded-full flex items-center justify-center text-white font-bold text-[9px] shadow-sm shrink-0">Z</div>
                                        <span class="font-bold text-[#0068ff] search-target">{{ .MangXaHoi.Zalo }}</span>
                                    </div>{{ end }}
                                </td>
                                
                                <td class="hidden sm:table-cell px-4 py-4 text-center align-middle relative z-10">
                                    <button onclick="event.stopPropagation(); editMember('{{ .MaKhachHang }}')" class="inline-flex items-center justify-center gap-2 bg-white text-purple-600 hover:bg-purple-600 hover:text-white px-4 py-2.5 rounded-xl text-[12px] font-bold transition-all shadow-sm border border-purple-200 hover:shadow-purple-200 active:scale-95 whitespace-nowrap group-hover:border-purple-600">
                                        <svg class="w-3.5 h-3.5 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                        <span>S·ª≠a</span>
                                    </button>
                                </td>
                            </tr>
                            {{ end }}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="data_members" class="hidden">
        {{ range .DanhSach }}
        <div class="m-data" 
            data-id="{{ .MaKhachHang }}" data-name="{{ .TenKhachHang }}" data-user="{{ .TenDangNhap }}" data-email="{{ .Email }}"
            data-role="{{ .VaiTroQuyenHan }}" data-title="{{ .ChucVu }}" 
            data-phone="{{ .DienThoai }}" data-dob="{{ .NgaySinh }}" data-gender="{{ .GioiTinh }}" 
            data-address="{{ .DiaChi }}" data-tax="{{ .MaSoThue }}" data-status="{{ .TrangThai }}"
            data-zalo="{{ .MangXaHoi.Zalo }}" data-fb="{{ .MangXaHoi.Facebook }}" data-tiktok="{{ .MangXaHoi.Tiktok }}"
            data-note="{{ .GhiChu }}" data-avatar="{{ .AnhDaiDien }}" data-source="{{ .NguonKhachHang }}"
            data-created="{{ .NgayTao }}" data-updater="{{ .NguoiCapNhat }}" data-updated="{{ .NgayCapNhat }}">
        </div>
        {{ end }}
    </div>

    <div id="modalEdit" class="hidden fixed inset-0 bg-slate-900/70 flex items-center justify-center z-50 backdrop-blur-md p-4 sm:p-6">
        <div class="bg-slate-50 rounded-[2rem] shadow-2xl w-full max-w-6xl transform transition-all flex flex-col max-h-[95vh] border border-white/20">
            
            <div class="px-6 sm:px-8 py-5 sm:py-6 border-b border-slate-200 flex justify-between items-center bg-white rounded-t-[2rem] shrink-0">
                <div class="flex items-center gap-3">
                    <span class="bg-purple-100 p-2 sm:p-2.5 rounded-2xl text-purple-600 shadow-inner">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </span>
                    <h3 class="text-xl sm:text-2xl font-black tracking-tight text-gradient-animated" id="modalTitle">H·ªì S∆° & Ph√¢n Quy·ªÅn</h3>
                </div>
                <button onclick="closeModal('modalEdit')" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-500 transition text-xl font-bold">&times;</button>
            </div>
            
            <div class="p-4 sm:p-8 overflow-y-auto custom-scroll relative">
                <form id="formEdit" class="space-y-6" autocomplete="off" spellcheck="false">
                    <input type="hidden" name="ma_khach_hang" id="f_ma">
                    
                    <div class="animated-warning-wrapper mb-6 shadow-md shadow-orange-100/50">
                        <div class="animated-warning-inner p-4 sm:p-5 flex items-start gap-4 bg-orange-50/40 backdrop-blur-sm relative">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-orange-500/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none z-0"></div>
                            <div class="bg-gradient-to-br from-amber-100 to-orange-200 p-2.5 rounded-full text-orange-600 shrink-0 shadow-inner border border-orange-300/50 relative z-10">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            </div>
                            <div class="relative z-10">
                                <h4 class="text-[15px] font-black text-orange-950 mb-1">L∆∞u √Ω qu·∫£n tr·ªã</h4>
                                <p class="text-[13px] text-orange-900/80 leading-relaxed font-medium">
                                    D·ªØ li·ªáu hi·ªÉn th·ªã b√™n d∆∞·ªõi l√† <b class="text-orange-700">h·ªì s∆° th·∫≠t</b> c·ªßa th√†nh vi√™n. M·ªçi ch·ªânh s·ª≠a t·∫°i ƒë√¢y s·∫Ω ƒë∆∞·ª£c l∆∞u tr·ª±c ti·∫øp v√†o c∆° s·ªü d·ªØ li·ªáu v√† l√†m thay ƒë·ªïi th√¥ng tin c√° nh√¢n c·ªßa ng∆∞·ªùi d√πng tr√™n to√†n h·ªá th·ªëng.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 sm:gap-8">
                        <div class="lg:col-span-7">
                            <div class="animated-border-wrapper shadow-lg shadow-purple-100/50 h-full">
                                <div class="animated-border-inner p-6 sm:p-8 relative">
                                    <div class="absolute top-0 right-0 w-48 h-48 bg-purple-600/15 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none z-0"></div>
                                    <h4 class="font-black text-purple-700 border-b border-purple-50 pb-3 mb-6 uppercase tracking-widest text-[11px] flex items-center gap-2 relative z-10">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg> Th√¥ng tin c∆° b·∫£n & Li√™n h·ªá
                                    </h4>
                                    <div class="space-y-6 relative z-10">
                                        <div><label class="form-lbl">H·ªç v√† t√™n <span class="text-red-500">*</span></label><input type="text" name="ten_khach_hang" id="f_ten" class="input-premium font-bold text-slate-900" required></div>
                                        <div><label class="form-lbl">Link ·∫¢nh ƒë·∫°i di·ªán</label><input type="url" name="anh_dai_dien" id="f_avatar" class="input-premium font-mono text-[13px] text-blue-600" placeholder="https://..."></div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                            <div><label class="form-lbl">ƒêi·ªán tho·∫°i</label><input type="tel" id="f_sdt_fake" class="input-premium"></div>
                                            <div><label class="form-lbl">Ng√†y sinh</label><input type="date" name="ngay_sinh" id="f_dob" class="input-premium bg-white"></div>
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                            <div><label class="form-lbl">Gi·ªõi t√≠nh</label><select name="gioi_tinh" id="f_gender" class="input-premium bg-white cursor-pointer"><option value="-1">Kh√°c</option><option value="1">Nam</option><option value="0">N·ªØ</option></select></div>
                                            <div><label class="form-lbl">M√£ s·ªë thu·∫ø</label><input type="text" name="ma_so_thue" id="f_tax" class="input-premium"></div>
                                        </div>
                                        <div><label class="form-lbl">ƒê·ªãa ch·ªâ</label><input type="text" name="dia_chi" id="f_address" class="input-premium" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng x√£..."></div>
                                        <div class="pt-6 border-t border-purple-50">
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                                <div><label class="form-lbl text-blue-600">Zalo (SƒêT)</label><input type="tel" id="f_zalo_fake" class="input-premium"></div>
                                                <div><label class="form-lbl text-emerald-600">Ngu·ªìn kh√°ch h√†ng</label><input type="text" name="nguon_khach_hang" id="f_source" class="input-premium bg-emerald-50/50" placeholder="VD: ƒêƒÉng k√Ω Web..."></div>
                                                <div class="sm:col-span-2"><label class="form-lbl text-blue-600">Link Facebook</label><input type="text" name="facebook" id="f_fb" class="input-premium font-mono text-[13px] text-blue-600" placeholder="https://facebook.com/..."></div>
                                                <div class="sm:col-span-2"><label class="form-lbl text-slate-800">Link Tiktok</label><input type="text" name="tiktok" id="f_tiktok" class="input-premium font-mono text-[13px] text-blue-600" placeholder="https://tiktok.com/@..."></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-5 space-y-6 sm:space-y-8">
                            <div class="animated-border-wrapper shadow-lg shadow-purple-100/50">
                                <div class="animated-border-inner p-6 sm:p-8 relative">
                                    <div class="absolute top-0 right-0 w-48 h-48 bg-purple-600/15 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none z-0"></div>
                                    <h4 class="font-black text-purple-700 border-b border-purple-50 pb-3 uppercase tracking-widest text-[11px] flex items-center gap-2 mb-6 relative z-10">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg> H·ªá th·ªëng & Quy·ªÅn h·∫°n
                                    </h4>
                                    <div class="space-y-6 relative z-10">
                                        <div>
                                            <label class="form-lbl text-purple-900">Vai tr√≤ / Ph√¢n quy·ªÅn <span class="text-red-500">*</span></label>
                                            <select name="vai_tro" id="f_role" class="input-premium bg-purple-50/50 border-purple-200 text-purple-900 font-bold focus:ring-purple-600 cursor-pointer shadow-sm" required>
                                                {{ range .DanhSachVaiTro }}<option value="{{ .MaVaiTro }}">{{ .TenVaiTro }}</option>{{ end }}
                                            </select>
                                        </div>
                                        <div><label class="form-lbl text-purple-900">Ch·ª©c v·ª• hi·ªÉn th·ªã (T√πy ch·ªânh)</label><input type="text" name="chuc_vu" id="f_title" class="input-premium bg-white border-purple-100" placeholder="ƒê·ªÉ tr·ªëng s·∫Ω l·∫•y theo Vai tr√≤..."></div>
                                        <div>
                                            <label class="form-lbl text-purple-900">Tr·∫°ng th√°i t√†i kho·∫£n</label>
                                            <select name="trang_thai" id="f_status" class="input-premium bg-white font-bold cursor-pointer border-purple-100 shadow-sm">
                                                <option value="1" class="text-emerald-600">üü¢ Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng</option>
                                                <option value="0" class="text-amber-600">üü° T·∫°m kh√≥a</option>
                                                <option value="-1" class="text-red-600">üî¥ ƒê·ª£i x√≥a</option>
                                            </select>
                                        </div>

                                        <div id="box_cap_lai_bao_mat" class="pt-6 border-t border-purple-50">
                                            <h4 class="font-black text-orange-600 uppercase tracking-widest text-[10px] flex items-center gap-2 mb-4">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> C·∫•p l·∫°i B·∫£o m·∫≠t
                                            </h4>
                                            <div class="space-y-4">
                                                <div>
                                                    <label class="form-lbl text-orange-800">M·∫≠t kh·∫©u m·ªõi</label>
                                                    <div class="relative">
                                                        <input type="password" name="mat_khau_moi" id="f_pass" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" class="input-premium font-mono pr-10 border-orange-200 bg-orange-50/30" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi...">
                                                        <button type="button" onclick="togglePass('f_pass')" class="absolute inset-y-0 right-0 pr-3.5 flex items-center text-slate-400 hover:text-orange-600"><svg id="eye_slash_f_pass" class="w-5 h-5 block" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg><svg id="eye_open_f_pass" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="form-lbl text-orange-800">M√£ PIN m·ªõi (8 s·ªë)</label>
                                                    <div class="relative">
                                                        <input type="password" name="pin_moi" id="f_pin" maxlength="8" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" class="input-premium font-mono tracking-widest pr-10 border-orange-200 bg-orange-50/30 text-center" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi...">
                                                        <button type="button" onclick="togglePass('f_pin')" class="absolute inset-y-0 right-0 pr-3.5 flex items-center text-slate-400 hover:text-orange-600"><svg id="eye_slash_f_pin" class="w-5 h-5 block" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg><svg id="eye_open_f_pin" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="animated-border-wrapper shadow-lg shadow-purple-100/50">
                                <div class="animated-border-inner p-6 sm:p-8 relative">
                                    <div class="absolute top-0 right-0 w-48 h-48 bg-purple-600/15 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none z-0"></div>
                                    <h4 class="font-black text-purple-600 border-b border-purple-50 pb-3 mb-5 uppercase tracking-widest text-[11px] flex items-center gap-2 relative z-10">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> D·ªØ li·ªáu qu·∫£n tr·ªã
                                    </h4>
                                    <div class="space-y-4 mb-6 text-[13px] font-medium font-mono text-slate-500 relative z-10">
                                        <div class="flex justify-between items-center"><span class="text-slate-400">Ng√†y gia nh·∫≠p:</span> <span id="f_log_created" class="font-bold text-slate-800">--</span></div>
                                        <div class="flex justify-between items-center"><span class="text-slate-400">C·∫≠p nh·∫≠t l√∫c:</span> <span id="f_log_updated" class="font-bold text-slate-800">--</span></div>
                                        <div class="flex justify-between items-center"><span class="text-slate-400">C·∫≠p nh·∫≠t cu·ªëi:</span> <span id="f_log_updater" class="font-bold text-purple-600">--</span></div>
                                    </div>
                                    <div class="pt-5 border-t border-purple-50 relative z-10">
                                        <label class="form-lbl text-slate-500">Ghi ch√∫ n·ªôi b·ªô (Ch·ªâ Admin th·∫•y)</label>
                                        <textarea name="ghi_chu" id="f_note" rows="3" class="w-full bg-white border border-slate-300 rounded-xl p-3 text-sm text-slate-700 focus:border-purple-500 outline-none transition shadow-sm leading-relaxed" placeholder="Ghi ch√∫ v·ªÅ t√†i kho·∫£n n√†y..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="px-6 sm:px-8 py-4 sm:py-5 border-t border-slate-200 bg-white rounded-b-[2rem] flex flex-col sm:flex-row justify-end gap-3 shrink-0 z-20 shadow-[0_-10px_20px_-5px_rgba(0,0,0,0.05)]">
                <button onclick="closeModal('modalEdit')" class="w-full sm:w-auto px-8 py-3 text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-xl font-bold transition">ƒê√≥ng Modal</button>
                <button onclick="saveMember()" id="btnSaveMem" class="w-full sm:w-auto px-10 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-black rounded-xl hover:from-purple-700 hover:to-indigo-700 shadow-xl shadow-purple-600/30 transition transform hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-2 text-[15px]">
                    L∆∞u Thay ƒê·ªïi
                </button>
            </div>
        </div>
    </div>

    <div id="modalMsg" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg transform transition-all overflow-hidden border border-white/20">
            <div class="px-6 sm:px-8 py-5 sm:py-6 border-b flex justify-between items-center bg-gradient-to-r from-purple-600 to-indigo-600">
                <h3 class="text-xl font-black text-white flex items-center gap-2">üì¢ G·ª≠i Th√¥ng B√°o H·ªá Th·ªëng</h3>
                <button onclick="closeModal('modalMsg')" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/20 text-white hover:bg-white/40 transition text-xl font-bold">&times;</button>
            </div>
            <div class="p-6 sm:p-8 space-y-6">
                <div class="bg-purple-50 text-purple-700 p-4 rounded-2xl text-sm font-bold border border-purple-100 flex items-center justify-between shadow-sm"><span>Chu·∫©n b·ªã g·ª≠i ƒë·∫øn:</span><span id="lblMsgCount" class="font-black text-purple-700 text-2xl bg-white px-4 py-1 rounded-xl shadow-sm border border-purple-200">0</span></div>
                <div><label class="form-lbl">Ti√™u ƒë·ªÅ tin nh·∫Øn <span class="text-red-500">*</span></label><input type="text" id="msgTitle" class="input-premium font-bold text-slate-800" placeholder="VD: Th√¥ng b√°o c·∫≠p nh·∫≠t..." required autocomplete="off" spellcheck="false"></div>
                <div><label class="form-lbl">N·ªôi dung chi ti·∫øt <span class="text-red-500">*</span></label><textarea id="msgContent" rows="6" class="input-premium leading-relaxed" placeholder="Nh·∫≠p n·ªôi dung chi ti·∫øt..." required autocomplete="off" spellcheck="false"></textarea></div>
                
                {{ if lt .NhanVien.StyleLevel 3 }}
                <div class="flex items-center gap-3 bg-slate-50 p-4 rounded-xl border border-slate-200 hover:border-purple-300 transition">
                    <input type="checkbox" id="chkSendAsBot" class="w-5 h-5 text-purple-600 rounded border-gray-300 focus:ring-purple-500 cursor-pointer">
                    <label for="chkSendAsBot" class="text-[13px] font-bold text-slate-700 cursor-pointer select-none">G·ª≠i d∆∞·ªõi danh nghƒ©a Tr·ª£ l√Ω ·∫£o (H·ªá th·ªëng)</label>
                </div>
                {{ end }}
            </div>
            <div class="px-6 sm:px-8 py-4 sm:py-5 border-t bg-slate-50 flex flex-col sm:flex-row justify-end gap-3 rounded-b-[2rem]">
                <button onclick="closeModal('modalMsg')" class="w-full sm:w-auto px-6 py-3 text-slate-600 bg-white border border-slate-300 hover:bg-slate-100 rounded-xl font-bold transition">H·ªßy</button>
                <button onclick="sendMessages()" id="btnSendMsg" class="w-full sm:w-auto px-8 py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">Ph√°t s√≥ng</button>
            </div>
        </div>
    </div>

    <script>
        const currentUserID = "{{ .NhanVien.MaKhachHang }}"; 
        const isMeRoot = (currentUserID === "0000000000000000001");
        const myLevel = {{ .NhanVien.StyleLevel }};
        let itiPhone, itiZalo;

        function togglePass(id) {
            const input = document.getElementById(id);
            const eyeSlash = document.getElementById('eye_slash_' + id);
            const eyeOpen = document.getElementById('eye_open_' + id);
            if (input.type === "password") { input.type = "text"; eyeSlash.classList.add('hidden'); eyeOpen.classList.remove('hidden'); } 
            else { input.type = "password"; eyeOpen.classList.add('hidden'); eyeSlash.classList.remove('hidden'); }
        }

        window.toggleSwalPin = function() {
            const input = document.getElementById('swal-pin-input');
            const eyeSlash = document.getElementById('eye_slash_swal');
            const eyeOpen = document.getElementById('eye_open_swal');
            if (input.type === "password") { input.type = "text"; eyeSlash.classList.add('hidden'); eyeOpen.classList.remove('hidden'); } 
            else { input.type = "password"; eyeOpen.classList.add('hidden'); eyeSlash.classList.remove('hidden'); }
        };

        const mapData = {};
        document.querySelectorAll('.m-data').forEach(el => {
            let id = el.getAttribute('data-id');
            mapData[id] = {
                id: id, ten: el.getAttribute('data-name'), user: el.getAttribute('data-user'), email: el.getAttribute('data-email'),
                role: el.getAttribute('data-role'), title: el.getAttribute('data-title'),
                sdt: el.getAttribute('data-phone'), dob: el.getAttribute('data-dob'), gender: el.getAttribute('data-gender'),
                address: el.getAttribute('data-address'), tax: el.getAttribute('data-tax'), status: el.getAttribute('data-status'),
                zalo: el.getAttribute('data-zalo'), fb: el.getAttribute('data-fb'), tiktok: el.getAttribute('data-tiktok'), note: el.getAttribute('data-note'),
                avatar: el.getAttribute('data-avatar'), source: el.getAttribute('data-source'),
                created: el.getAttribute('data-created'), updater: el.getAttribute('data-updater'), updated: el.getAttribute('data-updated')
            };
        });

        function filterTable(inputId, tbodyId) { 
            const query = document.getElementById(inputId).value.toLowerCase().trim(); 
            const removeAccents = (str) => str ? str.normalize('NFD').replace(/[\u0300-\u036f]/g, '') : '';
            const queryClean = removeAccents(query);

            document.querySelectorAll(`#${tbodyId} tr.hover-soft-row`).forEach(row => { 
                const cb = row.querySelector('.chk-member');
                if (!cb) return;
                const data = mapData[cb.value];
                if (!data) return;

                let statusText = "khoa tam khoa";
                if(data.status == 1) statusText = "hoat dong"; else if (data.status == -1) statusText = "doi xoa";

                const combinedString = `${data.id} ${data.ten} ${data.user} ${data.email} ${data.role} ${data.title} ${data.sdt} ${data.dob} ${data.address} ${data.tax} ${data.zalo} ${data.fb} ${data.tiktok} ${data.source} ${data.note} ${statusText}`.toLowerCase();
                if (removeAccents(combinedString).includes(queryClean)) { row.style.display = ''; } else { row.style.display = 'none'; }
            }); 
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function editMember(ma) {
            let data = mapData[ma]; if(!data) return;
            document.getElementById('formEdit').reset();
            document.getElementById('f_pass').setAttribute('readonly', 'true'); document.getElementById('f_pin').setAttribute('readonly', 'true');
            
            const inputPhone = document.querySelector("#f_sdt_fake"); const inputZalo = document.querySelector("#f_zalo_fake"); 
            if (!itiPhone) itiPhone = window.intlTelInput(inputPhone, { initialCountry: "vn", separateDialCode: true, utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js" });
            if (!itiZalo) itiZalo = window.intlTelInput(inputZalo, { initialCountry: "vn", separateDialCode: true, utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js" });
            
            document.getElementById('f_ma').value = ma; document.getElementById('f_ten').value = data.ten;
            itiPhone.setNumber(data.sdt || ""); itiZalo.setNumber(data.zalo || ""); 
            document.getElementById('f_dob').value = data.dob; document.getElementById('f_gender').value = data.gender;
            document.getElementById('f_tax').value = data.tax; document.getElementById('f_address').value = data.address;
            document.getElementById('f_title').value = data.title; document.getElementById('f_avatar').value = data.avatar; 
            document.getElementById('f_source').value = data.source; document.getElementById('f_fb').value = data.fb; 
            document.getElementById('f_tiktok').value = data.tiktok; document.getElementById('f_note').value = data.note; 
            document.getElementById('f_log_created').innerText = data.created || "--"; document.getElementById('f_log_updated').innerText = data.updated || "--"; document.getElementById('f_log_updater').innerText = data.updater || "H·ªá Th·ªëng";

            const isSystemBot = (ma === "0000000000000000000");
            const boxBaoMat = document.getElementById('box_cap_lai_bao_mat');
            if (isSystemBot) { boxBaoMat.classList.add('hidden'); } else { boxBaoMat.classList.remove('hidden'); }

            let roleSelect = document.getElementById('f_role');
            let statusSelect = document.getElementById('f_status');

            Array.from(roleSelect.options).forEach(opt => {
                if (opt.value === "quan_tri_he_thong") {
                    opt.disabled = (ma !== "0000000000000000001");
                } else { opt.disabled = false; }
            });

            roleSelect.value = data.role; statusSelect.value = data.status;
            roleSelect.disabled = false; statusSelect.disabled = false;

            if (ma === "0000000000000000001" && currentUserID !== "0000000000000000001") { roleSelect.disabled = true; statusSelect.disabled = true; } 
            if (ma === currentUserID) { statusSelect.disabled = true; }

            document.getElementById('modalEdit').classList.remove('hidden');
        }

        async function saveMember() {
            const { value: pinXacNhan } = await Swal.fire({
                title: '<div class="flex flex-col items-center gap-3"><div class="w-14 h-14 bg-gradient-to-br from-purple-100 to-indigo-100 text-purple-600 rounded-full flex items-center justify-center shadow-inner border border-purple-200"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></div><span class="text-2xl font-black tracking-tight text-gradient-animated">B·∫£o m·∫≠t 2 l·ªõp</span></div>',
                customClass: { popup: 'swal-animated-purple', confirmButton: 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold rounded-xl px-8 py-3 shadow-lg shadow-purple-200 transition transform hover:-translate-y-0.5 active:scale-95', cancelButton: 'bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold rounded-xl px-8 py-3 transition active:scale-95 border border-slate-200' },
                buttonsStyling: false, 
                html: `
                    <div class="text-[14px] text-slate-500 mb-8 font-medium leading-relaxed">H·ªá th·ªëng y√™u c·∫ßu x√°c minh danh t√≠nh.<br>Vui l√≤ng nh·∫≠p <b class="text-purple-700">M√£ PIN</b> c·ªßa b·∫°n.</div>
                    <div class="relative w-full max-w-[280px] mx-auto group">
                        <div class="absolute inset-0 bg-purple-500/20 blur-xl rounded-full opacity-0 group-focus-within:opacity-100 transition duration-500 pointer-events-none"></div>
                        <input type="password" id="swal-pin-input" class="relative w-full box-border bg-white border-2 border-slate-200 rounded-2xl py-4 px-4 text-center tracking-[0.25em] font-black text-2xl text-slate-800 outline-none transition-all duration-300 focus:border-purple-500 focus:shadow-[0_0_0_4px_rgba(147,51,234,0.1)] placeholder-slate-300" maxlength="8" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" oninput="this.value = this.value.replace(/[^0-9]/g, ''); this.classList.remove('pin-error'); document.getElementById('swal-custom-err').classList.add('hidden'); checkPinLength(this);">
                        <button type="button" onclick="toggleSwalPin()" class="absolute inset-y-0 right-2 w-10 flex items-center justify-center text-slate-400 hover:text-purple-600 transition z-10 bg-white my-1 rounded-xl"><svg id="eye_slash_swal" class="w-6 h-6 block" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg><svg id="eye_open_swal" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                    </div>
                    <div id="swal-custom-err" class="hidden text-red-500 bg-red-50 border border-red-100 rounded-xl px-4 py-2 text-[13px] font-bold mt-4 flex items-center justify-center gap-1.5 w-full max-w-[280px] mx-auto shadow-sm"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg> Vui l√≤ng nh·∫≠p ƒë·ªß 8 s·ªë!</div>
                `,
                showCancelButton: true, confirmButtonText: 'X√°c nh·∫≠n L∆∞u', cancelButtonText: 'H·ªßy b·ªè', reverseButtons: true, 
                didOpen: () => { setTimeout(() => { const input = document.getElementById('swal-pin-input'); input.removeAttribute('readonly'); input.focus(); }, 100); },
                preConfirm: () => { 
                    const input = document.getElementById('swal-pin-input'); const errBox = document.getElementById('swal-custom-err'); const val = input.value; 
                    if (val.length < 8) { input.classList.add('pin-error'); errBox.classList.remove('hidden'); errBox.classList.add('animate-bounce'); setTimeout(() => errBox.classList.remove('animate-bounce'), 1000); return false; } 
                    return val; 
                }
            });

            if (!pinXacNhan) { return; }

            // HI·ªÜU ·ª®NG LED SPINNER N√öT B·∫§M (KH√ìA N√öT)
            const btn = document.getElementById('btnSaveMem'); const old = btn.innerHTML;
            btn.disabled = true; btn.classList.add('opacity-80', 'cursor-not-allowed');
            btn.innerHTML = '<div class="flex items-center justify-center gap-2.5"><div class="spinner-led-btn"></div> ƒêang x·ª≠ l√Ω...</div>';
            
            const fd = new FormData(document.getElementById('formEdit'));
            fd.append('pin_xac_nhan', pinXacNhan);
            if (itiPhone) fd.set('dien_thoai', itiPhone.getNumber());
            if (itiZalo) fd.set('zalo', itiZalo.getNumber());
            if(document.getElementById('f_role').disabled) { fd.append('vai_tro', mapData[document.getElementById('f_ma').value].role); }
            if(document.getElementById('f_status').disabled) { fd.append('trang_thai', mapData[document.getElementById('f_ma').value].status); }

            try {
                const res = await fetch('/master/api/thanh-vien/save', { method: 'POST', body: fd });
                const data = await res.json();
                if(data.status === 'ok') {
                    // MODAL LED TH√ÄNH C√îNG
                    Swal.fire({
                        title: '<div class="flex flex-col items-center gap-3"><div class="w-16 h-16 bg-gradient-to-br from-emerald-100 to-teal-100 text-emerald-600 rounded-full flex items-center justify-center shadow-inner border border-emerald-200"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><span class="text-2xl font-black text-emerald-600">Th√†nh C√¥ng</span></div>',
                        html: `<div class="text-[14px] text-slate-500 font-medium px-4">${data.msg}</div>`,
                        customClass: { popup: 'swal-animated-emerald' },
                        showConfirmButton: false, timer: 1500
                    }).then(() => location.reload());
                } else {
                    // MODAL LED TH·∫§T B·∫†I
                    Swal.fire({
                        title: '<div class="flex flex-col items-center gap-3"><div class="w-16 h-16 bg-gradient-to-br from-red-100 to-rose-100 text-red-600 rounded-full flex items-center justify-center shadow-inner border border-red-200"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></div><span class="text-2xl font-black text-red-600">L·ªói B·∫£o M·∫≠t</span></div>',
                        html: `<div class="text-[14px] text-slate-500 font-medium px-4">${data.msg}</div>`,
                        customClass: { popup: 'swal-animated-red', confirmButton: 'bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-700 hover:to-rose-700 text-white font-bold rounded-xl px-8 py-3 shadow-lg shadow-red-200 transition transform hover:-translate-y-0.5 active:scale-95' },
                        buttonsStyling: false, confirmButtonText: 'ƒê√≥ng l·∫°i'
                    }); 
                }
            } catch(e) { 
                Swal.fire({
                    title: '<div class="flex flex-col items-center gap-3"><div class="w-16 h-16 bg-gradient-to-br from-red-100 to-rose-100 text-red-600 rounded-full flex items-center justify-center shadow-inner border border-red-200"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></div><span class="text-2xl font-black text-red-600">L·ªói K·∫øt N·ªëi</span></div>',
                    html: `<div class="text-[14px] text-slate-500 font-medium px-4">ƒê∆∞·ªùng truy·ªÅn ƒë·∫øn m√°y ch·ªß b·ªã gi√°n ƒëo·∫°n!</div>`,
                    customClass: { popup: 'swal-animated-red', confirmButton: 'bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-700 hover:to-rose-700 text-white font-bold rounded-xl px-8 py-3 shadow-lg shadow-red-200 transition transform hover:-translate-y-0.5 active:scale-95' },
                    buttonsStyling: false, confirmButtonText: 'ƒê√≥ng l·∫°i'
                }); 
            } 
            finally { btn.disabled = false; btn.innerHTML = old; btn.classList.remove('opacity-80', 'cursor-not-allowed'); }
        }

        async function sendMessages() {
            let title = document.getElementById('msgTitle').value.trim(); let content = document.getElementById('msgContent').value.trim(); let ids = getSelectedIDs();
            let chkBot = document.getElementById('chkSendAsBot'); let sendAsBot = (chkBot && chkBot.checked) ? "1" : "0";
            if (!title || !content) { Swal.fire('L·ªói', 'Ti√™u ƒë·ªÅ v√† n·ªôi dung kh√¥ng ƒë∆∞·ª£c tr·ªëng!', 'error'); return; }
            
            // HI·ªÜU ·ª®NG LED SPINNER N√öT B·∫§M (KH√ìA N√öT)
            const btn = document.getElementById('btnSendMsg'); const old = btn.innerHTML; 
            btn.disabled = true; btn.classList.add('opacity-80', 'cursor-not-allowed');
            btn.innerHTML = '<div class="flex items-center justify-center gap-2.5"><div class="spinner-led-btn"></div> ƒêang ph√°t s√≥ng...</div>';
            
            const fd = new FormData(); fd.append('tieu_de', title); fd.append('noi_dung', content); fd.append('danh_sach_id', JSON.stringify(ids)); fd.append('send_as_bot', sendAsBot);

            try {
                const res = await fetch('/master/api/thanh-vien/send-msg', { method: 'POST', body: fd });
                const data = await res.json();
                if(data.status === 'ok') { 
                    // MODAL LED TH√ÄNH C√îNG
                    Swal.fire({
                        title: '<div class="flex flex-col items-center gap-3"><div class="w-16 h-16 bg-gradient-to-br from-emerald-100 to-teal-100 text-emerald-600 rounded-full flex items-center justify-center shadow-inner border border-emerald-200"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><span class="text-2xl font-black text-emerald-600">ƒê√£ Ph√°t S√≥ng</span></div>',
                        html: `<div class="text-[14px] text-slate-500 font-medium px-4">${data.msg}</div>`,
                        customClass: { popup: 'swal-animated-emerald' },
                        showConfirmButton: false, timer: 2000
                    }).then(() => location.reload()); 
                } 
                else {
                    // MODAL LED TH·∫§T B·∫†I
                    Swal.fire({
                        title: '<div class="flex flex-col items-center gap-3"><div class="w-16 h-16 bg-gradient-to-br from-red-100 to-rose-100 text-red-600 rounded-full flex items-center justify-center shadow-inner border border-red-200"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></div><span class="text-2xl font-black text-red-600">L·ªói H·ªá Th·ªëng</span></div>',
                        html: `<div class="text-[14px] text-slate-500 font-medium px-4">${data.msg}</div>`,
                        customClass: { popup: 'swal-animated-red', confirmButton: 'bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-700 hover:to-rose-700 text-white font-bold rounded-xl px-8 py-3 shadow-lg shadow-red-200 transition transform hover:-translate-y-0.5 active:scale-95' },
                        buttonsStyling: false, confirmButtonText: 'ƒê√≥ng l·∫°i'
                    });
                }
            } catch(e) { 
                Swal.fire({
                    title: '<div class="flex flex-col items-center gap-3"><div class="w-16 h-16 bg-gradient-to-br from-red-100 to-rose-100 text-red-600 rounded-full flex items-center justify-center shadow-inner border border-red-200"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></div><span class="text-2xl font-black text-red-600">L·ªói K·∫øt N·ªëi</span></div>',
                    html: `<div class="text-[14px] text-slate-500 font-medium px-4">ƒê∆∞·ªùng truy·ªÅn ƒë·∫øn m√°y ch·ªß b·ªã gi√°n ƒëo·∫°n!</div>`,
                    customClass: { popup: 'swal-animated-red', confirmButton: 'bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-700 hover:to-rose-700 text-white font-bold rounded-xl px-8 py-3 shadow-lg shadow-red-200 transition transform hover:-translate-y-0.5 active:scale-95' },
                    buttonsStyling: false, confirmButtonText: 'ƒê√≥ng l·∫°i'
                }); 
            } 
            finally { btn.disabled = false; btn.innerHTML = old; btn.classList.remove('opacity-80', 'cursor-not-allowed'); }
        }
        
        function getSelectedIDs() { let ids = []; document.querySelectorAll('.chk-member:checked').forEach(cb => ids.push(cb.value)); return ids; }
        function toggleAllCheckboxes() { let isChecked = document.getElementById('checkAll').checked; document.querySelectorAll('.chk-member').forEach(cb => cb.checked = isChecked); updateCount(); }
        function updateCount() { let count = document.querySelectorAll('.chk-member:checked').length; document.getElementById('countSelected').innerText = count; document.getElementById('lblMsgCount').innerText = count; }
        function openMessageModal() { let count = getSelectedIDs().length; if (count === 0) { Swal.fire('Oops!', 'Vui l√≤ng t√≠ch ch·ªçn √≠t nh·∫•t 1 ng∆∞·ªùi nh·∫≠n ·ªü b·∫£ng danh s√°ch.', 'warning'); return; } document.getElementById('msgTitle').value = ""; document.getElementById('msgContent').value = ""; updateCount(); document.getElementById('modalMsg').classList.remove('hidden'); }
    </script>
    {{ template "footer_master" . }}
{{ end }}
