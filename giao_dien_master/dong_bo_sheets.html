{{ define "master_dong_bo_sheets" }}
    {{ template "header_master" . }}

    <div class="max-w-4xl mx-auto py-8 mb-24 sm:mb-10">
        
        <div class="flex items-center gap-4 mb-8">
            <div class="p-3 bg-purple-100 text-purple-600 rounded-[1rem] shadow-inner shrink-0">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </div>
            <div>
                <h1 class="text-2xl sm:text-3xl font-black tracking-tight text-gradient-animated uppercase">ĐỒNG BỘ DỮ LIỆU LÕI</h1>
                <p class="text-slate-500 mt-1 font-medium text-sm">Làm mới bộ nhớ đệm (RAM) toàn bộ Nền tảng từ Google Sheets.</p>
            </div>
        </div>

        <div class="animated-border-wrapper shadow-2xl shadow-purple-200/50">
            <div class="animated-border-inner p-8 sm:p-10 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-purple-600/10 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none z-0"></div>
                
                <div class="relative z-10">
                    <div id="boxWarning" class="animated-warning-wrapper mb-8 shadow-md shadow-orange-100/50 transition-all duration-500">
                        <div class="animated-warning-inner p-6 flex items-start gap-5 bg-orange-50/40 backdrop-blur-sm relative">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-orange-500/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none z-0"></div>
                            <div class="bg-gradient-to-br from-amber-100 to-orange-200 p-3.5 rounded-[1rem] text-orange-600 shrink-0 shadow-inner border border-orange-300/50 relative z-10">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            </div>
                            <div class="relative z-10">
                                <h3 class="font-black text-orange-950 text-lg mb-2 tracking-tight">Cảnh báo tác động hệ thống!</h3>
                                <ul class="list-disc list-inside text-[13px] sm:text-sm text-orange-900/80 space-y-2.5 leading-relaxed font-medium">
                                    <li>Tính năng này sẽ <b>tải lại toàn bộ dữ liệu</b> (Khách hàng, Phân quyền, Cấu hình, Tin nhắn...) từ Sheet Master.</li>
                                    <li>Chỉ sử dụng khi bạn vừa can thiệp sửa/xóa dữ liệu trực tiếp trên file Excel.</li>
                                    <li>Yêu cầu <b>Mã PIN Bảo mật 2 lớp</b> để thực thi.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="boxSuccess" class="hidden relative rounded-[1.25rem] p-[2px] overflow-hidden mb-8 transition-all duration-500 shadow-md shadow-emerald-100/50">
                        <div class="absolute inset-[-50%] w-[200%] h-[200%] animate-[spin-slow_3s_linear_infinite] bg-[conic-gradient(transparent,transparent,transparent,#10b981,#059669,transparent)] z-0 pointer-events-none"></div>
                        <div class="relative bg-white rounded-[calc(1.25rem-2px)] p-6 flex items-start gap-5 z-10 h-full overflow-hidden bg-emerald-50/40 backdrop-blur-sm">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none z-0"></div>
                            <div class="bg-gradient-to-br from-emerald-100 to-green-200 p-3.5 rounded-[1rem] text-emerald-600 shrink-0 shadow-inner border border-emerald-300/50 relative z-10">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                            <div class="relative z-10">
                                <h3 class="font-black text-emerald-950 text-lg mb-1 tracking-tight">Đồng bộ hoàn tất!</h3>
                                <p class="text-[13px] sm:text-sm text-emerald-800/90 leading-relaxed font-medium mt-2">Hệ thống đã nạp thành công dữ liệu mới nhất từ Google Sheets lên RAM. Nền tảng đang hoạt động với trạng thái tối ưu nhất.</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col items-center border-t border-purple-50 pt-10 mt-2">
                        <button id="btnActionReload" onclick="xacNhanDongBo()" class="px-10 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-2xl shadow-xl shadow-purple-600/30 transition transform hover:-translate-y-1 hover:from-purple-700 hover:to-indigo-700 flex items-center gap-3 min-w-[320px] justify-center active:scale-95 group disabled:opacity-80 disabled:cursor-not-allowed disabled:hover:transform-none disabled:hover:shadow-none">
                            <svg class="w-6 h-6 shrink-0 group-hover:rotate-180 transition duration-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            <span class="font-black text-lg tracking-widest uppercase">Đồng Bộ Master</span>
                        </button>
                        <p id="txtCooldown" class="text-sm font-bold text-slate-400 mt-5 hidden tracking-wide"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {{/* Bắt đầu phần script cũ của bạn ... */}}
    <script>
        function toggleSwalPin() {
            const input = document.getElementById('swal-pin-input');
            const eyeSlash = document.getElementById('eye_slash_swal'); const eyeOpen = document.getElementById('eye_open_swal');
            if (input.type === "password") { input.type = "text"; eyeSlash.classList.add('hidden'); eyeOpen.classList.remove('hidden'); } 
            else { input.type = "password"; eyeOpen.classList.add('hidden'); eyeSlash.classList.remove('hidden'); }
        }

        window.checkPinLength = function(input) {
            if (input.value.length === 8) {
                input.classList.remove('border-purple-500', 'focus:border-purple-500', 'focus:shadow-[0_0_0_4px_rgba(147,51,234,0.1)]');
                input.classList.add('border-emerald-500', 'focus:border-emerald-500', 'text-emerald-600', 'focus:shadow-[0_0_0_4px_rgba(16,185,129,0.1)]');
                input.style.transform = 'scale(1.03)'; setTimeout(() => input.style.transform = 'scale(1)', 150);
            } else {
                input.classList.remove('border-emerald-500', 'focus:border-emerald-500', 'text-emerald-600', 'focus:shadow-[0_0_0_4px_rgba(16,185,129,0.1)]');
                input.classList.add('border-purple-500', 'focus:border-purple-500', 'text-slate-800', 'focus:shadow-[0_0_0_4px_rgba(147,51,234,0.1)]');
            }
        }

        function checkCooldown() {
            const btn = document.getElementById('btnActionReload');
            const txt = document.getElementById('txtCooldown');
            const boxWarning = document.getElementById('boxWarning');
            const boxSuccess = document.getElementById('boxSuccess');

            const last = localStorage.getItem('master_reload_time');
            if (last) {
                const elapsed = Math.floor((Date.now() - parseInt(last)) / 1000);
                if (elapsed < 60) {
                    boxWarning.classList.add('hidden'); boxSuccess.classList.remove('hidden');
                    btn.disabled = true; txt.classList.remove('hidden');
                    
                    let timeLeft = 60 - elapsed;
                    const timer = setInterval(() => {
                        timeLeft--; txt.innerText = `Vui lòng đợi ${timeLeft}s để thao tác tiếp`;
                        if (timeLeft <= 0) {
                            clearInterval(timer);
                            btn.disabled = false; txt.classList.add('hidden');
                            boxSuccess.classList.add('hidden'); boxWarning.classList.remove('hidden');
                        }
                    }, 1000);
                    return true;
                }
            }
            return false;
        }
        checkCooldown();

        async function xacNhanDongBo() {
            if (checkCooldown()) return;

            const { value: pinXacNhan } = await Swal.fire({
                title: '<div class="flex flex-col items-center gap-3"><div class="w-14 h-14 bg-gradient-to-br from-purple-100 to-indigo-100 text-purple-600 rounded-full flex items-center justify-center shadow-inner border border-purple-200"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></div><span class="text-2xl font-black tracking-tight text-gradient-animated">Bảo mật 2 lớp</span></div>',
                customClass: { popup: 'swal-master-success', confirmButton: 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold rounded-xl px-8 py-3 shadow-lg shadow-purple-200 transition transform hover:-translate-y-0.5 active:scale-95', cancelButton: 'bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold rounded-xl px-8 py-3 transition active:scale-95 border border-slate-200' },
                buttonsStyling: false, 
                html: `
                    <div class="text-[14px] text-slate-600 mb-8 font-medium leading-relaxed">Hệ thống yêu cầu xác minh danh tính.<br>Vui lòng nhập <b class="text-purple-700">Mã PIN</b> của bạn.</div>
                    <div class="relative w-full max-w-[280px] mx-auto group">
                        <div class="absolute inset-0 bg-purple-500/20 blur-xl rounded-full opacity-0 group-focus-within:opacity-100 transition duration-500 pointer-events-none"></div>
                        <input type="password" id="swal-pin-input" class="relative w-full box-border bg-white border-2 border-slate-200 rounded-2xl py-4 px-4 text-center tracking-[0.25em] font-black text-2xl text-slate-800 outline-none transition-all duration-300 focus:border-purple-500 focus:shadow-[0_0_0_4px_rgba(147,51,234,0.1)] placeholder-slate-300" maxlength="8" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" placeholder="••••••••" oninput="this.value = this.value.replace(/[^0-9]/g, ''); this.classList.remove('pin-error'); document.getElementById('swal-custom-err').classList.add('hidden'); checkPinLength(this);">
                        <button type="button" onclick="toggleSwalPin()" class="absolute inset-y-0 right-2 w-10 flex items-center justify-center text-slate-400 hover:text-purple-600 transition z-10 bg-white my-1 rounded-xl"><svg id="eye_slash_swal" class="w-6 h-6 block" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg><svg id="eye_open_swal" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                    </div>
                    <div id="swal-custom-err" class="hidden text-red-500 bg-red-50 border border-red-100 rounded-xl px-4 py-2 text-[13px] font-bold mt-4 flex items-center justify-center gap-1.5 w-full max-w-[280px] mx-auto shadow-sm"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg> Vui lòng nhập đủ 8 số!</div>
                `,
                showCancelButton: true, confirmButtonText: 'Xác nhận Lưu', cancelButtonText: 'Hủy bỏ', reverseButtons: true, 
                didOpen: () => { setTimeout(() => { const input = document.getElementById('swal-pin-input'); input.removeAttribute('readonly'); input.focus(); }, 100); },
                preConfirm: () => { 
                    const input = document.getElementById('swal-pin-input'); const errBox = document.getElementById('swal-custom-err'); const val = input.value; 
                    if (val.length < 8) { input.classList.add('pin-error'); errBox.classList.remove('hidden'); errBox.classList.add('animate-bounce'); setTimeout(() => errBox.classList.remove('animate-bounce'), 1000); return false; } 
                    return val; 
                }
            });

            if (pinXacNhan) {
                const btn = document.getElementById('btnActionReload'); const old = btn.innerHTML;
                btn.disabled = true; btn.classList.add('opacity-80', 'cursor-not-allowed');
                btn.innerHTML = '<div class="flex items-center justify-center gap-2.5"><div class="spinner-led-btn"></div> Đang đồng bộ...</div>';

                const fd = new FormData(); fd.append('pin_xac_nhan', pinXacNhan);
                try {
                    const r = await fetch('/master/api/dong-bo-sheets', {method: 'POST', body: fd});
                    const res = await r.json();
                    if (res.status === 'ok') {
                        localStorage.setItem('master_reload_time', Date.now().toString());
                        Swal.fire({
                            title: '<div class="flex flex-col items-center gap-3"><div class="w-16 h-16 bg-gradient-to-br from-purple-100 to-indigo-100 text-purple-600 rounded-full flex items-center justify-center shadow-inner border border-purple-200"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><span class="text-3xl font-black title-gradient-purple">Hoàn Tất</span></div>',
                            html: `<div class="text-[15px] text-slate-600 font-medium px-4">${res.msg}</div>`,
                            customClass: { popup: 'swal-master-success' },
                            showConfirmButton: false, timer: 1500
                        }).then(() => location.reload());
                    } else {
                        Swal.fire({
                            title: '<div class="flex flex-col items-center gap-3"><div class="w-16 h-16 bg-gradient-to-br from-red-100 to-orange-100 text-orange-600 rounded-full flex items-center justify-center shadow-inner border border-orange-200"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></div><span class="text-3xl font-black title-gradient-red">Lỗi Bảo Mật</span></div>',
                            html: `<div class="text-[15px] text-orange-900 font-medium px-4">${res.msg}</div>`,
                            customClass: { popup: 'swal-master-error', confirmButton: 'bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold rounded-xl px-8 py-3 shadow-lg shadow-orange-200 transition transform hover:-translate-y-0.5 active:scale-95' },
                            buttonsStyling: false, confirmButtonText: 'Đã hiểu'
                        }); 
                    }
                } catch(e) {
                    Swal.fire({
                        title: '<div class="flex flex-col items-center gap-3"><div class="w-16 h-16 bg-gradient-to-br from-red-100 to-orange-100 text-orange-600 rounded-full flex items-center justify-center shadow-inner border border-orange-200"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></div><span class="text-3xl font-black title-gradient-red">Lỗi Kết Nối</span></div>',
                        html: `<div class="text-[15px] text-orange-900 font-medium px-4">Không thể kết nối đến máy chủ!</div>`,
                        customClass: { popup: 'swal-master-error', confirmButton: 'bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold rounded-xl px-8 py-3 shadow-lg shadow-orange-200 transition transform hover:-translate-y-0.5 active:scale-95' },
                        buttonsStyling: false, confirmButtonText: 'Đóng lại'
                    }); 
                } finally {
                    btn.disabled = false; btn.innerHTML = old; btn.classList.remove('opacity-80', 'cursor-not-allowed');
                }
            }
        }
    </script>
    {{ template "footer_master" . }}
{{ end }}
