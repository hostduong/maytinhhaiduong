{{ define "master_nhap_hang" }}
    {{ template "header_master" . }}

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        /* Tùy chỉnh giao diện Select2 cho khớp với input-premium */
        .select2-container--default .select2-selection--single {
            height: auto; padding: 0.6rem 1rem; border-radius: 0.75rem; border: 1.5px solid #cbd5e1; outline: none; transition: all 0.25s ease;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 1.5; color: #1e293b; font-weight: 600; padding-left: 0; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 100%; top: 0; right: 0.5rem; }
        .select2-container--default.select2-container--open .select2-selection--single { border-color: #9333ea; box-shadow: 0 0 0 4px rgba(147,51,234,0.15); }
        .select2-dropdown { border: 1.5px solid #d8b4fe; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .select2-results__option--highlighted[aria-selected] { background-color: #f3e8ff !important; color: #7e22ce !important; font-weight: bold; }
        
        /* Input dạng Bảng (Table cell input) */
        .cell-input { width: 100%; background: transparent; border: none; outline: none; text-align: right; font-weight: 600; color: #334155; padding: 0.5rem; transition: background 0.2s; }
        .cell-input:focus { background: #faf5ff; box-shadow: inset 0 0 0 2px #d8b4fe; border-radius: 6px; }
        .cell-input.text-left { text-align: left; }
    </style>

    <div class="max-w-7xl mx-auto pb-6 mb-24 sm:mb-10">
        
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h2 class="text-2xl font-black text-slate-800 tracking-tight">Tạo Phiếu Nhập Mới</h2>
                <p class="text-sm text-slate-500 font-medium mt-1">Mã phiếu tự động sinh: <span class="text-purple-600 font-mono font-bold bg-purple-50 px-2 py-0.5 rounded">PN_AUTO</span></p>
            </div>
            <div class="flex gap-3">
                <button type="button" class="px-5 py-2.5 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-slate-800 rounded-xl font-bold transition shadow-sm">
                    Lưu Nháp
                </button>
                <button type="button" onclick="hoanThanhPhieu()" class="px-6 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:from-purple-700 hover:to-indigo-700 rounded-xl font-black transition transform active:scale-95 shadow-lg shadow-purple-200 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path></svg>
                    Hoàn Thành Nhập
                </button>
            </div>
        </div>

        <form id="formNhapHang" class="space-y-6">
            
            <div class="animated-border-wrapper shadow-sm">
                <div class="animated-border-inner p-6 relative">
                    <h3 class="text-[12px] font-black text-purple-700 uppercase tracking-widest mb-5 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        Thông Tin Phiếu Nhập
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Nhà Cung Cấp <span class="text-red-500">*</span></label>
                            <select id="f_ncc" class="w-full" style="width: 100%">
                                <option value="">-- Chọn Nhà Cung Cấp --</option>
                                {{ range .DanhSachNCC }}
                                    <option value="{{ .MaNhaCungCap }}">{{ .TenNhaCungCap }} ({{ .DienThoai }})</option>
                                {{ end }}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Kho Nhập <span class="text-red-500">*</span></label>
                            <select id="f_kho" class="input-premium font-bold cursor-pointer bg-slate-50">
                                <option value="KHO_CHINH">Kho Chính (Hải Dương)</option>
                                <option value="KHO_PHU">Kho Phụ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Ngày Nhập <span class="text-red-500">*</span></label>
                            <input type="datetime-local" id="f_ngay_nhap" class="input-premium text-slate-700 font-bold" value="">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Số Hóa Đơn / Tham Chiếu</label>
                            <input type="text" id="f_so_hoa_don" class="input-premium font-mono" placeholder="VD: HD-001928...">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Ghi chú phiếu</label>
                            <input type="text" id="f_ghi_chu_phieu" class="input-premium" placeholder="Ghi chú tổng thể...">
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h3 class="text-[12px] font-black text-slate-700 uppercase tracking-widest flex items-center gap-2">
                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                        Danh sách Sản Phẩm
                    </h3>
                    <div class="w-full sm:w-96 relative">
                        <select id="select_product_search" class="w-full" style="width: 100%">
                            <option value="">+ Quét Barcode hoặc Gõ tên SP để thêm...</option>
                            {{ range .DanhSachSP }}
                                <option value="{{ .MaSKU }}" data-name="{{ .TenSanPham }}" data-unit="{{ .DonVi }}">{{ .MaSKU }} - {{ .TenSanPham }}</option>
                            {{ end }}
                        </select>
                    </div>
                </div>

                <div class="table-scroll w-full">
                    <table class="w-full text-sm text-left" id="tableChiTiet">
                        <thead class="text-[11px] text-slate-500 uppercase bg-white border-b border-slate-200">
                            <tr>
                                <th class="px-4 py-3 font-bold w-10 text-center">STT</th>
                                <th class="px-4 py-3 font-bold w-32">Mã SKU</th>
                                <th class="px-4 py-3 font-bold min-w-[200px]">Tên Sản Phẩm</th>
                                <th class="px-4 py-3 font-bold text-center w-20">ĐVT</th>
                                <th class="px-4 py-3 font-bold text-right w-24">SL <span class="text-red-500">*</span></th>
                                <th class="px-4 py-3 font-bold text-right w-36">Đơn Giá <span class="text-red-500">*</span></th>
                                <th class="px-4 py-3 font-bold text-right w-32">Thành Tiền</th>
                                <th class="px-4 py-3 font-bold text-center w-16"></th>
                            </tr>
                        </thead>
                        <tbody id="tbodyChiTiet" class="divide-y divide-slate-100">
                            <tr id="rowEmpty" class="bg-slate-50/50">
                                <td colspan="8" class="px-4 py-8 text-center text-slate-400 font-medium">
                                    Chưa có sản phẩm nào. Hãy tìm kiếm và thêm vào phiếu!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="p-3 bg-purple-50/50 border-t border-slate-100 text-right">
                    <span class="text-xs font-bold text-slate-500 uppercase mr-3">Tổng số lượng:</span>
                    <span id="lblTotalQty" class="text-lg font-black text-purple-700">0</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-[12px] font-black text-slate-700 uppercase tracking-widest mb-5 border-b border-slate-100 pb-3">Chi tiết thanh toán</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-bold text-slate-500">Tiền hàng</label>
                            <span id="lblTienHang" class="text-base font-black text-slate-800 font-mono">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-bold text-slate-500">Giảm giá phiếu</label>
                            <input type="text" id="f_giam_gia" class="input-premium text-right font-mono w-40 text-rose-600 font-bold" value="0" oninput="formatCurrencyInput(this); calculateTotal()">
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                            <label class="text-sm font-black text-slate-800 uppercase tracking-wide">Cần thanh toán</label>
                            <span id="lblThanhToan" class="text-xl font-black text-purple-600 font-mono">0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 border-t-4 border-t-purple-500">
                    <h3 class="text-[12px] font-black text-slate-700 uppercase tracking-widest mb-5 border-b border-slate-100 pb-3">Thanh toán cho NCC</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-bold text-slate-500">Phương thức</label>
                            <select id="f_phuong_thuc" class="input-premium w-40 font-bold bg-slate-50 text-right">
                                <option value="CHUYEN_KHOAN">Chuyển khoản</option>
                                <option value="TIEN_MAT">Tiền mặt</option>
                                <option value="CONG_NO">Ghi nợ</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-bold text-slate-500">Đã trả NCC</label>
                            <input type="text" id="f_da_tra" class="input-premium text-right font-mono w-40 text-emerald-600 font-bold" value="0" oninput="formatCurrencyInput(this); calculateTotal()">
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                            <label class="text-sm font-black text-slate-800 uppercase tracking-wide">Công nợ phiếu</label>
                            <span id="lblConNo" class="text-lg font-black text-rose-500 font-mono">0</span>
                        </div>
                    </div>
                </div>

            </div>
        </form>
    </div>

    <script>
        // Khởi tạo Select2 và ngày giờ mặc định
        $(document).ready(function() {
            $('#f_ncc').select2({ placeholder: "Tìm kiếm Nhà cung cấp...", allowClear: true });
            
            let dateNow = new Date();
            let localStr = new Date(dateNow.getTime() - (dateNow.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('f_ngay_nhap').value = localStr;

            $('#select_product_search').select2({ placeholder: "Quét Barcode hoặc tìm SP..." });
            
            // Bắt sự kiện chọn Sản phẩm
            $('#select_product_search').on('select2:select', function (e) {
                var data = e.params.data;
                if(data.id) {
                    var el = $(data.element);
                    addProductRow(data.id, el.data('name'), el.data('unit'));
                    $(this).val(null).trigger('change'); // Reset thanh tìm kiếm
                }
            });
        });

        let rowCount = 0;

        // Định dạng số tiền (Có dấu phẩy)
        function formatNumber(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
        function parseNumber(s) { return parseInt(s.toString().replace(/,/g, '')) || 0; }

        function formatCurrencyInput(input) {
            let val = parseNumber(input.value);
            input.value = formatNumber(val);
        }

        // Thêm dòng SP vào bảng
        function addProductRow(sku, name, unit) {
            document.getElementById('rowEmpty').style.display = 'none';
            rowCount++;
            
            let tbody = document.getElementById('tbodyChiTiet');
            let tr = document.createElement('tr');
            tr.className = "hover-soft-row border-b border-slate-50 group";
            tr.id = `row_${rowCount}`;
            
            tr.innerHTML = `
                <td class="px-4 py-2 text-center text-slate-400 font-medium stt-cell">${rowCount}</td>
                <td class="px-4 py-2 font-mono text-xs font-bold text-purple-700">${sku}</td>
                <td class="px-4 py-2 font-bold text-slate-800"><input type="hidden" class="row-sku" value="${sku}"><div class="truncate max-w-[200px]" title="${name}">${name}</div></td>
                <td class="px-4 py-2 text-center"><span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">${unit}</span></td>
                <td class="px-4 py-2"><input type="text" class="cell-input row-qty" value="1" oninput="formatCurrencyInput(this); calculateRow(${rowCount})"></td>
                <td class="px-4 py-2"><input type="text" class="cell-input row-price text-blue-600" value="0" oninput="formatCurrencyInput(this); calculateRow(${rowCount})"></td>
                <td class="px-4 py-2 text-right font-mono font-black text-slate-800 row-total">0</td>
                <td class="px-4 py-2 text-center">
                    <button type="button" onclick="removeRow(${rowCount})" class="text-slate-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100">
                        <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
            updateSTT();
            calculateTotal();
        }

        function removeRow(id) {
            document.getElementById(`row_${id}`).remove();
            updateSTT();
            calculateTotal();
            if(document.querySelectorAll('#tbodyChiTiet tr.hover-soft-row').length === 0) {
                document.getElementById('rowEmpty').style.display = 'table-row';
            }
        }

        function updateSTT() {
            let cells = document.querySelectorAll('.stt-cell');
            cells.forEach((cell, index) => { cell.innerText = index + 1; });
        }

        // Tính tiền 1 dòng
        function calculateRow(id) {
            let row = document.getElementById(`row_${id}`);
            let qty = parseNumber(row.querySelector('.row-qty').value);
            let price = parseNumber(row.querySelector('.row-price').value);
            let total = qty * price;
            row.querySelector('.row-total').innerText = formatNumber(total);
            calculateTotal();
        }

        // Tính tổng phiếu
        function calculateTotal() {
            let sumQty = 0; let sumTienHang = 0;
            
            document.querySelectorAll('#tbodyChiTiet tr.hover-soft-row').forEach(row => {
                sumQty += parseNumber(row.querySelector('.row-qty').value);
                sumTienHang += parseNumber(row.querySelector('.row-total').innerText);
            });

            document.getElementById('lblTotalQty').innerText = formatNumber(sumQty);
            document.getElementById('lblTienHang').innerText = formatNumber(sumTienHang);

            let giamGia = parseNumber(document.getElementById('f_giam_gia').value);
            let thanhToan = sumTienHang - giamGia;
            if (thanhToan < 0) thanhToan = 0;
            document.getElementById('lblThanhToan').innerText = formatNumber(thanhToan);

            let daTra = parseNumber(document.getElementById('f_da_tra').value);
            let conNo = thanhToan - daTra;
            document.getElementById('lblConNo').innerText = formatNumber(conNo);
        }

        async function hoanThanhPhieu() {
            // 1. Validate sơ bộ
            let ncc = document.getElementById('f_ncc').value;
            if(!ncc) { Swal.fire('Lỗi', 'Vui lòng chọn Nhà cung cấp!', 'error'); return; }
            
            let rows = document.querySelectorAll('#tbodyChiTiet tr.hover-soft-row');
            if(rows.length === 0) { Swal.fire('Lỗi', 'Phiếu nhập chưa có sản phẩm nào!', 'error'); return; }

            // 2. Gom dữ liệu trên bảng
            let chiTiet = [];
            let errorQty = false;
            rows.forEach(row => {
                let sl = parseNumber(row.querySelector('.row-qty').value);
                if (sl <= 0) errorQty = true;
                chiTiet.push({
                    ma_sku: row.querySelector('.row-sku').value,
                    so_luong: sl,
                    don_gia_nhap: parseNumber(row.querySelector('.row-price').value)
                });
            });

            if (errorQty) { Swal.fire('Lỗi', 'Số lượng nhập phải lớn hơn 0!', 'error'); return; }

            // 3. Đóng gói JSON Payload
            let payload = {
                ma_nha_cung_cap: ncc,
                ma_kho: document.getElementById('f_kho').value,
                ngay_nhap: document.getElementById('f_ngay_nhap').value,
                so_hoa_don: document.getElementById('f_so_hoa_don').value,
                ghi_chu_phieu: document.getElementById('f_ghi_chu_phieu').value,
                giam_gia_phieu: parseNumber(document.getElementById('f_giam_gia').value),
                phuong_thuc_thanh_toan: document.getElementById('f_phuong_thuc').value,
                da_tra: parseNumber(document.getElementById('f_da_tra').value),
                chi_tiet: chiTiet
            };

            // 4. Loading và gửi API
            Swal.fire({
                title: '<div class="flex flex-col items-center gap-4"><div class="spinner-led-btn w-12 h-12 border-4"></div><span class="text-xl font-black title-gradient-purple">Đang mã hóa & đồng bộ...</span></div>',
                customClass: { popup: 'swal-master-success' }, showConfirmButton: false, allowOutsideClick: false
            });

            try {
                const res = await fetch('/master/api/nhap-hang/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                if(data.status === 'ok') {
                    Swal.fire({
                        title: '<div class="flex flex-col items-center gap-3"><div class="w-16 h-16 bg-gradient-to-br from-purple-100 to-indigo-100 text-purple-600 rounded-full flex items-center justify-center shadow-inner border border-purple-200"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><span class="text-3xl font-black title-gradient-purple">Thành Công</span></div>',
                        html: `<div class="text-[15px] text-slate-600 font-medium px-4">Đã tạo Phiếu <b class="text-purple-600">${data.ma_phieu}</b>. Hệ thống đang ngầm ghi Serial vào Google Sheets!</div>`,
                        customClass: { popup: 'swal-master-success' }, showConfirmButton: true, confirmButtonText: 'Nhập phiếu mới', confirmButtonColor: '#9333ea'
                    }).then(() => { location.reload(); });
                } else {
                    Swal.fire('Thất bại', data.msg, 'error');
                }
            } catch(e) {
                Swal.fire('Lỗi kết nối', 'Không thể đẩy dữ liệu lên máy chủ', 'error');
            }
        }
    </script>
    {{ template "footer_master" . }}
{{ end }}
