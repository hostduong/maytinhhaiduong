{{ define "quan_tri_san_pham" }}
    {{ template "header" . }}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />

    <style>
        label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.5rem; display: block; }
        .modal-body { max-height: calc(100vh - 180px); overflow-y: auto; scrollbar-width: thin; padding: 0 2rem 1.5rem 2rem; background-color: #f8fafc; }
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

        .form-section { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.02); }
        .section-title { font-size: 0.875rem; font-weight: 700; color: #0f172a; text-transform: uppercase; border-bottom: 1px solid #f1f5f9; padding-bottom: 0.75rem; margin-bottom: 1.25rem; display: flex; align-items: center; justify-content: space-between; }

        input.input-premium, select.input-premium, textarea.input-premium, .tagify {
            width: 100%; box-sizing: border-box; background-color: #ffffff; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 0.95rem; color: #1e293b; transition: all 0.2s ease; font-weight: 500;
        }
        input.input-premium, select.input-premium { height: 42px; padding: 0 0.75rem; }
        textarea.input-premium { padding: 0.75rem; line-height: 1.5; }
        input.input-premium:focus, select.input-premium:focus, textarea.input-premium:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
        input:disabled, textarea:disabled, select:disabled { background-color: #f1f5f9; cursor: not-allowed; color: #94a3b8; }
        
        .tagify { padding: 0 0.25rem; display: flex; align-items: center; cursor: text; min-height: 42px; }
        .tagify--focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        .price-input { font-weight: 700; text-align: right; font-family: 'Courier New', Courier, monospace; letter-spacing: 0.05em; font-size: 1.05rem; }
        
        .img-input-group { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; animation: fadeIn 0.2s; }
        .btn-remove-img { background: #fff1f2; color: #e11d48; cursor: pointer; border-radius: 0.5rem; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; transition: 0.2s; border: 1px solid #ffe4e6; flex-shrink: 0; }
        .img-preview-mini { width: 42px; height: 42px; border-radius: 0.5rem; object-fit: cover; border: 1px solid #cbd5e1; background: #fff; flex-shrink: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* TABS CSS - Chu·∫©n UI PIM */
        .sku-tab { padding: 0.5rem 1.25rem; font-weight: bold; border-radius: 0.5rem; cursor: pointer; transition: 0.2s; border: 1px solid transparent; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem; user-select: none; }
        .sku-tab:hover { filter: brightness(0.95); }
        .copy-btn { font-size: 0.75rem; padding: 4px 10px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; color: #3b82f6; cursor: pointer; transition: 0.2s; font-weight: bold; text-transform: none; letter-spacing: 0; display: inline-flex; align-items: center; gap: 4px; }
        .copy-btn:hover { background: #3b82f6; color: white; border-color: #3b82f6; }
    </style>

    <div id="data_island" style="display:none;">
        <div id="data_danhmuc">
            {{ range .ListDanhMuc }}{{ if ne .TenDanhMuc "" }}<div class="dm-item" data-ten="{{ urlquery .TenDanhMuc }}" data-prefix="{{ .MaDanhMuc }}" data-nextstt="{{ .Slot }}" data-loinhuan="{{ .LoiNhuan }}"></div>{{ end }}{{ end }}
        </div>
        <div id="data_thuonghieu">{{ range .ListThuongHieu }}{{ if ne .TenThuongHieu "" }}<div class="th-item" data-ten="{{ urlquery .TenThuongHieu }}"></div>{{ end }}{{ end }}</div>
        <div id="data_bln">{{ range .ListBLN }}<div class="bln-item" data-khung="{{ .KhungGiaNhap }}" data-loinhuan="{{ .BienLoiNhuan }}" data-trangthai="{{ .TrangThai }}"></div>{{ end }}</div>
        
        <div id="data_sanpham">
            {{ range .DanhSachFull }}
            <div class="sp-data"
                data-masp="{{ .MaSanPham }}" data-tensp="{{ urlquery .TenSanPham }}" data-tenrutgon="{{ urlquery .TenRutGon }}" data-slug="{{ urlquery .Slug }}"
                data-masku="{{ .MaSKU }}" data-tensku="{{ urlquery .TenSKU }}" data-skuchinh="{{ .SKUChinh }}" data-trangthai="{{ .TrangThai }}"
                data-danhmuc="{{ urlquery .MaDanhMuc }}" data-thuonghieu="{{ urlquery .MaThuongHieu }}" data-donvi="{{ urlquery .DonVi }}" data-mausac="{{ urlquery .MauSac }}"
                data-khoiluong="{{ .KhoiLuong }}" data-kichthuoc="{{ urlquery .KichThuoc }}" data-img="{{ .UrlHinhAnh }}" data-baohanh="{{ urlquery .BaoHanh }}"
                data-tinhtrang="{{ urlquery .TinhTrang }}" data-gianhap="{{ printf "%.0f" .GiaNhap }}" data-gianiemuyet="{{ printf "%.0f" .GiaNiemYet }}"
                data-ptgiam="{{ printf "%.0f" .PhanTramGiam }}" data-tiengiam="{{ printf "%.0f" .SoTienGiam }}" data-giaban="{{ printf "%.0f" .GiaBan }}"
                data-ghichu="{{ urlquery .GhiChu }}">
                <textarea class="t-thongso">{{ .ThongSoHTML }}</textarea>
                <textarea class="t-mota">{{ .MoTaHTML }}</textarea>
            </div>
            {{ end }}
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">üì¶ Qu·∫£n L√Ω S·∫£n Ph·∫©m</h1>
                <p class="text-slate-500 text-sm mt-1">Danh s√°ch s·∫£n ph·∫©m g·ªëc (ƒê·∫°i di·ªán)</p>
            </div>
            <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-bold shadow-md flex items-center gap-2 transition transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                Th√™m S·∫£n Ph·∫©m M·ªõi
            </button>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-4 font-bold">M√£ SP</th>
                            <th class="px-6 py-4 font-bold">·∫¢nh</th>
                            <th class="px-6 py-4 font-bold">T√™n S·∫£n Ph·∫©m (ƒê·∫°i di·ªán)</th>
                            <th class="px-6 py-4 font-bold">Danh M·ª•c</th>
                            <th class="px-6 py-4 text-right font-bold">Gi√° B√°n</th>
                            <th class="px-6 py-4 text-center font-bold">Tr·∫°ng Th√°i</th>
                            <th class="px-6 py-4 text-center font-bold">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {{ range .DanhSach }}
                        <tr class="bg-white hover:bg-slate-50 transition">
                            <td class="px-6 py-4 font-semibold text-slate-700 whitespace-nowrap">{{ .MaSanPham }}</td>
                            <td class="px-6 py-4">
                                <div class="w-12 h-12 rounded border border-slate-200 bg-white p-0.5 flex items-center justify-center overflow-hidden">
                                    <img src="{{ if .UrlHinhAnh }}{{ .UrlHinhAnh }}{{ else }}data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%3E%3Crect%20width%3D%2240%22%20height%3D%2240%22%20fill%3D%22%23f1f5f9%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-family%3D%22sans-serif%22%20font-weight%3D%22bold%22%20font-size%3D%2210%22%20fill%3D%22%2394a3b8%22%20text-anchor%3D%22middle%22%20dominant-baseline%3D%22middle%22%3ENo%20Img%3C%2Ftext%3E%3C%2Fsvg%3E{{ end }}" 
                                         class="preview-img-table max-w-full max-h-full object-cover rounded-sm"
                                         onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%3E%3Crect%20width%3D%2240%22%20height%3D%2240%22%20fill%3D%22%23f1f5f9%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-family%3D%22sans-serif%22%20font-weight%3D%22bold%22%20font-size%3D%2210%22%20fill%3D%22%2394a3b8%22%20text-anchor%3D%22middle%22%20dominant-baseline%3D%22middle%22%3ENo%20Img%3C%2Ftext%3E%3C%2Fsvg%3E'">
                                </div>
                            </td>
                            <td class="px-6 py-4 font-medium text-slate-900 min-w-[200px]">
                                {{ .TenSanPham }}<br>
                                {{ if .TenSKU }}<span class="text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-100 mt-1 inline-block">ƒê·∫°i di·ªán: {{ .TenSKU }}</span>{{ end }}
                            </td>
                            <td class="px-6 py-4">
                                {{ if .MaDanhMuc }}<div class="flex flex-wrap gap-1 w-48"><span class="dm-tags bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded border border-slate-200" data-tags="{{ .MaDanhMuc }}"></span></div>{{ end }}
                            </td>
                            <td class="px-6 py-4 text-right whitespace-nowrap">
                                {{ if gt .PhanTramGiam 0.0 }}
                                    <div class="font-bold text-red-600">{{ format_money .GiaBan }} ‚Ç´</div>
                                    <div class="text-xs text-slate-400 line-through">{{ format_money .GiaNiemYet }} ‚Ç´</div>
                                {{ else }}
                                    <div class="font-bold text-slate-700">{{ format_money .GiaNiemYet }} ‚Ç´</div>
                                {{ end }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                {{ if eq .TrangThai 1 }}<span class="inline-flex items-center bg-emerald-100 text-emerald-700 text-xs font-bold px-2.5 py-0.5 rounded-full">B√°n</span>
                                {{ else }}<span class="inline-flex items-center bg-slate-100 text-slate-600 text-xs font-bold px-2.5 py-0.5 rounded-full">T·∫Øt</span>{{ end }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="editSP('{{ .MaSanPham }}')" class="flex items-center justify-center gap-1 bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 border border-blue-200 px-3 py-1.5 rounded-lg font-bold transition w-full max-w-[80px] mx-auto text-xs uppercase tracking-wide">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                    S·ª≠a
                                </button>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalSP" class="hidden fixed inset-0 bg-slate-900/70 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl transform transition-all flex flex-col max-h-[96vh]">
            
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-white rounded-t-xl shrink-0">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2" id="modalTitle">Th√™m S·∫£n Ph·∫©m M·ªõi</h3>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-500 transition">‚úï</button>
            </div>

            <div class="px-6 py-3 bg-white border-b border-slate-200 overflow-x-auto whitespace-nowrap flex gap-2 items-center shrink-0" id="tabs_container">
                </div>
            
            <div class="modal-body pt-5">
                <div id="warning_deleted" class="hidden bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg mb-4 font-bold flex justify-between items-center shadow-sm">
                    <span class="flex items-center gap-2">‚ö†Ô∏è Phi√™n b·∫£n n√†y ƒëang ƒë∆∞·ª£c ƒë√°nh d·∫•u CH·ªú X√ìA.</span>
                    <button type="button" onclick="restoreTab()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-lg text-sm transition shadow-sm">Kh√¥i ph·ª•c</button>
                </div>

                <fieldset id="form_fieldset">
                    <form id="formSP">
                        <div class="form-section border-l-4 border-l-purple-500 bg-purple-50/30">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-5 items-end">
                                <div>
                                    <label>T√™n Phi√™n B·∫£n (Hi·ªÉn th·ªã) <span class="text-red-500">*</span></label>
                                    <input type="text" id="f_ten_sku" class="input-premium font-bold text-purple-800" placeholder="VD: B·∫£n 256GB - M√†u Tr·∫Øng" required onkeyup="updateTabName()">
                                </div>
                                <div>
                                    <label>M√£ SKU (N·ªôi b·ªô/M√£ V·∫°ch)</label>
                                    <input type="text" id="f_ma_sku" class="input-premium font-mono" placeholder="ƒê·ªÉ tr·ªëng t·ª± sinh (VD: SP001-01)">
                                </div>
                                <div class="flex items-center pb-2">
                                    <label class="flex items-center cursor-pointer select-none mb-0">
                                        <input type="radio" name="r_sku_chinh" id="f_sku_chinh" class="w-5 h-5 text-purple-600 focus:ring-purple-500 cursor-pointer" onchange="setMainSKU()">
                                        <span class="ml-2 text-sm font-bold text-slate-800">üëë L√†m B·∫£n ƒê·∫°i Di·ªán (Web)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title">
                                <span>üìù Th√¥ng tin chung</span>
                                <button type="button" onclick="syncFromMain('ten_san_pham', 'ten_rut_gon', 'tinh_trang')" class="copy-btn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg> 
                                    ƒê·ªìng b·ªô t·ª´ B·∫£n ƒê·∫°i Di·ªán
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                                    <div class="md:col-span-1">
                                        <label>M√£ G·ªëc (SP)</label>
                                        <input type="text" id="f_ma_san_pham" class="input-premium bg-slate-100 text-blue-700 cursor-not-allowed font-mono font-bold border-dashed" disabled placeholder="T·ª± ƒë·ªông...">
                                    </div>
                                    <div class="md:col-span-3">
                                        <label>T√™n s·∫£n ph·∫©m g·ªëc <span class="text-red-500">*</span></label>
                                        <input type="text" id="f_ten_san_pham" class="input-premium text-lg font-bold" required placeholder="V√≠ d·ª•: iPhone 15 Pro Max...">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div><label>T√™n hi·ªÉn th·ªã r√∫t g·ªçn</label><input type="text" id="f_ten_rut_gon" class="input-premium" placeholder="Hi·ªÉn th·ªã tr√™n h√≥a ƒë∆°n..."></div>
                                    <div><label>T√¨nh tr·∫°ng</label><input id="f_tinh_trang" class="input-premium" placeholder="M·ªõi 100%..."></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="section-title">
                                <span>üè∑Ô∏è Ph√¢n lo·∫°i & Thu·ªôc t√≠nh</span>
                                <button type="button" onclick="syncFromMain('ma_danh_muc', 'ma_thuong_hieu', 'don_vi', 'mau_sac', 'khoi_luong', 'kich_thuoc', 'bao_hanh')" class="copy-btn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg> 
                                    ƒê·ªìng b·ªô t·ª´ B·∫£n ƒê·∫°i Di·ªán
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                                <div><label>Danh M·ª•c <span class="text-red-500">*</span></label><input id="f_ma_danh_muc" class="input-premium" placeholder="Click ƒë·ªÉ ch·ªçn danh m·ª•c..."></div>
                                <div><label>Th∆∞∆°ng hi·ªáu</label><input id="f_ma_thuong_hieu" class="input-premium" placeholder="Ch·ªçn th∆∞∆°ng hi·ªáu..."></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div><label>ƒê∆°n v·ªã</label><input id="f_don_vi" class="input-premium" placeholder="C√°i..."></div>
                                <div><label>M√†u s·∫Øc</label><input id="f_mau_sac" class="input-premium" placeholder="ƒêen..."></div>
                                <div><label>Kh·ªëi l∆∞·ª£ng (Gram)</label><input type="number" id="f_khoi_luong" class="input-premium text-center" placeholder="500"></div>
                                <div><label>K√≠ch th∆∞·ªõc (DxRxC)</label><input type="text" id="f_kich_thuoc" class="input-premium text-center" placeholder="10x20x5"></div>
                                <div>
                                    <label>B·∫£o h√†nh</label>
                                    <div class="flex gap-1 items-stretch">
                                        <input type="number" id="f_bao_hanh_num" class="input-premium text-center px-1" style="width: 40%" placeholder="12">
                                        <select id="f_bao_hanh_unit" class="input-premium cursor-pointer px-1" style="width: 60%"><option value="Th√°ng">Th√°ng</option><option value="NƒÉm">NƒÉm</option></select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section border-l-4 border-l-blue-500 bg-slate-50/50">
                            <div class="section-title flex justify-between">
                                <span>üí∞ ƒê·ªãnh gi√° Kinh Doanh</span>
                                <button type="button" onclick="syncFromMain('gia_nhap', 'gia_niem_yet', 'phan_tram_giam', 'so_tien_giam', 'gia_ban')" class="copy-btn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg> 
                                    ƒê·ªìng b·ªô t·ª´ B·∫£n ƒê·∫°i Di·ªán
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-5">
                                <div>
                                    <label>Gi√° V·ªën (Nh·∫≠p) <span class="text-red-500">*</span></label>
                                    <input type="text" id="f_gia_nhap" required class="input-premium price-input text-slate-700 bg-white" placeholder="0" onkeyup="formatCurrency(this); renderSmartProfitOptions(); applySmartProfit();">
                                </div>
                                
                                <div class="md:col-span-1">
                                    <label>Quy t·∫Øc t√≠nh l√£i & Bi√™n ƒë·ªô %</label>
                                    <input id="f_smart_profit" class="input-premium bg-white cursor-text font-bold text-blue-700" placeholder="Ch·ªçn ho·∫∑c t·ª± g√µ %...">
                                    <input type="hidden" id="f_loi_nhuan" value="0">
                                </div>

                                <div>
                                    <label>L√£i VNƒê (Tr∆∞·ªõc Thu·∫ø)</label>
                                    <input type="text" id="f_lai_vnd" readonly class="input-premium price-input text-slate-500 cursor-not-allowed bg-slate-100 border-dashed" placeholder="0">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                                <div>
                                    <label>Gi√° Ni√™m Y·∫øt</label>
                                    <input type="text" id="f_gia_niem_yet" required class="input-premium price-input" placeholder="0" onkeyup="formatCurrency(this); autoCalcBackward()">
                                </div>
                                <div>
                                    <label>Gi·∫£m gi√° (%)</label>
                                    <input type="number" id="f_phan_tram_giam" class="input-premium text-center font-bold text-orange-600 bg-white" placeholder="0" onkeyup="applySmartProfit()">
                                </div>
                                <div>
                                    <label>Ho·∫∑c Gi·∫£m (VNƒê)</label>
                                    <input type="text" id="f_so_tien_giam" class="input-premium price-input text-orange-600 bg-white" placeholder="0" onkeyup="formatCurrency(this); applyDiscountMoney()">
                                </div>
                                <div>
                                    <label class="text-emerald-700">B√°n Th·ª±c T·∫ø</label>
                                    <input type="text" id="f_gia_ban" readonly class="input-premium price-input border-transparent ring-2 ring-emerald-500 bg-emerald-50 text-emerald-700 font-bold" placeholder="0">
                                </div>
                            </div>

                            <div class="mt-5 pt-5 border-t border-slate-200 flex items-center justify-between">
                                <label class="flex items-center cursor-pointer select-none mb-0">
                                    <input type="checkbox" id="f_trang_thai" class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer" onchange="updateTabColor()">
                                    <span class="ml-3 text-sm font-bold text-slate-800">‚úÖ ƒê∆∞·ª£c ph√©p kinh doanh (Hi·ªÉn th·ªã tr√™n Web)</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-section mb-0">
                            <div class="section-title">
                                <span>üñºÔ∏è H√¨nh ·∫£nh & B√†i vi·∫øt m√¥ t·∫£</span>
                                <button type="button" onclick="syncFromMain('url_hinh_anh', 'thong_so_html', 'mo_ta_html', 'ghi_chu')" class="copy-btn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg> 
                                    ƒê·ªìng b·ªô t·ª´ B·∫£n ƒê·∫°i Di·ªán
                                </button>
                            </div>
                            
                            <div class="mb-5">
                                <div class="flex justify-between items-center mb-2">
                                    <label style="margin-bottom:0">Danh s√°ch Link ·∫£nh</label>
                                    <button type="button" onclick="addImgInput('')" class="text-xs bg-slate-100 text-blue-600 px-3 py-1.5 rounded font-bold hover:bg-slate-200 transition">+ Th√™m ·∫£nh</button>
                                </div>
                                <div id="f_imgContainer" class="space-y-2 border border-slate-200 rounded-lg p-3 bg-slate-50"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div><label>Th√¥ng s·ªë k·ªπ thu·∫≠t</label><textarea id="f_thong_so_html" rows="5" class="input-premium font-mono text-sm"></textarea></div>
                                <div><label>B√†i vi·∫øt m√¥ t·∫£</label><textarea id="f_mo_ta_html" rows="5" class="input-premium"></textarea></div>
                            </div>
                            <div class="mt-4"><label>Ghi ch√∫ n·ªôi b·ªô</label><input type="text" id="f_ghi_chu" class="input-premium bg-yellow-50 text-yellow-800 border-yellow-200"></div>
                        </div>
                    </form>
                </fieldset>
            </div>

            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 rounded-b-xl flex justify-between items-center shrink-0">
                <span class="text-xs text-slate-400 italic">‚ö†Ô∏è D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u chung khi b·∫•m n√∫t "L∆∞u S·∫£n Ph·∫©m"</span>
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal()" class="px-6 py-2.5 text-slate-600 font-bold hover:bg-slate-200 rounded-lg transition border border-slate-300">H·ªßy B·ªè</button>
                    <button type="button" id="btnSave" onclick="confirmSave()" class="px-8 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md transition transform active:scale-95 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> L∆∞u S·∫£n Ph·∫©m
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function decodeGo(str) { if (!str) return ""; return decodeURIComponent(str.replace(/\+/g, '%20')); }
        
        // --- N·∫†P D·ªÆ LI·ªÜU T·ª™ BACKEND ---
        const mapGroupSP = {}; // Gom nh√≥m SKU theo M√£ S·∫£n Ph·∫©m g·ªëc
        document.querySelectorAll('#data_sanpham .sp-data').forEach(el => { 
            let id = el.getAttribute('data-masp'); 
            if(id) { 
                if(!mapGroupSP[id]) mapGroupSP[id] = [];
                mapGroupSP[id].push({
                    ma_san_pham: id, ten_san_pham: decodeGo(el.getAttribute('data-tensp')), ten_rut_gon: decodeGo(el.getAttribute('data-tenrutgon')), slug: decodeGo(el.getAttribute('data-slug')),
                    ma_sku: el.getAttribute('data-masku'), ten_sku: decodeGo(el.getAttribute('data-tensku')), sku_chinh: parseInt(el.getAttribute('data-skuchinh')) || 0, trang_thai: parseInt(el.getAttribute('data-trangthai')), // Gi·ªØ nguy√™n -1 0 1
                    ma_danh_muc: decodeGo(el.getAttribute('data-danhmuc')), ma_thuong_hieu: decodeGo(el.getAttribute('data-thuonghieu')), don_vi: decodeGo(el.getAttribute('data-donvi')), mau_sac: decodeGo(el.getAttribute('data-mausac')),
                    khoi_luong: parseFloat(el.getAttribute('data-khoiluong')) || 0, kich_thuoc: decodeGo(el.getAttribute('data-kichthuoc')), url_hinh_anh: el.getAttribute('data-img'), bao_hanh: decodeGo(el.getAttribute('data-baohanh')),
                    tinh_trang: decodeGo(el.getAttribute('data-tinhtrang')), gia_nhap: parseFloat(el.getAttribute('data-gianhap')) || 0, gia_niem_yet: parseFloat(el.getAttribute('data-gianiemuyet')) || 0, phan_tram_giam: parseFloat(el.getAttribute('data-ptgiam')) || 0,
                    so_tien_giam: parseFloat(el.getAttribute('data-tiengiam')) || 0, gia_ban: parseFloat(el.getAttribute('data-giaban')) || 0, ghi_chu: decodeGo(el.getAttribute('data-ghichu')), thong_so_html: el.querySelector('.t-thongso').value, mo_ta_html: el.querySelector('.t-mota').value
                });
            } 
        });

        var listDM = []; const dicDanhMuc = {}; document.querySelectorAll('#data_danhmuc .dm-item').forEach(el => { let ten = decodeGo(el.getAttribute('data-ten')); if(ten) { listDM.push(ten); dicDanhMuc[ten] = { prefix: el.getAttribute('data-prefix'), nextStt: parseInt(el.getAttribute('data-nextstt')) || 0, loiNhuan: parseFloat(el.getAttribute('data-loinhuan')) || 0 }; } });
        var listTH = []; document.querySelectorAll('#data_thuonghieu .th-item').forEach(el => { let ten = decodeGo(el.getAttribute('data-ten')); if(ten) listTH.push(ten); });
        var listBLN = []; document.querySelectorAll('#data_bln .bln-item').forEach(el => { if (parseInt(el.getAttribute('data-trangthai')) === 1) { listBLN.push({ khung: parseFloat(el.getAttribute('data-khung')) || 0, loiNhuan: parseFloat(el.getAttribute('data-loinhuan')) || 0 }); } }); listBLN.sort((a, b) => a.khung - b.khung);
        document.querySelectorAll('.preview-img-table').forEach(img => { let raw = img.getAttribute('src'); if (raw && raw.includes('drive.google.com')) { img.src = convertDriveLink(raw); } });
        document.querySelectorAll('.dm-tags').forEach(span => { let raw = span.getAttribute('data-tags'); if(raw) span.innerText = raw.split('|').join(', '); });
        document.getElementById('data_island').remove();

        // --- INIT TAGIFY ---
        const tagifySelectConfig = { mode: 'select', enforceWhitelist: true, dropdown: { maxItems: 20, classname: "tags-look", enabled: 0, closeOnSelect: true, highlightFirst: true } };
        var tagifyDM = new Tagify(document.querySelector('#f_ma_danh_muc'), { whitelist: listDM, enforceWhitelist: true, dropdown: { maxItems: 50, classname: "tags-look", enabled: 0, closeOnSelect: false } });
        const tagifyTH = new Tagify(document.querySelector('#f_ma_thuong_hieu'), { ...tagifySelectConfig, whitelist: listTH });
        const tagifyDonVi = new Tagify(document.querySelector('#f_don_vi'), { ...tagifySelectConfig, whitelist: ["C√°i", "B·ªô", "H·ªôp", "Chi·∫øc", "Combo"] });
        const tagifyTinhTrang = new Tagify(document.querySelector('#f_tinh_trang'), { ...tagifySelectConfig, whitelist: ["M·ªõi 100%", "Like New", "C≈©", "Tr∆∞ng b√†y", "Tr·∫£ b·∫£o h√†nh"] });
        const tagifyMauSac = new Tagify(document.querySelector('#f_mau_sac'), { ...tagifySelectConfig, whitelist: ["ƒêen", "Tr·∫Øng", "X√°m", "ƒê·ªè", "B·∫°c", "V√†ng", "H·ªìng"] });
        const tagifyProfit = new Tagify(document.querySelector('#f_smart_profit'), { mode: 'select', enforceWhitelist: false, whitelist: [], dropdown: { maxItems: 10, classname: "tags-look", enabled: 0, closeOnSelect: true } });

        // --- QU·∫¢N L√ù STATE TAB ---
        let currentSkus = [];
        let activeTabIndex = 0;
        let isEditingMode = false;

        function createEmptySKU() {
            return {
                ma_san_pham: "", ten_san_pham: "", ten_rut_gon: "", slug: "", ma_sku: "", ten_sku: "Phi√™n b·∫£n m·ªõi", sku_chinh: 0, trang_thai: 1, ma_danh_muc: "", ma_thuong_hieu: "", don_vi: "C√°i", mau_sac: "",
                khoi_luong: 0, kich_thuoc: "", url_hinh_anh: "", bao_hanh: "", tinh_trang: "M·ªõi 100%", gia_nhap: 0, gia_niem_yet: 0, phan_tram_giam: 0, so_tien_giam: 0, gia_ban: 0, ghi_chu: "", thong_so_html: "", mo_ta_html: ""
            };
        }

        // T·ª∞ ƒê·ªòNG L√äN M√ÄU UI CHO TAB
        function renderTabs() {
            let html = "";
            let aliveCount = currentSkus.filter(s => s.trang_thai !== -1).length;

            currentSkus.forEach((sku, idx) => {
                let isMain = sku.sku_chinh === 1;
                let isDeleted = sku.trang_thai === -1;
                let isOff = sku.trang_thai === 0;
                let isActive = idx === activeTabIndex;
                
                let cls = "sku-tab group relative ";
                if (isActive) cls += "ring-2 ring-offset-1 ring-blue-500 "; // Vi·ªÅn ƒëang ch·ªçn
                
                if (isDeleted) {
                    cls += "bg-red-50 text-red-500 border-red-200 line-through opacity-70 ";
                } else if (isMain) {
                    cls += "bg-blue-100 text-blue-800 border-blue-300 font-extrabold shadow-sm ";
                } else if (isOff) {
                    cls += "bg-slate-100 text-slate-500 border-slate-200 ";
                } else {
                    cls += "bg-emerald-50 text-emerald-700 border-emerald-200 font-semibold ";
                }

                let name = sku.ten_sku ? sku.ten_sku : `Phi√™n b·∫£n ${idx+1}`;
                let crown = isMain ? "üëë " : "";
                
                // Ch·ªâ hi·ªán n√∫t X√≥a n·∫øu tab kh√¥ng b·ªã x√≥a V√Ä (c√≤n √≠t nh·∫•t 2 tab s·ªëng)
                let showX = !isDeleted && aliveCount > 1;

                html += `
                    <div class="${cls}" onclick="switchTab(${idx})">
                        ${crown}${name}
                        ${showX ? `<span onclick="event.stopPropagation(); removeTab(${idx})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 transition shadow-sm">‚úï</span>` : ''}
                    </div>
                `;
            });
            html += `<button onclick="addTab()" class="sku-tab text-blue-600 bg-blue-50 border-blue-200 border-dashed hover:bg-blue-100 font-bold">+ Th√™m phi√™n b·∫£n</button>`;
            document.getElementById('tabs_container').innerHTML = html;
        }

        function switchTab(idx) {
            saveCurrentTabToState();
            activeTabIndex = idx;
            renderTabs();
            loadTabToForm(idx);
        }

        function addTab() {
            saveCurrentTabToState();
            let newSku = createEmptySKU();
            // L·∫•y Tab ƒê·∫°i Di·ªán l√†m m·∫´u k·∫ø th·ª´a
            let mainRef = currentSkus.find(s => s.sku_chinh === 1 && s.trang_thai !== -1);
            if (!mainRef && currentSkus.length > 0) mainRef = currentSkus[0]; // D·ª± ph√≤ng
            
            if(mainRef) {
                newSku.ma_san_pham = mainRef.ma_san_pham; newSku.ten_san_pham = mainRef.ten_san_pham; 
                newSku.ma_danh_muc = mainRef.ma_danh_muc; newSku.ma_thuong_hieu = mainRef.ma_thuong_hieu;
                newSku.don_vi = mainRef.don_vi; newSku.bao_hanh = mainRef.bao_hanh; 
                newSku.thong_so_html = mainRef.thong_so_html; newSku.mo_ta_html = mainRef.mo_ta_html;
            }
            newSku.ten_sku = `Phi√™n b·∫£n ${currentSkus.length + 1}`;
            currentSkus.push(newSku);
            activeTabIndex = currentSkus.length - 1;
            renderTabs();
            loadTabToForm(activeTabIndex);
        }

function removeTab(idx) {
            // Logic: N·∫øu ch∆∞a c√≥ m√£ SKU th·ª±c (t·ª´ DB tr·∫£ v·ªÅ) -> ƒê√¢y l√† tab m·ªõi t·∫°o tr√™n UI, x√≥a m·∫•t lu√¥n
            let isNewTab = !currentSkus[idx].ma_sku; 
            let msg = isNewTab ? "Phi√™n b·∫£n n√†y v·ª´a t·∫°o, s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn kh·ªèi Form." : "Tab n√†y s·∫Ω b·ªã g·∫°ch b·ªè v√† ch·ªù x√≥a th·ª±c s·ª± khi b·∫°n b·∫•m L∆∞u S·∫£n Ph·∫©m.";

            Swal.fire({ title: 'X√≥a phi√™n b·∫£n n√†y?', text: msg, icon: 'warning', showCancelButton: true, confirmButtonText: 'ƒê·ªìng √Ω', confirmButtonColor: '#ef4444' }).then((result) => {
                if(result.isConfirmed) {
                    let wasMain = currentSkus[idx].sku_chinh === 1;

                    if (isNewTab) {
                        // X√≥a bay m√†u kh·ªèi m·∫£ng
                        currentSkus.splice(idx, 1);
                        if(activeTabIndex >= currentSkus.length) activeTabIndex = currentSkus.length - 1;
                        if(activeTabIndex < 0) activeTabIndex = 0; // Ch·ªëng l·ªói m·∫£ng √¢m
                    } else {
                        // ƒê√°nh d·∫•u ch·ªù x√≥a (Soft Delete)
                        currentSkus[idx].trang_thai = -1; 
                    }

                    // Chuy·ªÉn v∆∞∆°ng mi·ªán n·∫øu tab v·ª´a bay m√†u l√† Tab ƒê·∫°i Di·ªán
                    if(wasMain && currentSkus.length > 0) {
                        if(!isNewTab) currentSkus[idx].sku_chinh = 0;
                        let newMain = currentSkus.findIndex(s => s.trang_thai !== -1);
                        if(newMain !== -1) currentSkus[newMain].sku_chinh = 1;
                    }
                    
                    renderTabs(); loadTabToForm(activeTabIndex);
                }
            });
        }

        // T√çNH NƒÇNG "ƒê·ªíNG B·ªò T·ª™ B·∫¢N ƒê·∫†I DI·ªÜN"
        function syncFromMain(...props) {
            saveCurrentTabToState(); // Ch·ªët s·ªï d·ªØ li·ªáu v·ª´a g√µ v√†o RAM t·∫°m
            
            let mainIdx = currentSkus.findIndex(s => s.sku_chinh === 1 && s.trang_thai !== -1);
            if (mainIdx === -1) { Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y B·∫£n ƒê·∫°i Di·ªán!', 'error'); return; }

            let mainSku = currentSkus[mainIdx];

            if (mainIdx === activeTabIndex) {
                // TR∆Ø·ªúNG H·ª¢P 1: ƒêang ƒë·ª©ng ·ªü Tab ƒê·∫°i Di·ªán -> ƒê·∫©y d·ªØ li·ªáu ra cho c√°c Tab ƒë√†n em
                let count = 0;
                currentSkus.forEach((sku, idx) => {
                    if (idx !== mainIdx && sku.trang_thai !== -1) {
                        props.forEach(p => sku[p] = mainSku[p]);
                        count++;
                    }
                });
                if (count > 0) {
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `ƒê√£ √©p d·ªØ li·ªáu sang ${count} phi√™n b·∫£n kh√°c!`, showConfirmButton: false, timer: 1500 });
                } else {
                    Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: `Kh√¥ng c√≥ phi√™n b·∫£n ph·ª• n√†o ƒë·ªÉ copy!`, showConfirmButton: false, timer: 1500 });
                }
            } else {
                // TR∆Ø·ªúNG H·ª¢P 2: ƒêang ƒë·ª©ng ·ªü Tab Ph·ª• -> K√©o d·ªØ li·ªáu t·ª´ Tab ƒê·∫°i Di·ªán v·ªÅ
                props.forEach(p => currentSkus[activeTabIndex][p] = mainSku[p]);
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: `ƒê√£ k√©o d·ªØ li·ªáu t·ª´ B·∫£n ƒê·∫°i Di·ªán!`, showConfirmButton: false, timer: 1500 });
                loadTabToForm(activeTabIndex); // T·∫£i l·∫°i giao di·ªán ƒë·ªÉ hi·ªÉn th·ªã
            }
        }

        function restoreTab() {
            if (activeTabIndex >= 0 && currentSkus[activeTabIndex]) {
                currentSkus[activeTabIndex].trang_thai = 1; // M·∫∑c ƒë·ªãnh b·∫≠t l·∫°i b√°n
                renderTabs(); loadTabToForm(activeTabIndex);
            }
        }

        function setMainSKU() {
            currentSkus.forEach((sku, idx) => { sku.sku_chinh = (idx === activeTabIndex) ? 1 : 0; });
            renderTabs();
        }

        function updateTabName() {
            if (activeTabIndex >= 0) {
                currentSkus[activeTabIndex].ten_sku = document.getElementById('f_ten_sku').value;
                renderTabs();
            }
        }

        function updateTabColor() {
            if (activeTabIndex >= 0 && currentSkus[activeTabIndex].trang_thai !== -1) {
                currentSkus[activeTabIndex].trang_thai = document.getElementById('f_trang_thai').checked ? 1 : 0;
                renderTabs();
            }
        }


        // --- ƒê·ªåC / GHI D·ªÆ LI·ªÜU FORM <-> STATE ---
        function saveCurrentTabToState() {
            if(currentSkus.length === 0 || activeTabIndex < 0) return;
            let sku = currentSkus[activeTabIndex];
            if (sku.trang_thai === -1) return; // Tab ƒë√£ x√≥a th√¨ ko l·∫•y r√°c t·ª´ Form v√†o n·ªØa
            
            sku.ten_sku = document.getElementById('f_ten_sku').value;
            sku.ma_sku = document.getElementById('f_ma_sku').value;
            sku.sku_chinh = document.getElementById('f_sku_chinh').checked ? 1 : 0;
            sku.ten_san_pham = document.getElementById('f_ten_san_pham').value;
            sku.ten_rut_gon = document.getElementById('f_ten_rut_gon').value;
            sku.trang_thai = document.getElementById('f_trang_thai').checked ? 1 : 0;
            
            sku.ma_danh_muc = tagifyDM.value.map(v => v.value).join("|");
            sku.ma_thuong_hieu = tagifyTH.value.map(v => v.value).join("|");
            sku.don_vi = tagifyDonVi.value.map(v => v.value).join("|");
            sku.mau_sac = tagifyMauSac.value.map(v => v.value).join("|");
            sku.tinh_trang = tagifyTinhTrang.value.map(v => v.value).join("|");
            
            sku.khoi_luong = parseFloat(document.getElementById('f_khoi_luong').value) || 0;
            sku.kich_thuoc = document.getElementById('f_kich_thuoc').value;
            
            let bhN = document.getElementById('f_bao_hanh_num').value;
            let bhU = document.getElementById('f_bao_hanh_unit').value;
            sku.bao_hanh = bhN ? `${bhN} ${bhU}` : "";

            sku.gia_nhap = getNum(document.getElementById('f_gia_nhap').value);
            sku.gia_niem_yet = getNum(document.getElementById('f_gia_niem_yet').value);
            sku.phan_tram_giam = getNum(document.getElementById('f_phan_tram_giam').value);
            sku.so_tien_giam = getNum(document.getElementById('f_so_tien_giam').value);
            sku.gia_ban = getNum(document.getElementById('f_gia_ban').value);
            
            const links = []; document.querySelectorAll('#f_imgContainer input').forEach(inp => { if(inp.value.trim()) links.push(convertDriveLink(inp.value.trim())); });
            sku.url_hinh_anh = links.join('|');
            
            sku.thong_so_html = document.getElementById('f_thong_so_html').value;
            sku.mo_ta_html = document.getElementById('f_mo_ta_html').value;
            sku.ghi_chu = document.getElementById('f_ghi_chu').value;
        }

        function loadTabToForm(idx) {
            if(idx < 0 || idx >= currentSkus.length) return;
            isEditingMode = true; 
            let sp = currentSkus[idx];

            // X·ª≠ l√Ω C·∫£nh B√°o "ƒê√£ x√≥a"
            const fieldset = document.getElementById('form_fieldset');
            const warningBox = document.getElementById('warning_deleted');
            if (sp.trang_thai === -1) {
                fieldset.disabled = true; // Kh√≥a s·∫°ch form
                warningBox.classList.remove('hidden');
            } else {
                fieldset.disabled = false;
                warningBox.classList.add('hidden');
            }

            document.getElementById('f_ma_san_pham').value = sp.ma_san_pham;
            document.getElementById('f_ten_sku').value = sp.ten_sku;
            document.getElementById('f_ma_sku').value = sp.ma_sku;
            document.getElementById('f_sku_chinh').checked = (sp.sku_chinh === 1);
            document.getElementById('f_trang_thai').checked = (sp.trang_thai === 1);
            document.getElementById('f_ten_san_pham').value = sp.ten_san_pham;
            document.getElementById('f_ten_rut_gon').value = sp.ten_rut_gon;

            tagifyDM.removeAllTags(); if(sp.ma_danh_muc) tagifyDM.addTags(sp.ma_danh_muc.split("|"));
            tagifyTH.removeAllTags(); if(sp.ma_thuong_hieu) tagifyTH.addTags(sp.ma_thuong_hieu.split("|"));
            tagifyDonVi.removeAllTags(); if(sp.don_vi) tagifyDonVi.addTags(sp.don_vi.split("|"));
            tagifyMauSac.removeAllTags(); if(sp.mau_sac) tagifyMauSac.addTags(sp.mau_sac.split("|"));
            tagifyTinhTrang.removeAllTags(); if(sp.tinh_trang) tagifyTinhTrang.addTags(sp.tinh_trang.split("|"));

            document.getElementById('f_khoi_luong').value = sp.khoi_luong > 0 ? sp.khoi_luong : "";
            document.getElementById('f_kich_thuoc').value = sp.kich_thuoc;
            
            if (sp.bao_hanh) {
                const parts = sp.bao_hanh.split(" ");
                if (parts.length >= 2) { document.getElementById('f_bao_hanh_num').value = parts[0]; document.getElementById('f_bao_hanh_unit').value = parts[1]; } 
                else { document.getElementById('f_bao_hanh_num').value = sp.bao_hanh; }
            } else { document.getElementById('f_bao_hanh_num').value = ""; document.getElementById('f_bao_hanh_unit').value = "Th√°ng"; }

            document.getElementById('f_gia_nhap').value = sp.gia_nhap > 0 ? formatNumber(sp.gia_nhap.toString()) : "";
            document.getElementById('f_gia_niem_yet').value = sp.gia_niem_yet > 0 ? formatNumber(sp.gia_niem_yet.toString()) : "";
            document.getElementById('f_phan_tram_giam').value = sp.phan_tram_giam > 0 ? sp.phan_tram_giam : "";
            document.getElementById('f_so_tien_giam').value = sp.so_tien_giam > 0 ? formatNumber(sp.so_tien_giam.toString()) : "";
            
            renderSmartProfitOptions(); 
            let currentMargin = 0;
            // FIX L·ªñI: Chia cho s·ªë 0
            if(sp.gia_nhap > 0 && sp.gia_ban > 0) {
                currentMargin = ((sp.gia_ban - sp.gia_nhap) / sp.gia_nhap) * 100;
            }
            let matched = false;
            tagifyProfit.settings.whitelist.forEach(item => {
                if (Math.abs(item.margin - currentMargin) < 0.1) {
                    tagifyProfit.removeAllTags(); tagifyProfit.addTags([item]); matched = true;
                }
            });
            if(!matched && sp.gia_nhap > 0) {
                tagifyProfit.removeAllTags();
                tagifyProfit.addTags([{ value: `‚úçÔ∏è T·ª± ch·ªânh (${currentMargin.toFixed(1)}%)`, margin: currentMargin }]);
            }
            calcPrices(currentMargin); 

            document.getElementById('f_thong_so_html').value = sp.thong_so_html;
            document.getElementById('f_mo_ta_html').value = sp.mo_ta_html;
            document.getElementById('f_ghi_chu').value = sp.ghi_chu;

            document.getElementById('f_imgContainer').innerHTML = '';
            if (sp.url_hinh_anh) { sp.url_hinh_anh.split('|').forEach(link => addImgInput(link)); } else { addImgInput(''); }

            setTimeout(() => { isEditingMode = false; }, 300); 
        }

        // --- H√ÄM TI·ªÜN √çCH TI·ªÄN T·ªÜ & T√çNH TO√ÅN ---
        function formatNumber(n) { return n.toString().replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
        function formatCurrency(input) { input.value = formatNumber(input.value); }
        function getNum(val) { if(!val) return 0; return parseFloat(val.toString().replace(/\./g, "")) || 0; }
        function round10k(price) { if (price <= 0) return 0; return Math.floor(price / 10000) * 10000; }
        function convertDriveLink(url) { if (!url) return ""; if (url.includes("drive.google.com") && url.includes("/d/")) { const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/); if (match && match[1]) return "https://lh3.googleusercontent.com/d/" + match[1]; } return url; }

        function renderSmartProfitOptions() {
            let giaNhap = getNum(document.getElementById('f_gia_nhap').value);
            let whitelist = []; let bestOption = null;
            if (giaNhap > 0) {
                const tags = tagifyDM.value;
                if (tags && tags.length > 0) {
                    const info = dicDanhMuc[tags[0].value];
                    if (info && info.loiNhuan > 0) {
                        let opt = { value: `üî∑ Danh M·ª•c (${info.loiNhuan}%)`, margin: info.loiNhuan }; whitelist.push(opt); bestOption = opt; 
                    }
                }
                let priceMargin = 0;
                for (let i = 0; i < listBLN.length; i++) { if (giaNhap <= listBLN[i].khung) { priceMargin = listBLN[i].loiNhuan; break; } }
                if (priceMargin === 0 && listBLN.length > 0) priceMargin = listBLN[listBLN.length - 1].loiNhuan;
                if (priceMargin > 0) {
                    let opt = { value: `üî∂ Khung Gi√° (${priceMargin}%)`, margin: priceMargin }; whitelist.push(opt); if (!bestOption) bestOption = opt; 
                }
            }
            tagifyProfit.settings.whitelist = whitelist;
            if (!isEditingMode) {
                isEditingMode = true; tagifyProfit.removeAllTags(); if (bestOption) tagifyProfit.addTags([bestOption]); isEditingMode = false;
            }
        }

        tagifyDM.on('add', function(e) { if(isEditingMode) return; renderSmartProfitOptions(); applySmartProfit(); });
        tagifyDM.on('remove', function(e) { if(isEditingMode) return; renderSmartProfitOptions(); });
        tagifyProfit.on('change', function(e) { if(!isEditingMode) applySmartProfit(); });

        function applySmartProfit() {
            let val = tagifyProfit.value; let finalMargin = 0;
            if (val && val.length > 0) {
                let selected = val[0];
                if (selected.margin !== undefined) { finalMargin = parseFloat(selected.margin); } 
                else {
                    let match = selected.value.match(/[\d.]+/); 
                    if (match && match[0]) {
                        finalMargin = parseFloat(match[0]) || 0;
                        setTimeout(() => { isEditingMode = true; tagifyProfit.removeAllTags(); tagifyProfit.addTags([{ value: `‚úçÔ∏è T·ª± ch·ªânh (${finalMargin}%)`, margin: finalMargin }]); isEditingMode = false; }, 10);
                    }
                }
            }
            document.getElementById('f_loi_nhuan').value = finalMargin;
            calcPrices(finalMargin);
        }

        function calcPrices(loiNhuan) {
            loiNhuan = parseFloat(loiNhuan) || 0;
            let giaNhap = getNum(document.getElementById('f_gia_nhap').value);
            let giamGia = getNum(document.getElementById('f_phan_tram_giam').value) || 0;
            
            if (giaNhap > 0) {
                let laiVND = giaNhap * (loiNhuan / 100);
                document.getElementById('f_lai_vnd').value = formatNumber(Math.round(laiVND).toString());
                let pList = round10k(giaNhap + laiVND);
                document.getElementById('f_gia_niem_yet').value = formatNumber(pList.toString());

                let tienGiam = Math.round(pList * (giamGia / 100));
                document.getElementById('f_so_tien_giam').value = formatNumber(tienGiam.toString());
                
                let giaBanThuc = pList - tienGiam;
                document.getElementById('f_gia_ban').value = formatNumber(giaBanThuc.toString());
            } else {
                document.getElementById('f_lai_vnd').value = "0"; document.getElementById('f_gia_niem_yet').value = "0";
                document.getElementById('f_so_tien_giam').value = "0"; document.getElementById('f_gia_ban').value = "0";
            }
        }

        function autoCalcBackward() {
            let pList = getNum(document.getElementById('f_gia_niem_yet').value);
            let giaNhap = getNum(document.getElementById('f_gia_nhap').value);
            let giamGia = getNum(document.getElementById('f_phan_tram_giam').value) || 0;
            
            // FIX L·ªñI: Ch·ªâ t√≠nh % khi Gi√° Nh·∫≠p l·ªõn h∆°n 0
            if (giaNhap > 0 && pList > 0) {
                let tienGiam = Math.round(pList * (giamGia / 100));
                document.getElementById('f_so_tien_giam').value = formatNumber(tienGiam.toString());

                let giaBanThuc = pList - tienGiam;
                let laiVND = giaBanThuc - giaNhap;
                let phanTramLai = (laiVND / giaNhap) * 100;
                
                document.getElementById('f_loi_nhuan').value = phanTramLai.toFixed(2);
                document.getElementById('f_lai_vnd').value = formatNumber(Math.round(laiVND).toString());
                document.getElementById('f_gia_ban').value = formatNumber(giaBanThuc.toString());

                isEditingMode = true; tagifyProfit.removeAllTags(); tagifyProfit.addTags([{ value: `‚úçÔ∏è T·ª± ch·ªânh (${phanTramLai.toFixed(1)}%)`, margin: phanTramLai }]); isEditingMode = false;
            } else {
                document.getElementById('f_loi_nhuan').value = "0";
            }
        }

        function applyDiscountMoney() {
            let pList = getNum(document.getElementById('f_gia_niem_yet').value);
            let tienGiam = getNum(document.getElementById('f_so_tien_giam').value);
            if(pList > 0) {
                let phanTram = (tienGiam / pList) * 100;
                document.getElementById('f_phan_tram_giam').value = phanTram.toFixed(1);
                autoCalcBackward(); 
            }
        }

        function addImgInput(value) {
            const container = document.getElementById('f_imgContainer');
            const div = document.createElement('div');
            div.className = 'img-input-group';
            let imgSrc = value ? convertDriveLink(value) : "data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%3E%3Crect%20width%3D%2240%22%20height%3D%2240%22%20fill%3D%22%23f1f5f9%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-family%3D%22sans-serif%22%20font-weight%3D%22bold%22%20font-size%3D%2210%22%20fill%3D%22%2394a3b8%22%20text-anchor%3D%22middle%22%20dominant-baseline%3D%22middle%22%3ENo%20Img%3C%2Ftext%3E%3C%2Fsvg%3E";
            div.innerHTML = `
                <img src="${imgSrc}" class="img-preview-mini" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%3E%3Crect%20width%3D%2240%22%20height%3D%2240%22%20fill%3D%22%23f1f5f9%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-family%3D%22sans-serif%22%20font-weight%3D%22bold%22%20font-size%3D%2210%22%20fill%3D%22%2394a3b8%22%20text-anchor%3D%22middle%22%20dominant-baseline%3D%22middle%22%3ENo%20Img%3C%2Ftext%3E%3C%2Fsvg%3E'">
                <input type="text" class="input-premium font-mono text-sm flex-1" style="height: 42px;" placeholder="Link ·∫£nh (Google Drive OK)..." value="${value}" onchange="this.previousElementSibling.src = convertDriveLink(this.value)"> 
                <span onclick="this.parentElement.remove()" class="btn-remove-img">‚úï</span>
            `;
            container.appendChild(div);
        }

        // --- ƒêI·ªÄU KHI·ªÇN MODAL ---
        function openModal() {
            document.getElementById('formSP').reset();
            let newSku = createEmptySKU(); newSku.sku_chinh = 1; 
            currentSkus = [newSku]; activeTabIndex = 0;
            
            document.getElementById('modalTitle').innerHTML = `Th√™m S·∫£n Ph·∫©m M·ªõi`;
            renderTabs(); loadTabToForm(0);
            document.getElementById('modalSP').classList.remove('hidden');
        }
        
        function closeModal() { document.getElementById('modalSP').classList.add('hidden'); }

        function editSP(id) {
            const list = mapGroupSP[id]; if(!list || list.length === 0) return;
            currentSkus = JSON.parse(JSON.stringify(list)); 
            // ∆Øu ti√™n m·ªü Tab ƒë·∫°i di·ªán ƒë·∫ßu ti√™n
            activeTabIndex = currentSkus.findIndex(s => s.sku_chinh === 1 && s.trang_thai !== -1);
            if(activeTabIndex === -1) activeTabIndex = 0;
            
            document.getElementById('modalTitle').innerHTML = `S·ª≠a S·∫£n Ph·∫©m: <span class="text-blue-600 ml-1 font-mono">${id}</span>`;
            renderTabs(); loadTabToForm(activeTabIndex);
            document.getElementById('modalSP').classList.remove('hidden');
        }
        
        async function confirmSave() {
            const form = document.getElementById('formSP'); if (!form.checkValidity()) { form.reportValidity(); return; }
            saveCurrentTabToState(); 
            
            let hasMain = currentSkus.some(sku => sku.sku_chinh === 1 && sku.trang_thai !== -1);
            if(!hasMain) { Swal.fire('L·ªói', 'B·∫Øt bu·ªôc ph·∫£i ch·ªçn 1 phi√™n b·∫£n l√†m ƒê·∫°i Di·ªán (kh√¥ng b·ªã x√≥a)!', 'error'); return; }

            const result = await Swal.fire({ title: 'L∆∞u to√†n b·ªô phi√™n b·∫£n?', text: `B·∫°n ƒëang thao t√°c v·ªõi ${currentSkus.length} Tab phi√™n b·∫£n cho nh√≥m s·∫£n ph·∫©m n√†y.`, icon: 'question', showCancelButton: true, confirmButtonColor: '#2563eb', cancelButtonColor: '#64748b', confirmButtonText: 'ƒê·ªìng √Ω', cancelButtonText: 'H·ªßy' });
            if (result.isConfirmed) saveSP();
        }

        async function saveSP() {
            const btn = document.getElementById('btnSave'); const originalText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = `ƒêang l∆∞u...`;
            
            const fd = new FormData();
            fd.set('ma_san_pham', currentSkus[0].ma_san_pham || ""); 
            fd.set('data_skus', JSON.stringify(currentSkus)); 
            
            try {
                const res = await fetch('/admin/api/product/save', { method: 'POST', body: fd }); const data = await res.json();
                if(data.status === 'ok') Swal.fire({icon: 'success', title: 'Th√†nh c√¥ng', text: data.msg, showConfirmButton: false, timer: 1500}).then(() => location.reload());
                else { Swal.fire('L·ªói', data.msg, 'error'); btn.disabled = false; btn.innerHTML = originalText; }
            } catch(e) { Swal.fire('L·ªói', 'Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server', 'error'); btn.disabled = false; btn.innerHTML = originalText; }
        }
    </script>
    {{ template "footer" . }}
{{ end }}
